const __vite__fileDeps=["assets/index-CtIFVH72.js","assets/react-core-CLwr57uy.js","assets/semi-ui-BVn_hoCd.js","assets/semi-ui-CMyI3y28.css","assets/tools-BHzke3Ax.js","assets/react-components-DevFevij.js","assets/semantic-DPR2M4xC.js","assets/index-BHj7AKHj.js","assets/visactor-gtn3WK9d.js","assets/index-nf-_YZ2E.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{r as t,a as bt,u as _e,N as St,L as cu,R as pu,e as bu,c as wt,g as vt,f as kt,h as _t,i as Tt,j as Fe,B as It}from"./react-core-CLwr57uy.js";import{S as De,T as Re,e as z,f as mu,g as uu,h as de,B as I,F as se,i as ue,j as Ie,D as Bu,M as je,k as N,l as tu,m as Pe,P as we,L as le,I as Ou,C as Se,n as ru,o as Pt,R as ge,p as ce,q as We,r as Tu,A as zu,s as He,t as Mt,u as $t,v as Rt,w as vu,x as Iu,y as Pu,z as et,E as Ke,G as ut,H as Lt,J as Mu,K as du,N as Wu,O as Ot,Q as tt,U as nt,V as zt,W as Nt,X as Ze,Y as st,Z as at,$ as Ut,a0 as Wt,a1 as Gt,a2 as Ht,a3 as qt,a4 as Kt,a5 as Vt,a6 as Qt,a7 as Jt,a8 as Yt}from"./semi-ui-BVn_hoCd.js";import{c as Xt,a as rt}from"./tools-BHzke3Ax.js";import{Q as Zt,_ as lu,T as it,f as ku,k as en}from"./react-components-DevFevij.js";import{G as Ve,H as Ce,I as Nu,F as W,S as gu,B as eu,M as ou,D as Ae,a as ju,b as lt,L as ot}from"./semantic-DPR2M4xC.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))a(l);new MutationObserver(l=>{for(const r of l)if(r.type==="childList")for(const F of r.addedNodes)F.tagName==="LINK"&&F.rel==="modulepreload"&&a(F)}).observe(document,{childList:!0,subtree:!0});function c(l){const r={};return l.integrity&&(r.integrity=l.integrity),l.referrerPolicy&&(r.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?r.credentials="include":l.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(l){if(l.ep)return;l.ep=!0;const r=c(l);fetch(l.href,r)}})();var ct={exports:{}},Su={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var un=t,tn=Symbol.for("react.element"),nn=Symbol.for("react.fragment"),sn=Object.prototype.hasOwnProperty,an=un.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,rn={key:!0,ref:!0,__self:!0,__source:!0};function dt(u,s,c){var a,l={},r=null,F=null;c!==void 0&&(r=""+c),s.key!==void 0&&(r=""+s.key),s.ref!==void 0&&(F=s.ref);for(a in s)sn.call(s,a)&&!rn.hasOwnProperty(a)&&(l[a]=s[a]);if(u&&u.defaultProps)for(a in s=u.defaultProps,s)l[a]===void 0&&(l[a]=s[a]);return{$$typeof:tn,type:u,key:r,ref:F,props:l,_owner:an.current}}Su.Fragment=nn;Su.jsx=dt;Su.jsxs=dt;ct.exports=Su;var e=ct.exports,$u={},Gu=bt;$u.createRoot=Gu.createRoot,$u.hydrateRoot=Gu.hydrateRoot;const ln="modulepreload",on=function(u){return"/"+u},Hu={},Uu=function(s,c,a){let l=Promise.resolve();if(c&&c.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),F=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));l=Promise.all(c.map(y=>{if(y=on(y),y in Hu)return;Hu[y]=!0;const w=y.endsWith(".css"),h=w?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${y}"]${h}`))return;const o=document.createElement("link");if(o.rel=w?"stylesheet":ln,w||(o.as="script",o.crossOrigin=""),o.href=y,F&&o.setAttribute("nonce",F),document.head.appendChild(o),w)return new Promise((i,x)=>{o.addEventListener("load",i),o.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${y}`)))})}))}return l.then(()=>s()).catch(r=>{const F=new Event("vite:preloadError",{cancelable:!0});if(F.payload=r,window.dispatchEvent(F),!F.defaultPrevented)throw r})},ye=({prompt:u="page"})=>e.jsxs(De,{style:{height:100},spinning:!0,children:["加载",u,"中..."]}),cn=Xt(),pe=10,Du=[{key:1,text:"OpenAI",value:1,color:"green",label:"OpenAI"},{key:2,text:"Midjourney Proxy",value:2,color:"light-blue",label:"Midjourney Proxy"},{key:5,text:"Midjourney Proxy Plus",value:5,color:"blue",label:"Midjourney Proxy Plus"},{key:4,text:"Ollama",value:4,color:"grey",label:"Ollama"},{key:14,text:"Anthropic Claude",value:14,color:"indigo",label:"Anthropic Claude"},{key:33,text:"AWS Claude",value:33,color:"indigo",label:"AWS Claude"},{key:3,text:"Azure OpenAI",value:3,color:"teal",label:"Azure OpenAI"},{key:24,text:"Google Gemini",value:24,color:"orange",label:"Google Gemini"},{key:34,text:"Cohere",value:34,color:"purple",label:"Cohere"},{key:15,text:"百度文心千帆",value:15,color:"blue",label:"百度文心千帆"},{key:17,text:"阿里通义千问",value:17,color:"orange",label:"阿里通义千问"},{key:18,text:"讯飞星火认知",value:18,color:"blue",label:"讯飞星火认知"},{key:16,text:"智谱 ChatGLM",value:16,color:"violet",label:"智谱 ChatGLM"},{key:26,text:"智谱 GLM-4V",value:26,color:"purple",label:"智谱 GLM-4V"},{key:11,text:"Google PaLM2",value:11,color:"orange",label:"Google PaLM2"},{key:25,text:"Moonshot",value:25,color:"green",label:"Moonshot"},{key:19,text:"360 智脑",value:19,color:"blue",label:"360 智脑"},{key:23,text:"腾讯混元",value:23,color:"teal",label:"腾讯混元"},{key:31,text:"零一万物",value:31,color:"green",label:"零一万物"},{key:35,text:"MiniMax",value:35,color:"green",label:"MiniMax"},{key:8,text:"自定义渠道",value:8,color:"pink",label:"自定义渠道"},{key:22,text:"知识库：FastGPT",value:22,color:"blue",label:"知识库：FastGPT"},{key:21,text:"知识库：AI Proxy",value:21,color:"purple",label:"知识库：AI Proxy"}],dn=({htmlContent:u})=>e.jsx("div",{dangerouslySetInnerHTML:{__html:u}});function ke(){let u=localStorage.getItem("user");return u?(u=JSON.parse(u),u.role>=10):!1}function ht(){let u=localStorage.getItem("user");return u?(u=JSON.parse(u),u.role>=100):!1}function wu(){let u=localStorage.getItem("system_name");return u||"New API"}function xu(){let u=localStorage.getItem("logo");return u||"/logo.png"}function hn(){return localStorage.getItem("footer_html")}async function Le(u){let s=!0;try{await navigator.clipboard.writeText(u)}catch(c){s=!1,console.error(c)}return s}function ve(){return window.innerWidth<=600}let Ft={autoClose:!1};ve()&&(Ft.position="top-center");function E(u){if(console.error(u),u.message){if(u.name==="AxiosError"){switch(u.response.status){case 401:window.location.href="/login?expired=true";break;case 429:Re.error("错误：请求次数过多，请稍后再试！");break;case 500:Re.error("错误：服务器内部错误，请联系管理员！");break;case 405:Re.info("本站仅作演示之用，无服务端！");break;default:Re.error("错误："+u.message)}return}Re.error("错误："+u.message)}else Re.error("错误："+u)}function Qe(u){Re.warning(u)}function J(u){Re.success(u)}function be(u){Re.info(u)}function qu(u,s=!1){s?Zt(e.jsx(dn,{htmlContent:u}),Ft):Re.info(u)}function su(u){return u?u.endsWith("/")?u.slice(0,-1):u:""}function Oe(u){let s=new Date(u*1e3),c=s.getFullYear().toString(),a=(s.getMonth()+1).toString(),l=s.getDate().toString(),r=s.getHours().toString(),F=s.getMinutes().toString(),y=s.getSeconds().toString();return a.length===1&&(a="0"+a),l.length===1&&(l="0"+l),r.length===1&&(r="0"+r),F.length===1&&(F="0"+F),y.length===1&&(y="0"+y),c+"-"+a+"-"+l+" "+r+":"+F+":"+y}function Ys(u,s="hour"){let c=new Date(u*1e3),a=(c.getMonth()+1).toString(),l=c.getDate().toString(),r=c.getHours().toString();a.length===1&&(a="0"+a),l.length===1&&(l="0"+l),r.length===1&&(r="0"+r);let F=a+"-"+l;if(s==="hour")F+=" "+r+":00";else if(s==="week"){let y=new Date(u*1e3+5184e5),w=(y.getMonth()+1).toString(),h=y.getDate().toString();w.length===1&&(w="0"+w),h.length===1&&(h="0"+h),F+=" - "+w+"-"+h}return F}function Fn(u,s){let c=new Blob([u],{type:"text/plain;charset=utf-8"}),a=URL.createObjectURL(c),l=document.createElement("a");l.href=a,l.download=s,l.click()}const iu=u=>{try{JSON.parse(u)}catch{return!1}return!0};function pn(u){return!localStorage.getItem(`prompt-${u}`)}function Je(u,s){const c=[];for(const a in u)u.hasOwnProperty(a)&&s.hasOwnProperty(a)&&u[a]!==s[a]&&c.push({key:a,oldValue:u[a],newValue:s[a]});return c}var Ku={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const R=rt.create({baseURL:Ku.VITE_REACT_APP_SERVER_URL?Ku.VITE_REACT_APP_SERVER_URL:""});R.interceptors.response.use(u=>u,u=>{E(u)});function pt(u){if(u==="")return e.jsx(z,{size:"large",children:"unknown"},"default");const s={vip:"yellow",pro:"yellow",svip:"red",premium:"red"},c=u.split(",").sort();return e.jsx("span",{children:c.map(a=>e.jsx(z,{size:"large",color:s[a]||Fu(a),children:a},a))},u)}function Au(u){return u>=1e9?(u/1e9).toFixed(1)+"B":u>=1e6?(u/1e6).toFixed(1)+"M":u>=1e4?(u/1e3).toFixed(1)+"k":u}function Xs(u,s=2){let c=localStorage.getItem("display_in_currency");return u=u.toFixed(s),c?"$"+u:u}function mn(u){if(u=u.toFixed(2),u>=1e5){let s=u.toString(),c=s.indexOf("."),a=s,l="";return c!==-1&&(a=s.slice(0,c),l=s.slice(c)),a.slice(0,2)+".."+a.slice(-2)+l}return u}function yu(){let u=localStorage.getItem("quota_per_unit");return u=parseFloat(u),u}function Zs(u,s=6){let c=localStorage.getItem("quota_per_unit");return c=parseFloat(c),(u/c).toFixed(s)}function me(u,s=2){let c=localStorage.getItem("quota_per_unit"),a=localStorage.getItem("display_in_currency");return c=parseFloat(c),a=a==="true",a?"$"+(u/c).toFixed(s):Au(u)}function gn(u,s,c,a=-1,l,r){if(a!==-1)return"模型价格：$"+a*r;{l===void 0&&(l=0);let F=c*2*r,y=c*2*l*r,w=u/1e6*F+s/1e6*y;return e.jsx(e.Fragment,{children:e.jsxs("article",{children:[e.jsxs("p",{children:["提示 $",F," / 1M tokens"]}),e.jsxs("p",{children:["补全 $",y," / 1M tokens"]}),e.jsx("p",{}),e.jsxs("p",{children:["提示 ",u," tokens / 1M tokens * $",F," + 补全"," ",s," tokens / 1M tokens * $",y," = $",w.toFixed(6)]})]})})}}function hu(u,s){let c=localStorage.getItem("display_in_currency");return c=c==="true",c?`（等价金额：${me(u,s)}）`:""}const Vu=["amber","blue","cyan","green","grey","indigo","light-blue","lime","orange","pink","purple","red","teal","violet","yellow"],ea={"dall-e":"rgb(147,112,219)","dall-e-2":"rgb(147,112,219)","dall-e-3":"rgb(153,50,204)","gpt-3.5-turbo":"rgb(184,227,167)","gpt-3.5-turbo-0301":"rgb(131,220,131)","gpt-3.5-turbo-0613":"rgb(60,179,113)","gpt-3.5-turbo-1106":"rgb(32,178,170)","gpt-3.5-turbo-16k":"rgb(149,252,206)","gpt-3.5-turbo-16k-0613":"rgb(119,255,214)","gpt-3.5-turbo-instruct":"rgb(175,238,238)","gpt-4":"rgb(135,206,235)","gpt-4-0314":"rgb(70,130,180)","gpt-4-0613":"rgb(100,149,237)","gpt-4-1106-preview":"rgb(30,144,255)","gpt-4-0125-preview":"rgb(2,177,236)","gpt-4-turbo-preview":"rgb(2,177,255)","gpt-4-turbo":"rgb(2,190,255)","gpt-4-turbo-2024-04-09":"rgb(2,200,255)","gpt-4-32k":"rgb(104,111,238)","gpt-4-32k-0314":"rgb(90,105,205)","gpt-4-32k-0613":"rgb(61,71,139)","gpt-4-all":"rgb(65,105,225)","gpt-4-gizmo-*":"rgb(0,0,255)","g-*":"rgb(0,0,255)","gpt-4-vision-preview":"rgb(25,25,112)","text-ada-001":"rgb(255,192,203)","text-babbage-001":"rgb(255,160,122)","text-curie-001":"rgb(219,112,147)","text-davinci-002":"rgb(199,21,133)","text-davinci-003":"rgb(219,112,147)","text-davinci-edit-001":"rgb(255,105,180)","text-embedding-ada-002":"rgb(255,182,193)","text-embedding-v1":"rgb(255,174,185)","text-moderation-latest":"rgb(255,130,171)","text-moderation-stable":"rgb(255,160,122)","tts-1":"rgb(255,140,0)","tts-1-1106":"rgb(255,165,0)","tts-1-hd":"rgb(255,215,0)","tts-1-hd-1106":"rgb(255,223,0)","whisper-1":"rgb(245,245,220)","claude-3-opus-20240229":"rgb(255,132,31)","claude-3-sonnet-20240229":"rgb(253,135,93)","claude-3-haiku-20240307":"rgb(255,175,146)","claude-2.1":"rgb(255,209,190)"};function Fu(u){let s=0;for(let a=0;a<u.length;a++)s+=u.charCodeAt(a);let c=s%Vu.length;return Vu[c]}const xn=u=>{const s={username:"",display_name:"",password:""},[c,a]=t.useState(s),[l,r]=t.useState(!1),{username:F,display_name:y,password:w}=c,h=(x,k)=>{a($=>({...$,[x]:k}))},o=async()=>{if(r(!0),c.username===""||c.password==="")return;const x=await R.post("/api/user/",c),{success:k,message:$}=x.data;k?(J("用户账户创建成功！"),a(s),u.refresh(),u.handleClose()):E($),r(!1)},i=()=>{u.handleClose()};return e.jsx(e.Fragment,{children:e.jsx(mu,{placement:"left",title:e.jsx(uu,{level:3,children:"添加用户"}),headerStyle:{borderBottom:"1px solid var(--semi-color-border)"},bodyStyle:{borderBottom:"1px solid var(--semi-color-border)"},visible:u.visible,footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(de,{children:[e.jsx(I,{theme:"solid",size:"large",onClick:o,children:"提交"}),e.jsx(I,{theme:"solid",size:"large",type:"tertiary",onClick:i,children:"取消"})]})}),closeIcon:null,onCancel:()=>i(),width:ve()?"100%":600,children:e.jsxs(De,{spinning:l,children:[e.jsx(se,{style:{marginTop:20},label:"用户名",name:"username",addonBefore:"用户名",placeholder:"请输入用户名",onChange:x=>h("username",x),value:F,autoComplete:"off"}),e.jsx(se,{style:{marginTop:20},addonBefore:"显示名",label:"显示名称",name:"display_name",autoComplete:"off",placeholder:"请输入显示名称",onChange:x=>h("display_name",x),value:y}),e.jsx(se,{style:{marginTop:20},label:"密 码",name:"password",type:"password",addonBefore:"密码",placeholder:"请输入密码",onChange:x=>h("password",x),value:w,autoComplete:"off"})]})})})},Ru=u=>{const s=u.editingUser.id,[c,a]=t.useState(!0),[l,r]=t.useState(!1),[F,y]=t.useState(""),[w,h]=t.useState({username:"",display_name:"",password:"",github_id:"",linuxdo_id:"",linuxdo_level:0,wechat_id:"",telegram_id:"",email:"",quota:0,group:"default"}),[o,i]=t.useState([]),{username:x,display_name:k,password:$,github_id:_,linuxdo_id:L,linuxdo_level:v,wechat_id:H,telegram_id:Q,email:X,quota:K,group:Y}=w,Z=(j,b)=>{h(n=>({...n,[j]:b}))},te=async()=>{try{let j=await R.get("/api/group/");i(j.data.data.map(b=>({label:b,value:b})))}catch(j){E(j.message)}};_e();const G=()=>{u.handleClose()},A=async()=>{a(!0);let j;s?j=await R.get(`/api/user/${s}`):j=await R.get("/api/user/self");const{success:b,message:n,data:d}=j.data;b?(d.password="",h(d)):E(n),a(!1)};t.useEffect(()=>{A().then(),s&&te().then()},[u.editingUser.id]);const f=async()=>{a(!0);let j;if(s){let d={...w,id:parseInt(s)};typeof d.quota=="string"&&(d.quota=parseInt(d.quota)),j=await R.put("/api/user/",d)}else j=await R.put("/api/user/self",w);const{success:b,message:n}=j.data;b?(J("用户信息更新成功！"),u.refresh(),u.handleClose()):E(n),a(!1)},P=()=>{let j=parseInt(K)+parseInt(F);h(b=>({...b,quota:j}))},B=()=>{y("0"),r(!0)};return e.jsxs(e.Fragment,{children:[e.jsx(mu,{placement:"right",title:e.jsx(uu,{level:3,children:"编辑用户"}),headerStyle:{borderBottom:"1px solid var(--semi-color-border)"},bodyStyle:{borderBottom:"1px solid var(--semi-color-border)"},visible:u.visible,footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(de,{children:[e.jsx(I,{theme:"solid",size:"large",onClick:f,children:"提交"}),e.jsx(I,{theme:"solid",size:"large",type:"tertiary",onClick:G,children:"取消"})]})}),closeIcon:null,onCancel:()=>G(),width:ve()?"100%":600,children:e.jsxs(De,{spinning:c,children:[e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:"用户名"})}),e.jsx(se,{label:"用户名",name:"username",placeholder:"请输入新的用户名",onChange:j=>Z("username",j),value:x,autoComplete:"new-password"}),e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:"密码"})}),e.jsx(se,{label:"密码",name:"password",type:"password",placeholder:"请输入新的密码，最短 8 位",onChange:j=>Z("password",j),value:$,autoComplete:"new-password"}),e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:"显示名称"})}),e.jsx(se,{label:"显示名称",name:"display_name",placeholder:"请输入新的显示名称",onChange:j=>Z("display_name",j),value:k,autoComplete:"new-password"}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:"分组"})}),e.jsx(Ie,{placeholder:"请选择分组",name:"group",fluid:!0,search:!0,selection:!0,allowAdditions:!0,additionLabel:"请在系统设置页面编辑分组倍率以添加新的分组：",onChange:j=>Z("group",j),value:w.group,autoComplete:"new-password",optionList:o}),e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:`剩余额度${hu(K)}`})}),e.jsxs(de,{children:[e.jsx(se,{name:"quota",placeholder:"请输入新的剩余额度",onChange:j=>Z("quota",j),value:K,type:"number",autoComplete:"new-password"}),e.jsx(I,{onClick:B,children:"添加额度"})]})]}),e.jsx(Bu,{style:{marginTop:20},children:"以下信息不可修改"}),e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:"已绑定的 GitHub 账户"})}),e.jsx(se,{name:"github_id",value:_,autoComplete:"new-password",placeholder:"此项只读，需要用户通过个人设置页面的相关绑定按钮进行绑定，不可直接修改",readonly:!0}),e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:"已绑定的 LINUX DO 账户"})}),e.jsx(se,{name:"linuxdo_id",value:L+"（"+v+"级）",autoComplete:"new-password",placeholder:"此项只读，需要用户通过个人设置页面的相关绑定按钮进行绑定，不可直接修改",readonly:!0}),e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:"已绑定的微信账户"})}),e.jsx(se,{name:"wechat_id",value:H,autoComplete:"new-password",placeholder:"此项只读，需要用户通过个人设置页面的相关绑定按钮进行绑定，不可直接修改",readonly:!0}),e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:"已绑定的 Telegram 账户"})}),e.jsx(se,{name:"telegram_id",value:Q,autoComplete:"new-password",placeholder:"此项只读，需要用户通过个人设置页面的相关绑定按钮进行绑定，不可直接修改",readonly:!0}),e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:"已绑定的邮箱账户"})}),e.jsx(se,{name:"email",value:X,autoComplete:"new-password",placeholder:"此项只读，需要用户通过个人设置页面的相关绑定按钮进行绑定，不可直接修改",readonly:!0})]})}),e.jsxs(je,{centered:!0,visible:l,onOk:()=>{P(),r(!1)},onCancel:()=>r(!1),closable:null,children:[e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:`新额度${me(K)} + ${me(F)} = ${me(K+parseInt(F))}`})}),e.jsx(se,{name:"addQuotaLocal",placeholder:"需要添加的额度（支持负数）",onChange:j=>{y(j)},value:F,type:"number",autoComplete:"new-password"})]})]})};function En(u){switch(u){case 1:return e.jsx(z,{size:"large",children:"普通用户"});case 10:return e.jsx(z,{color:"yellow",size:"large",children:"管理员"});case 100:return e.jsx(z,{color:"orange",size:"large",children:"超级管理员"});default:return e.jsx(z,{color:"red",size:"large",children:"未知身份"})}}const Cn=()=>{const u=[{title:"ID",dataIndex:"id"},{title:"用户名",dataIndex:"username"},{title:"分组",dataIndex:"group",render:(C,m,M)=>e.jsx("div",{children:pt(C)})},{title:"统计信息",dataIndex:"info",render:(C,m,M)=>e.jsx("div",{children:e.jsxs(de,{spacing:1,children:[e.jsx(Pe,{content:"剩余额度",children:e.jsx(z,{color:"white",size:"large",children:me(m.quota)})}),e.jsx(Pe,{content:"已用额度",children:e.jsx(z,{color:"white",size:"large",children:me(m.used_quota)})}),e.jsx(Pe,{content:"调用次数",children:e.jsx(z,{color:"white",size:"large",children:Au(m.request_count)})})]})})},{title:"邀请信息",dataIndex:"invite",render:(C,m,M)=>e.jsx("div",{children:e.jsxs(de,{spacing:1,children:[e.jsx(Pe,{content:"邀请人数",children:e.jsx(z,{color:"white",size:"large",children:Au(m.aff_count)})}),e.jsx(Pe,{content:"邀请总收益",children:e.jsx(z,{color:"white",size:"large",children:me(m.aff_history_quota)})}),e.jsx(Pe,{content:"邀请人ID",children:m.inviter_id===0?e.jsx(z,{color:"white",size:"large",children:"无"}):e.jsx(z,{color:"white",size:"large",children:m.inviter_id})})]})})},{title:"角色",dataIndex:"role",render:(C,m,M)=>e.jsx("div",{children:En(C)})},{title:"状态",dataIndex:"status",render:(C,m,M)=>e.jsx("div",{children:m.DeletedAt!==null?e.jsx(z,{color:"red",children:"已注销"}):P(C)})},{title:"",dataIndex:"operate",render:(C,m,M)=>e.jsxs("div",{children:[m.DeletedAt!==null?e.jsx(e.Fragment,{}):e.jsxs(e.Fragment,{children:[e.jsx(we,{title:"确定？",okType:"warning",onConfirm:()=>{A(m.username,"promote",m)},children:e.jsx(I,{theme:"light",type:"warning",style:{marginRight:1},children:"提升"})}),e.jsx(we,{title:"确定？",okType:"warning",onConfirm:()=>{A(m.username,"demote",m)},children:e.jsx(I,{theme:"light",type:"secondary",style:{marginRight:1},children:"降级"})}),m.status===1?e.jsx(I,{theme:"light",type:"warning",style:{marginRight:1},onClick:async()=>{A(m.username,"disable",m)},children:"禁用"}):e.jsx(I,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async()=>{A(m.username,"enable",m)},disabled:m.status===3,children:"启用"}),e.jsx(I,{theme:"light",type:"tertiary",style:{marginRight:1},onClick:()=>{Y(m),X(!0)},children:"编辑"})]}),m.DeletedAt!==null?e.jsx(we,{title:"确定是否要删除此用户？",content:"硬删除，此修改将不可逆",okType:"danger",position:"left",onConfirm:()=>{f(m.id).then(()=>{te(m.id)})},children:e.jsx(I,{theme:"light",type:"danger",style:{marginRight:1},children:"永久删除"})}):e.jsx(we,{title:"确定是否要删除此用户？",content:"软删除，数据依然留底",okType:"danger",position:"left",onConfirm:()=>{A(m.username,"delete",m).then(()=>{m.DeletedAt=new Date})},children:e.jsx(I,{theme:"light",type:"danger",style:{marginRight:1},children:"删除"})})]})}],[s,c]=t.useState([]),[a,l]=t.useState(!0),[r,F]=t.useState(1),[y,w]=t.useState(""),[h,o]=t.useState(!1),[i,x]=t.useState(""),[k,$]=t.useState([]),[_,L]=t.useState(pe),[v,H]=t.useState(!1),[Q,X]=t.useState(!1),[K,Y]=t.useState({id:void 0}),Z=C=>{C.length>=r*pe?L(C.length+1):L(C.length)},te=C=>{console.log(C);let m=[...s];if(C!=null){let M=m.findIndex(V=>V.id===C);M>-1&&(m.splice(M,1),c(m))}},G=async C=>{const m=await R.get(`/api/user/?p=${C}`),{success:M,message:V,data:D}=m.data;if(M)if(C===0)c(D),Z(D);else{let U=s;U.push(...D),c(U),Z(U)}else E(V);l(!1)};t.useEffect(()=>{G(0).then().catch(C=>{E(C)}),g().then()},[]);const A=async(C,m,M)=>{const V=await R.post("/api/user/manage",{username:C,action:m}),{success:D,message:U}=V.data;if(D){J("操作成功完成！");let ee=V.data.data,ae=[...s];m==="delete"||(M.status=ee.status,M.role=ee.role),c(ae)}else throw E(U),new Error(U)},f=async C=>{const m=await R.delete("/api/user/"+C),{success:M,message:V}=m.data;if(M)J("操作成功完成！");else throw E(V),new Error(V)},P=C=>{switch(C){case 1:return e.jsx(z,{size:"large",children:"已激活"});case 2:return e.jsx(z,{size:"large",color:"red",children:"已封禁"});default:return e.jsx(z,{size:"large",color:"grey",children:"未知状态"})}},B=async(C,m)=>{if(C===""&&m===""){await G(0),F(1);return}o(!0);const M=await R.get(`/api/user/search?keyword=${C}&group=${m}`),{success:V,message:D,data:U}=M.data;V?(c(U),F(1)):E(D),o(!1)},j=async C=>{w(C.trim())},b=C=>{F(C),C===Math.ceil(s.length/pe)+1&&G(C-1).then(m=>{})},n=s.slice((r-1)*pe,r*pe),d=()=>{H(!1)},p=()=>{X(!1),Y({id:void 0})},S=async()=>{y===""?await G(r-1):await B()},g=async()=>{try{let C=await R.get("/api/group/");if(C===void 0)return;$(C.data.data.map(m=>({label:m,value:m})))}catch(C){E(C.message)}};return e.jsxs(e.Fragment,{children:[e.jsx(xn,{refresh:S,visible:v,handleClose:d}),e.jsx(Ru,{refresh:S,visible:Q,handleClose:p,editingUser:K}),e.jsx(N,{onSubmit:()=>{B(y,i)},labelPosition:"left",children:e.jsx("div",{style:{display:"flex"},children:e.jsxs(de,{children:[e.jsx(N.Input,{label:"搜索关键字",icon:"search",field:"keyword",iconPosition:"left",placeholder:"搜索用户的 ID，用户名，显示名称，以及邮箱地址 ...",value:y,loading:h,onChange:C=>j(C)}),e.jsx(N.Select,{field:"group",label:"分组",optionList:k,onChange:C=>{x(C),B(y,C)}}),e.jsx(I,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",style:{marginRight:8},children:"查询"})]})})}),e.jsx(tu,{columns:u,dataSource:n,pagination:{currentPage:r,pageSize:pe,total:_,pageSizeOpts:[10,20,50,100],onPageChange:b},loading:a}),e.jsx(I,{theme:"light",type:"primary",style:{marginRight:8},onClick:()=>{H(!0)},children:"添加用户"})]})},fn=()=>e.jsx(e.Fragment,{children:e.jsxs(le,{children:[e.jsx(le.Header,{children:e.jsx("h3",{children:"管理用户"})}),e.jsx(le.Content,{children:e.jsx(Cn,{})})]})});function Ue({children:u}){return localStorage.getItem("user")?u:e.jsx(St,{to:"/login",state:{from:cn.location}})}const jn=()=>{const[u,s]=t.useState({username:"",password:"",password2:"",email:"",verification_code:""}),{username:c,password:a,password2:l}=u,[r,F]=t.useState(!1),[y,w]=t.useState(!1),[h,o]=t.useState(""),[i,x]=t.useState(""),[k,$]=t.useState(!1),_=xu();let L=new URLSearchParams(window.location.search).get("aff");L&&localStorage.setItem("aff",L),t.useEffect(()=>{let K=localStorage.getItem("status");K&&(K=JSON.parse(K),F(K.email_verification),K.turnstile_check&&(w(!0),o(K.turnstile_site_key)))});let v=_e();function H(K){const{name:Y,value:Z}=K.target;console.log(Y,Z),s(te=>({...te,[Y]:Z}))}async function Q(K){if(a.length<8){be("密码长度不得小于 8 位！");return}if(a!==l){be("两次输入的密码不一致");return}if(c&&a){if(y&&i===""){be("请稍后几秒重试，Turnstile 正在检查用户环境！");return}$(!0),L||(L=localStorage.getItem("aff")),u.aff_code=L;const Y=await R.post(`/api/user/register?turnstile=${i}`,u),{success:Z,message:te}=Y.data;Z?(localStorage.removeItem("aff"),v("/login"),J("注册成功！")):E(te),$(!1)}}const X=async()=>{if(u.email==="")return;if(y&&i===""){be("请稍后几秒重试，Turnstile 正在检查用户环境！");return}$(!0);const K=await R.get(`/api/verification?email=${u.email}&turnstile=${i}`),{success:Y,message:Z}=K.data;Y?J("验证码发送成功，请检查你的邮箱！"):E(Z),$(!1)};return e.jsx(Ve,{textAlign:"center",style:{marginTop:"48px"},children:e.jsxs(Ve.Column,{style:{maxWidth:450},children:[e.jsxs(Ce,{as:"h2",color:"",textAlign:"center",children:[e.jsx(Nu,{src:_})," 新用户注册"]}),e.jsx(W,{size:"large",children:e.jsxs(gu,{children:[e.jsx(W.Input,{fluid:!0,icon:"user",iconPosition:"left",placeholder:"输入用户名，最长 12 位",onChange:H,name:"username"}),e.jsx(W.Input,{fluid:!0,icon:"lock",iconPosition:"left",placeholder:"输入密码，最短 8 位，最长 20 位",onChange:H,name:"password",type:"password"}),e.jsx(W.Input,{fluid:!0,icon:"lock",iconPosition:"left",placeholder:"输入密码，最短 8 位，最长 20 位",onChange:H,name:"password2",type:"password"}),r?e.jsxs(e.Fragment,{children:[e.jsx(W.Input,{fluid:!0,icon:"mail",iconPosition:"left",placeholder:"输入邮箱地址",onChange:H,name:"email",type:"email",action:e.jsx(eu,{onClick:X,disabled:k,children:"获取验证码"})}),e.jsx(W.Input,{fluid:!0,icon:"lock",iconPosition:"left",placeholder:"输入验证码",onChange:H,name:"verification_code"})]}):e.jsx(e.Fragment,{}),y?e.jsx(lu,{sitekey:h,onVerify:K=>{x(K)}}):e.jsx(e.Fragment,{}),e.jsx(eu,{color:"green",fluid:!0,size:"large",onClick:Q,loading:k,children:"注册"})]})}),e.jsxs(ou,{children:["已有账户？",e.jsx(cu,{to:"/login",className:"btn btn-link",children:"点击登录"})]})]})})},yn=(u,s)=>{switch(s.type){case"login":return{...u,user:s.payload};case"logout":return{...u,user:void 0};default:return u}},mt={user:void 0},Ge=pu.createContext({state:mt,dispatch:()=>null}),Dn=({children:u})=>{const[s,c]=pu.useReducer(yn,mt);return e.jsx(Ge.Provider,{value:[s,c],children:u})};async function gt(){const u=await R.get("/api/oauth/state"),{success:s,message:c,data:a}=u.data;return s?a:(E(c),"")}async function xt(u){const s=await gt();s&&(location.href=`https://github.com/login/oauth/authorize?client_id=${u}&state=${s}&scope=user:email`)}async function Et(u){const s=await gt();s&&(location.href=`https://connect.linux.do/oauth2/authorize?client_id=${u}&response_type=code&state=${s}&scope=user:profile`)}let qe;async function Bn(){const u=await R.get("/api/models"),{success:s,data:c}=u.data;s&&(qe=c,localStorage.setItem("channel_models",JSON.stringify(c)))}function _u(u){if(qe!==void 0&&u in qe)return qe[u]?qe[u]:[];let s=localStorage.getItem("channel_models");return s?(qe=JSON.parse(s),u in qe?qe[u]:[]):[]}const An=u=>{function s(){return e.jsx("svg",{className:"icon",viewBox:"0 0 24 24",version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",...u,children:e.jsx("path",{d:"M19.7,17.6c-0.1-0.2-0.2-0.4-0.2-0.6c0-0.4-0.2-0.7-0.5-1c-0.1-0.1-0.3-0.2-0.4-0.2c0.6-1.8-0.3-3.6-1.3-4.9c0,0,0,0,0,0c-0.8-1.2-2-2.1-1.9-3.7c0-1.9,0.2-5.4-3.3-5.1C8.5,2.3,9.5,6,9.4,7.3c0,1.1-0.5,2.2-1.3,3.1c-0.2,0.2-0.4,0.5-0.5,0.7c-1,1.2-1.5,2.8-1.5,4.3c-0.2,0.2-0.4,0.4-0.5,0.6c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.1-0.3,0.2-0.5,0.3c-0.4,0.1-0.7,0.3-0.9,0.7c-0.1,0.3-0.2,0.7-0.1,1.1c0.1,0.2,0.1,0.4,0,0.7c-0.2,0.4-0.2,0.9,0,1.4c0.3,0.4,0.8,0.5,1.5,0.6c0.5,0,1.1,0.2,1.6,0.4l0,0c0.5,0.3,1.1,0.5,1.7,0.5c0.3,0,0.7-0.1,1-0.2c0.3-0.2,0.5-0.4,0.6-0.7c0.4,0,1-0.2,1.7-0.2c0.6,0,1.2,0.2,2,0.1c0,0.1,0,0.2,0.1,0.3c0.2,0.5,0.7,0.9,1.3,1c0.1,0,0.1,0,0.2,0c0.8-0.1,1.6-0.5,2.1-1.1l0,0c0.4-0.4,0.9-0.7,1.4-0.9c0.6-0.3,1-0.5,1.1-1C20.3,18.6,20.1,18.2,19.7,17.6z M12.8,4.8c0.6,0.1,1.1,0.6,1,1.2c0,0.3-0.1,0.6-0.3,0.9c0,0,0,0-0.1,0c-0.2-0.1-0.3-0.1-0.4-0.2c0.1-0.1,0.1-0.3,0.2-0.5c0-0.4-0.2-0.7-0.4-0.7c-0.3,0-0.5,0.3-0.5,0.7c0,0,0,0.1,0,0.1c-0.1-0.1-0.3-0.1-0.4-0.2c0,0,0-0.1,0-0.1C11.8,5.5,12.2,4.9,12.8,4.8z M12.5,6.8c0.1,0.1,0.3,0.2,0.4,0.2c0.1,0,0.3,0.1,0.4,0.2c0.2,0.1,0.4,0.2,0.4,0.5c0,0.3-0.3,0.6-0.9,0.8c-0.2,0.1-0.3,0.1-0.4,0.2c-0.3,0.2-0.6,0.3-1,0.3c-0.3,0-0.6-0.2-0.8-0.4c-0.1-0.1-0.2-0.2-0.4-0.3C10.1,8.2,9.9,8,9.8,7.7c0-0.1,0.1-0.2,0.2-0.3c0.3-0.2,0.4-0.3,0.5-0.4l0.1-0.1c0.2-0.3,0.6-0.5,1-0.5C11.9,6.5,12.2,6.6,12.5,6.8z M10.4,5c0.4,0,0.7,0.4,0.8,1.1c0,0.1,0,0.1,0,0.2c-0.1,0-0.3,0.1-0.4,0.2c0,0,0-0.1,0-0.2c0-0.3-0.2-0.6-0.4-0.5c-0.2,0-0.3,0.3-0.3,0.6c0,0.2,0.1,0.3,0.2,0.4l0,0c0,0-0.1,0.1-0.2,0.1C9.9,6.7,9.7,6.4,9.7,6.1C9.7,5.5,10,5,10.4,5z M9.4,21.1c-0.7,0.3-1.6,0.2-2.2-0.2c-0.6-0.3-1.1-0.4-1.8-0.4c-0.5-0.1-1-0.1-1.1-0.3c-0.1-0.2-0.1-0.5,0.1-1c0.1-0.3,0.1-0.6,0-0.9c-0.1-0.3-0.1-0.5,0-0.8C4.5,17.2,4.7,17.1,5,17c0.3-0.1,0.5-0.2,0.7-0.4c0.1-0.1,0.2-0.2,0.3-0.4c0.3-0.4,0.5-0.6,0.8-0.6c0.6,0.1,1.1,1,1.5,1.9c0.2,0.3,0.4,0.7,0.7,1c0.4,0.5,0.9,1.2,0.9,1.6C9.9,20.6,9.7,20.9,9.4,21.1z M14.3,18.9c0,0.1,0,0.1-0.1,0.2c-1.2,0.9-2.8,1-4.1,0.3c-0.2-0.3-0.4-0.6-0.6-0.9c0.9-0.1,0.7-1.3-1.2-2.5c-2-1.3-0.6-3.7,0.1-4.8c0.1-0.1,0.1,0-0.3,0.8c-0.3,0.6-0.9,2.1-0.1,3.2c0-0.8,0.2-1.6,0.5-2.4c0.7-1.3,1.2-2.8,1.5-4.3c0.1,0.1,0.1,0.1,0.2,0.1c0.1,0.1,0.2,0.2,0.3,0.2c0.2,0.3,0.6,0.4,0.9,0.4c0,0,0.1,0,0.1,0c0.4,0,0.8-0.1,1.1-0.4c0.1-0.1,0.2-0.2,0.4-0.2c0.3-0.1,0.6-0.3,0.9-0.6c0.4,1.3,0.8,2.5,1.4,3.6c0.4,0.8,0.7,1.6,0.9,2.5c0.3,0,0.7,0.1,1,0.3c0.8,0.4,1.1,0.7,1,1.2c-0.1,0-0.1,0-0.2,0c0-0.3-0.2-0.6-0.9-0.9c-0.7-0.3-1.3-0.3-1.5,0.4c-0.1,0-0.2,0.1-0.3,0.1c-0.8,0.4-0.8,1.5-0.9,2.6C14.5,18.2,14.4,18.5,14.3,18.9z M18.9,19.5c-0.6,0.2-1.1,0.6-1.5,1.1c-0.4,0.6-1.1,1-1.9,0.9c-0.4,0-0.8-0.3-0.9-0.7c-0.1-0.6-0.1-1.2,0.2-1.8c0.1-0.4,0.2-0.7,0.3-1.1c0.1-1.2,0.1-1.9,0.6-2.2h0c0,0.5,0.3,0.8,0.7,1c0.5,0,1-0.1,1.4-0.5c0.1,0,0.1,0,0.2,0c0.3,0,0.5,0,0.7,0.2c0.2,0.2,0.3,0.5,0.3,0.7c0,0.3,0.2,0.6,0.3,0.9c0.5,0.5,0.5,0.8,0.5,0.9C19.7,19.1,19.3,19.3,18.9,19.5z M9.9,7.5c-0.1,0-0.1,0-0.1,0.1c0,0,0,0.1,0.1,0.1c0,0,0,0,0,0c0.1,0,0.1,0.1,0.1,0.1c0.3,0.4,0.8,0.6,1.4,0.7c0.5-0.1,1-0.2,1.5-0.6c0.2-0.1,0.4-0.2,0.6-0.3c0.1,0,0.1-0.1,0.1-0.1c0-0.1,0-0.1-0.1-0.1l0,0c-0.2,0.1-0.5,0.2-0.7,0.3c-0.4,0.3-0.9,0.5-1.4,0.5c-0.5,0-0.9-0.3-1.2-0.6C10.1,7.6,10,7.5,9.9,7.5z",fill:"currentColor"})})}return e.jsx(Ou,{svg:e.jsx(s,{})})},bn=()=>{function u(){return e.jsxs("svg",{t:"1709714447384",className:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"5091",width:"16",height:"16",children:[e.jsx("path",{d:"M690.1 377.4c5.9 0 11.8 0.2 17.6 0.5-24.4-128.7-158.3-227.1-319.9-227.1C209 150.8 64 271.4 64 420.2c0 81.1 43.6 154.2 111.9 203.6 5.5 3.9 9.1 10.3 9.1 17.6 0 2.4-0.5 4.6-1.1 6.9-5.5 20.3-14.2 52.8-14.6 54.3-0.7 2.6-1.7 5.2-1.7 7.9 0 5.9 4.8 10.8 10.8 10.8 2.3 0 4.2-0.9 6.2-2l70.9-40.9c5.3-3.1 11-5 17.2-5 3.2 0 6.4 0.5 9.5 1.4 33.1 9.5 68.8 14.8 105.7 14.8 6 0 11.9-0.1 17.8-0.4-7.1-21-10.9-43.1-10.9-66 0-135.8 132.2-245.8 295.3-245.8z m-194.3-86.5c23.8 0 43.2 19.3 43.2 43.1s-19.3 43.1-43.2 43.1c-23.8 0-43.2-19.3-43.2-43.1s19.4-43.1 43.2-43.1z m-215.9 86.2c-23.8 0-43.2-19.3-43.2-43.1s19.3-43.1 43.2-43.1 43.2 19.3 43.2 43.1-19.4 43.1-43.2 43.1z","p-id":"5092"}),e.jsx("path",{d:"M866.7 792.7c56.9-41.2 93.2-102 93.2-169.7 0-124-120.8-224.5-269.9-224.5-149 0-269.9 100.5-269.9 224.5S540.9 847.5 690 847.5c30.8 0 60.6-4.4 88.1-12.3 2.6-0.8 5.2-1.2 7.9-1.2 5.2 0 9.9 1.6 14.3 4.1l59.1 34c1.7 1 3.3 1.7 5.2 1.7 2.4 0 4.7-0.9 6.4-2.6 1.7-1.7 2.6-4 2.6-6.4 0-2.2-0.9-4.4-1.4-6.6-0.3-1.2-7.6-28.3-12.2-45.3-0.5-1.9-0.9-3.8-0.9-5.7 0.1-5.9 3.1-11.2 7.6-14.5zM600.2 587.2c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9c0 19.8-16.2 35.9-36 35.9z m179.9 0c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9c-0.1 19.8-16.2 35.9-36 35.9z","p-id":"5093"})]})}return e.jsx("div",{children:e.jsx(Ou,{svg:e.jsx(u,{})})})};function Sn(u){localStorage.setItem("status",JSON.stringify(u)),localStorage.setItem("system_name",u.system_name),localStorage.setItem("logo",u.logo),localStorage.setItem("footer_html",u.footer_html),localStorage.setItem("quota_per_unit",u.quota_per_unit),localStorage.setItem("display_in_currency",u.display_in_currency),localStorage.setItem("enable_drawing",u.enable_drawing),localStorage.setItem("enable_data_export",u.enable_data_export),localStorage.setItem("data_export_default_time",u.data_export_default_time),localStorage.setItem("default_collapse_sidebar",u.default_collapse_sidebar),localStorage.setItem("mj_notify_enabled",u.mj_notify_enabled),u.chat_link?localStorage.setItem("chat_link",u.chat_link):localStorage.removeItem("chat_link"),u.chat_link2?localStorage.setItem("chat_link2",u.chat_link2):localStorage.removeItem("chat_link2")}function wn(u){localStorage.setItem("user",JSON.stringify(u))}const vn=()=>{const[u,s]=t.useState({username:"",password:"",wechat_verification_code:""}),[c,a]=bu(),[l,r]=t.useState(!1),{username:F,password:y}=u,[w,h]=t.useContext(Ge),[o,i]=t.useState(!1),[x,k]=t.useState(""),[$,_]=t.useState("");let L=_e();const[v,H]=t.useState({});xu(),t.useEffect(()=>{c.get("expired")&&E("未登录或登录已过期，请重新登录！");let A=localStorage.getItem("status");A&&(A=JSON.parse(A),H(A),A.turnstile_check&&(i(!0),k(A.turnstile_site_key)))},[]);const[Q,X]=t.useState(!1),K=()=>{X(!0)},Y=async()=>{if(o&&$===""){be("请稍后几秒重试，Turnstile 正在检查用户环境！");return}const A=await R.get(`/api/oauth/wechat?code=${u.wechat_verification_code}`),{success:f,message:P,data:B}=A.data;f?(h({type:"login",payload:B}),localStorage.setItem("user",JSON.stringify(B)),L("/"),J("登录成功！"),X(!1)):E(P)};function Z(A,f){s(P=>({...P,[A]:f}))}async function te(A){if(o&&$===""){be("请稍后几秒重试，Turnstile 正在检查用户环境！");return}if(r(!0),F&&y){const f=await R.post(`/api/user/login?turnstile=${$}`,{username:F,password:y}),{success:P,message:B,data:j}=f.data;P?(h({type:"login",payload:j}),wn(j),J("登录成功！"),F==="root"&&y==="123456"&&je.error({title:"您正在使用默认密码！",content:"请立刻修改默认密码！",centered:!0}),L("/token")):E(B)}else E("请输入用户名和密码！")}const G=async A=>{const f=["id","first_name","last_name","username","photo_url","auth_date","hash","lang"],P={};f.forEach(d=>{A[d]&&(P[d]=A[d])});const B=await R.get("/api/oauth/telegram/login",{params:P}),{success:j,message:b,data:n}=B.data;j?(h({type:"login",payload:n}),localStorage.setItem("user",JSON.stringify(n)),J("登录成功！"),L("/")):E(b)};return e.jsx("div",{children:e.jsxs(le,{children:[e.jsx(le.Header,{}),e.jsx(le.Content,{children:e.jsx("div",{style:{justifyContent:"center",display:"flex",marginTop:120},children:e.jsxs("div",{style:{width:500},children:[e.jsxs(Se,{children:[e.jsx(uu,{heading:2,style:{textAlign:"center"},children:"用户登录"}),e.jsxs(N,{children:[e.jsx(N.Input,{field:"username",label:"用户名",placeholder:"用户名",name:"username",onChange:A=>Z("username",A)}),e.jsx(N.Input,{field:"password",label:"密码",placeholder:"密码",name:"password",type:"password",onChange:A=>Z("password",A)}),e.jsx(I,{theme:"solid",style:{width:"100%"},type:"primary",size:"large",htmlType:"submit",onClick:te,children:"登录"})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:20},children:[e.jsxs(ru,{children:["没有账号请先 ",e.jsx(cu,{to:"/register",children:"注册账号"})]}),e.jsxs(ru,{children:["忘记密码 ",e.jsx(cu,{to:"/reset",children:"点击重置"})]})]}),v.github_oauth||v.linuxdo_oauth||v.wechat_login||v.telegram_oauth?e.jsxs(e.Fragment,{children:[e.jsx(Bu,{margin:"12px",align:"center",children:"第三方登录"}),e.jsxs("div",{style:{display:"flex",justifyContent:"center",marginTop:20},children:[v.github_oauth?e.jsx(I,{type:"primary",icon:e.jsx(Pt,{}),onClick:()=>xt(v.github_client_id)}):e.jsx(e.Fragment,{}),v.linuxdo_oauth?e.jsx(I,{type:"primary",icon:e.jsx(An,{}),style:{color:"#000",margin:"0 5px"},onClick:()=>Et(v.linuxdo_client_id)}):e.jsx(e.Fragment,{}),v.wechat_login?e.jsx(I,{type:"primary",style:{color:"rgba(var(--semi-green-5), 1)",margin:"0 5px"},icon:e.jsx(Ou,{svg:e.jsx(bn,{})}),onClick:K}):e.jsx(e.Fragment,{}),v.telegram_oauth?e.jsx(it,{className:"semi-button semi-button-with-icon semi-button-with-icon-only",buttonSize:"medium",dataOnauth:G,botName:v.telegram_bot_name}):e.jsx(e.Fragment,{})]})]}):e.jsx(e.Fragment,{}),e.jsxs(je,{title:"微信扫码登录",visible:Q,maskClosable:!0,onOk:Y,onCancel:()=>X(!1),okText:"登录",size:"small",centered:!0,children:[e.jsx("div",{style:{display:"flex",alignItem:"center",flexDirection:"column"},children:e.jsx("img",{src:v.wechat_qrcode})}),e.jsx("div",{style:{textAlign:"center"},children:e.jsx("p",{children:"微信扫码关注公众号，输入「验证码」获取验证码（三分钟内有效）"})}),e.jsx(N,{size:"large",children:e.jsx(N.Input,{field:"wechat_verification_code",placeholder:"验证码",label:"验证码",value:u.wechat_verification_code,onChange:A=>Z("wechat_verification_code",A)})})]})]}),o?e.jsx("div",{style:{display:"flex",justifyContent:"center",marginTop:20},children:e.jsx(lu,{sitekey:x,onVerify:A=>{_(A)}})}):e.jsx(e.Fragment,{})]})})})]})})},kn=()=>e.jsx(e.Fragment,{children:e.jsxs(ou,{negative:!0,children:[e.jsx(ou.Header,{children:"页面不存在"}),e.jsx("p",{children:"请检查你的浏览器地址是否正确"})]})}),Ct=t.createContext(null),ft=()=>t.useContext(Ct),jt=t.createContext(null),_n=()=>t.useContext(jt),Tn=({children:u})=>{const[s,c]=t.useState(()=>{try{return localStorage.getItem("theme-mode")||null}catch{return null}}),a=t.useCallback(l=>{c(l?"dark":"light");const r=document.body;l?(r.setAttribute("theme-mode","dark"),localStorage.setItem("theme-mode","dark")):(r.removeAttribute("theme-mode"),localStorage.setItem("theme-mode","light"))},[]);return e.jsx(jt.Provider,{value:a,children:e.jsx(Ct.Provider,{value:s,children:u})})},In=()=>{let[u,s]=t.useState({PasswordLoginEnabled:"",PasswordRegisterEnabled:"",EmailVerificationEnabled:"",GitHubOAuthEnabled:"",GitHubClientId:"",GitHubClientSecret:"",LinuxDoOAuthEnabled:"",LinuxDoClientId:"",LinuxDoClientSecret:"",LinuxDoMinLevel:0,Notice:"",SMTPServer:"",SMTPPort:"",SMTPAccount:"",SMTPFrom:"",SMTPToken:"",ServerAddress:"",OutProxyUrl:"",StripeApiSecret:"",StripeWebhookSecret:"",StripePriceId:"",PaymentEnabled:!1,StripeUnitPrice:8,MinTopUp:5,TopupGroupRatio:"",Footer:"",WeChatAuthEnabled:"",WeChatServerAddress:"",WeChatServerToken:"",WeChatAccountQRCodeImageURL:"",TurnstileCheckEnabled:"",TurnstileSiteKey:"",TurnstileSecretKey:"",RegisterEnabled:"",UserSelfDeletionEnabled:!1,EmailDomainRestrictionEnabled:"",EmailAliasRestrictionEnabled:"",SMTPSSLEnabled:"",EmailDomainWhitelist:[],TelegramOAuthEnabled:"",TelegramBotToken:"",TelegramBotName:""});const[c,a]=t.useState({});let[l,r]=t.useState(!1);const[F,y]=t.useState([]),[w,h]=t.useState(""),[o,i]=t.useState(!1),k=ft()==="dark",$=async()=>{const P=await R.get("/api/option/"),{success:B,message:j,data:b}=P.data;if(B){let n={};b.forEach(d=>{d.key==="TopupGroupRatio"&&(d.value=JSON.stringify(JSON.parse(d.value),null,2)),n[d.key]=d.value}),s({...n,EmailDomainWhitelist:n.EmailDomainWhitelist.split(",")}),a(n),y(n.EmailDomainWhitelist.split(",").map(d=>({key:d,text:d,value:d})))}else E(j)};t.useEffect(()=>{$().then()},[]),t.useEffect(()=>{},[u.EmailDomainWhitelist]);const _=async(P,B)=>{switch(r(!0),P){case"PasswordLoginEnabled":case"PasswordRegisterEnabled":case"EmailVerificationEnabled":case"GitHubOAuthEnabled":case"LinuxDoOAuthEnabled":case"WeChatAuthEnabled":case"TelegramOAuthEnabled":case"TurnstileCheckEnabled":case"EmailDomainRestrictionEnabled":case"EmailAliasRestrictionEnabled":case"SMTPSSLEnabled":case"RegisterEnabled":case"UserSelfDeletionEnabled":case"PaymentEnabled":B=u[P]==="true"?"false":"true";break}const j=await R.put("/api/option/",{key:P,value:B}),{success:b,message:n}=j.data;b?(P==="EmailDomainWhitelist"&&(B=B.split(",")),s(d=>({...d,[P]:B}))):E(n),r(!1)},L=async(P,{name:B,value:j})=>{if(B==="PasswordLoginEnabled"&&u[B]==="true"){i(!0);return}B==="Notice"||B.startsWith("SMTP")&&B!=="SMTPSSLEnabled"||B==="ServerAddress"||B==="OutProxyUrl"||B==="StripeApiSecret"||B==="StripeWebhookSecret"||B==="StripePriceId"||B==="StripeUnitPrice"||B==="MinTopUp"||B==="GitHubClientId"||B==="GitHubClientSecret"||B==="LinuxDoClientId"||B==="LinuxDoClientSecret"||B==="LinuxDoMinLevel"||B==="WeChatServerAddress"||B==="WeChatServerToken"||B==="WeChatAccountQRCodeImageURL"||B==="TurnstileSiteKey"||B==="TurnstileSecretKey"||B==="EmailDomainWhitelist"||B==="TopupGroupRatio"||B==="TelegramBotToken"||B==="TelegramBotName"?s(b=>({...b,[B]:j})):await _(B,j)},v=async()=>{let P=su(u.ServerAddress);await _("ServerAddress",P)},H=async()=>{let P=su(u.OutProxyUrl);await _("OutProxyUrl",P)},Q=async()=>{if(u.ServerAddress===""){E("请先填写服务器地址");return}if(c.TopupGroupRatio!==u.TopupGroupRatio){if(!iu(u.TopupGroupRatio)){E("充值分组倍率不是合法的 JSON 字符串");return}await _("TopupGroupRatio",u.TopupGroupRatio)}let P=su(u.StripeApiSecret);if(P&&!P.startsWith("sk_")){E("输入了无效的Stripe API密钥");return}P&&await _("StripeApiSecret",P);let B=su(u.StripeWebhookSecret);if(B&&!B.startsWith("whsec_")){E("输入了无效的Stripe Webhook签名密钥");return}B&&await _("StripeWebhookSecret",B);let j=su(u.StripePriceId);if(j&&!j.startsWith("price_")){E("输入了无效的Stripe 物品价格ID");return}await _("StripePriceId",j),await _("PaymentEnable",u.PaymentEnabled),await _("StripeUnitPrice",u.StripeUnitPrice),await _("MinTopUp",u.MinTopUp)},X=async()=>{c.SMTPServer!==u.SMTPServer&&await _("SMTPServer",u.SMTPServer),c.SMTPAccount!==u.SMTPAccount&&await _("SMTPAccount",u.SMTPAccount),c.SMTPFrom!==u.SMTPFrom&&await _("SMTPFrom",u.SMTPFrom),c.SMTPPort!==u.SMTPPort&&u.SMTPPort!==""&&await _("SMTPPort",u.SMTPPort),c.SMTPToken!==u.SMTPToken&&u.SMTPToken!==""&&await _("SMTPToken",u.SMTPToken)},K=async()=>{c.EmailDomainWhitelist!==u.EmailDomainWhitelist.join(",")&&u.SMTPToken!==""&&await _("EmailDomainWhitelist",u.EmailDomainWhitelist.join(","))},Y=async()=>{c.WeChatServerAddress!==u.WeChatServerAddress&&await _("WeChatServerAddress",su(u.WeChatServerAddress)),c.WeChatAccountQRCodeImageURL!==u.WeChatAccountQRCodeImageURL&&await _("WeChatAccountQRCodeImageURL",u.WeChatAccountQRCodeImageURL),c.WeChatServerToken!==u.WeChatServerToken&&u.WeChatServerToken!==""&&await _("WeChatServerToken",u.WeChatServerToken)},Z=async()=>{c.GitHubClientId!==u.GitHubClientId&&await _("GitHubClientId",u.GitHubClientId),c.GitHubClientSecret!==u.GitHubClientSecret&&u.GitHubClientSecret!==""&&await _("GitHubClientSecret",u.GitHubClientSecret)},te=async()=>{c.LinuxDoClientId!==u.LinuxDoClientId&&await _("LinuxDoClientId",u.LinuxDoClientId),c.LinuxDoClientSecret!==u.LinuxDoClientSecret&&u.LinuxDoClientSecret!==""&&await _("LinuxDoClientSecret",u.LinuxDoClientSecret),c.LinuxDoMinLevel!==u.LinuxDoMinLevel&&await _("LinuxDoMinLevel",u.LinuxDoMinLevel)},G=async()=>{await _("TelegramBotToken",u.TelegramBotToken),await _("TelegramBotName",u.TelegramBotName)},A=async()=>{c.TurnstileSiteKey!==u.TurnstileSiteKey&&await _("TurnstileSiteKey",u.TurnstileSiteKey),c.TurnstileSecretKey!==u.TurnstileSecretKey&&u.TurnstileSecretKey!==""&&await _("TurnstileSecretKey",u.TurnstileSecretKey)},f=()=>{const P=u.EmailDomainWhitelist;w!==""&&!P.includes(w)&&(h(""),s({...u,EmailDomainWhitelist:[...P,w]}),y([...F,{key:w,text:w,value:w}]))};return e.jsx(Ve,{columns:1,children:e.jsx(Ve.Column,{children:e.jsxs(W,{loading:l,inverted:k,children:[e.jsx(Ce,{as:"h3",inverted:k,children:"通用设置"}),e.jsx(W.Group,{widths:"equal",children:e.jsx(W.Input,{label:"服务器地址",placeholder:"例如：https://yourdomain.com",value:u.ServerAddress,name:"ServerAddress",onChange:L})}),e.jsx(W.Button,{onClick:v,children:"更新服务器地址"}),e.jsx(Ae,{}),e.jsx(Ce,{as:"h3",inverted:k,children:"代理设置"}),e.jsx(W.Group,{widths:"equal",children:e.jsx(W.Input,{label:"出口代理地址",placeholder:"例如：http://1.2.3.4:8888",value:u.OutProxyUrl,name:"OutProxyUrl",onChange:L})}),e.jsx(W.Button,{onClick:H,children:"更新代理设置"}),e.jsx(Ae,{}),e.jsxs(Ce,{as:"h3",inverted:k,children:["支付设置（当前仅支持Stripe Checkout）",e.jsxs(Ce.Subheader,{children:["密钥、Webhook 等设置请",e.jsx("a",{href:"https://dashboard.stripe.com/developers",target:"_blank",rel:"noreferrer",children:"点击此处"}),"进行设置，最好先在",e.jsx("a",{href:"https://dashboard.stripe.com/test/developers",target:"_blank",rel:"noreferrer",children:"测试环境"}),"进行测试"]})]}),e.jsxs(ou,{children:["Webhook 填：",e.jsx("code",{children:`${u.ServerAddress}/api/stripe/webhook`}),"，需要包含事件：",e.jsx("code",{children:"checkout.session.completed"})," 和"," ",e.jsx("code",{children:"checkout.session.expired"})]}),e.jsxs(W.Group,{widths:"equal",children:[e.jsx(W.Input,{label:"API密钥",placeholder:"sk_xxx的Stripe密钥，敏感信息不显示",value:u.StripeApiSecret,name:"StripeApiSecret",onChange:L}),e.jsx(W.Input,{label:"Webhook签名密钥",placeholder:"whsec_xxx的Webhook签名密钥，敏感信息不显示",value:u.StripeWebhookSecret,name:"StripeWebhookSecret",onChange:L}),e.jsx(W.Input,{label:"商品价格ID",placeholder:"price_xxx的商品价格ID，新建产品后可获得",value:u.StripePriceId,name:"StripePriceId",onChange:L})]}),e.jsxs(W.Group,{widths:"equal",children:[e.jsx(W.Input,{label:"商品单价（元）",placeholder:"商品的人民币价格",value:u.StripeUnitPrice,name:"StripeUnitPrice",type:"number",min:0,onChange:L}),e.jsx(W.Input,{label:"最低充值数量",placeholder:"例如：2，就是最低充值2件商品",value:u.MinTopUp,name:"MinTopUp",type:"number",min:1,onChange:L})]}),e.jsx(W.Group,{widths:"equal",children:e.jsx(W.TextArea,{label:"充值分组倍率",name:"TopupGroupRatio",onChange:L,style:{minHeight:250,fontFamily:"JetBrains Mono, Consolas"},autoComplete:"new-password",value:u.TopupGroupRatio,placeholder:"为一个 JSON 文本，键为组名称，值为倍率"})}),e.jsxs(W.Group,{inline:!0,children:[e.jsx(W.Button,{onClick:Q,children:"更新支付设置"}),e.jsx(W.Checkbox,{checked:u.PaymentEnabled==="true",label:"开启在线支付",name:"PaymentEnabled",onChange:L})]}),e.jsx(Ae,{}),e.jsx(Ce,{as:"h3",inverted:k,children:"配置登录注册"}),e.jsxs(W.Group,{inline:!0,children:[e.jsx(W.Checkbox,{checked:u.PasswordLoginEnabled==="true",label:"允许通过密码进行登录",name:"PasswordLoginEnabled",onChange:L}),o&&e.jsxs(ju,{open:o,onClose:()=>i(!1),size:"tiny",style:{maxWidth:"450px"},children:[e.jsx(ju.Header,{children:"警告"}),e.jsx(ju.Content,{children:e.jsx("p",{children:"取消密码登录将导致所有未绑定其他登录方式的用户（包括管理员）无法通过密码登录，确认取消？"})}),e.jsxs(ju.Actions,{children:[e.jsx(eu,{onClick:()=>i(!1),children:"取消"}),e.jsx(eu,{color:"yellow",onClick:async()=>{i(!1),await _("PasswordLoginEnabled","false")},children:"确定"})]})]}),e.jsx(W.Checkbox,{checked:u.PasswordRegisterEnabled==="true",label:"允许通过密码进行注册",name:"PasswordRegisterEnabled",onChange:L}),e.jsx(W.Checkbox,{checked:u.EmailVerificationEnabled==="true",label:"通过密码注册时需要进行邮箱验证",name:"EmailVerificationEnabled",onChange:L}),e.jsx(W.Checkbox,{checked:u.GitHubOAuthEnabled==="true",label:"允许通过 GitHub 账户登录 & 注册",name:"GitHubOAuthEnabled",onChange:L}),e.jsx(W.Checkbox,{checked:u.LinuxDoOAuthEnabled==="true",label:"允许通过 LINUX DO 账户登录 & 注册",name:"LinuxDoOAuthEnabled",onChange:L}),e.jsx(W.Checkbox,{checked:u.WeChatAuthEnabled==="true",label:"允许通过微信登录 & 注册",name:"WeChatAuthEnabled",onChange:L}),e.jsx(W.Checkbox,{checked:u.TelegramOAuthEnabled==="true",label:"允许通过 Telegram 进行登录",name:"TelegramOAuthEnabled",onChange:L})]}),e.jsxs(W.Group,{inline:!0,children:[e.jsx(W.Checkbox,{checked:u.RegisterEnabled==="true",label:"允许新用户注册（此项为否时，新用户将无法以任何方式进行注册）",name:"RegisterEnabled",onChange:L}),e.jsx(W.Checkbox,{checked:u.TurnstileCheckEnabled==="true",label:"启用 Turnstile 用户校验",name:"TurnstileCheckEnabled",onChange:L}),e.jsx(W.Checkbox,{checked:u.UserSelfDeletionEnabled==="true",label:"允许用户自行删除账户",name:"UserSelfDeletionEnabled",onChange:L})]}),e.jsx(Ae,{}),e.jsxs(Ce,{as:"h3",inverted:k,children:["配置邮箱域名白名单",e.jsx(Ce.Subheader,{children:"用以防止恶意用户利用临时邮箱批量注册"})]}),e.jsx(W.Group,{widths:3,children:e.jsx(W.Checkbox,{label:"启用邮箱域名白名单",name:"EmailDomainRestrictionEnabled",onChange:L,checked:u.EmailDomainRestrictionEnabled==="true"})}),e.jsx(W.Group,{widths:3,children:e.jsx(W.Checkbox,{label:"启用邮箱别名限制（例如：ab.cd@gmail.com）",name:"EmailAliasRestrictionEnabled",onChange:L,checked:u.EmailAliasRestrictionEnabled==="true"})}),e.jsxs(W.Group,{widths:2,children:[e.jsx(W.Dropdown,{label:"允许的邮箱域名",placeholder:"允许的邮箱域名",name:"EmailDomainWhitelist",required:!0,fluid:!0,multiple:!0,selection:!0,onChange:L,value:u.EmailDomainWhitelist,autoComplete:"new-password",options:F}),e.jsx(W.Input,{label:"添加新的允许的邮箱域名",action:e.jsx(eu,{type:"button",onClick:()=>{f()},children:"填入"}),onKeyDown:P=>{P.key==="Enter"&&f()},autoComplete:"new-password",placeholder:"输入新的允许的邮箱域名",value:w,onChange:(P,{value:B})=>{h(B)}})]}),e.jsx(W.Button,{onClick:K,children:"保存邮箱域名白名单设置"}),e.jsx(Ae,{}),e.jsxs(Ce,{as:"h3",inverted:k,children:["配置 SMTP",e.jsx(Ce.Subheader,{children:"用以支持系统的邮件发送"})]}),e.jsxs(W.Group,{widths:3,children:[e.jsx(W.Input,{label:"SMTP 服务器地址",name:"SMTPServer",onChange:L,autoComplete:"new-password",value:u.SMTPServer,placeholder:"例如：smtp.qq.com"}),e.jsx(W.Input,{label:"SMTP 端口",name:"SMTPPort",onChange:L,autoComplete:"new-password",value:u.SMTPPort,placeholder:"默认: 587"}),e.jsx(W.Input,{label:"SMTP 账户",name:"SMTPAccount",onChange:L,autoComplete:"new-password",value:u.SMTPAccount,placeholder:"通常是邮箱地址"})]}),e.jsxs(W.Group,{widths:3,children:[e.jsx(W.Input,{label:"SMTP 发送者邮箱",name:"SMTPFrom",onChange:L,autoComplete:"new-password",value:u.SMTPFrom,placeholder:"通常和邮箱地址保持一致"}),e.jsx(W.Input,{label:"SMTP 访问凭证",name:"SMTPToken",onChange:L,type:"password",autoComplete:"new-password",checked:u.RegisterEnabled==="true",placeholder:"敏感信息不会发送到前端显示"})]}),e.jsx(W.Group,{widths:3,children:e.jsx(W.Checkbox,{label:"启用SMTP SSL（465端口强制开启）",name:"SMTPSSLEnabled",onChange:L,checked:u.SMTPSSLEnabled==="true"})}),e.jsx(W.Button,{onClick:X,children:"保存 SMTP 设置"}),e.jsx(Ae,{}),e.jsxs(Ce,{as:"h3",inverted:k,children:["配置 GitHub OAuth App",e.jsxs(Ce.Subheader,{children:["用以支持通过 GitHub 进行登录注册，",e.jsx("a",{href:"https://github.com/settings/developers",target:"_blank",rel:"noreferrer",children:"点击此处"}),"管理你的 GitHub OAuth App"]})]}),e.jsxs(ou,{children:["Homepage URL 填 ",e.jsx("code",{children:u.ServerAddress}),"，Authorization callback URL 填"," ",e.jsx("code",{children:`${u.ServerAddress}/oauth/github`})]}),e.jsxs(W.Group,{widths:3,children:[e.jsx(W.Input,{label:"GitHub Client ID",name:"GitHubClientId",onChange:L,autoComplete:"new-password",value:u.GitHubClientId,placeholder:"输入你注册的 GitHub OAuth APP 的 ID"}),e.jsx(W.Input,{label:"GitHub Client Secret",name:"GitHubClientSecret",onChange:L,type:"password",autoComplete:"new-password",value:u.GitHubClientSecret,placeholder:"敏感信息不会发送到前端显示"})]}),e.jsx(W.Button,{onClick:Z,children:"保存 GitHub OAuth 设置"}),e.jsx(Ae,{}),e.jsxs(Ce,{as:"h3",children:["配置 LINUX DO Oauth",e.jsxs(Ce.Subheader,{children:["用以支持通过 LINUX DO 进行登录注册，",e.jsx("a",{href:"https://connect.linux.do",target:"_blank",rel:"noreferrer",children:"点击此处"}),"管理你的 LINUX DO OAuth"]})]}),e.jsxs(ou,{children:["Homepage URL 填 ",e.jsx("code",{children:u.ServerAddress}),"，Authorization callback URL 填"," ",e.jsx("code",{children:`${u.ServerAddress}/oauth/linuxdo`})]}),e.jsxs(W.Group,{widths:3,children:[e.jsx(W.Input,{label:"LINUX DO Client ID",name:"LinuxDoClientId",onChange:L,autoComplete:"new-password",value:u.LinuxDoClientId,placeholder:"输入你注册的 LINUX DO OAuth 的 ID"}),e.jsx(W.Input,{label:"LINUX DO Client Secret",name:"LinuxDoClientSecret",onChange:L,type:"password",autoComplete:"new-password",value:u.LinuxDoClientSecret,placeholder:"敏感信息不会发送到前端显示"}),e.jsx(W.Input,{label:"限制最低信任等级",name:"LinuxDoMinLevel",onChange:L,type:"number",min:0,max:4,value:u.LinuxDoMinLevel,placeholder:"输入允许使用的最低 LINUX DO 信任等级"})]}),e.jsx(W.Button,{onClick:te,children:"保存 LINUX DO OAuth 设置"}),e.jsx(Ae,{}),e.jsxs(Ce,{as:"h3",inverted:k,children:["配置 WeChat Server",e.jsxs(Ce.Subheader,{children:["用以支持通过微信进行登录注册，",e.jsx("a",{href:"https://github.com/songquanpeng/wechat-server",target:"_blank",rel:"noreferrer",children:"点击此处"}),"了解 WeChat Server"]})]}),e.jsxs(W.Group,{widths:3,children:[e.jsx(W.Input,{label:"WeChat Server 服务器地址",name:"WeChatServerAddress",placeholder:"例如：https://yourdomain.com",onChange:L,autoComplete:"new-password",value:u.WeChatServerAddress}),e.jsx(W.Input,{label:"WeChat Server 访问凭证",name:"WeChatServerToken",type:"password",onChange:L,autoComplete:"new-password",value:u.WeChatServerToken,placeholder:"敏感信息不会发送到前端显示"}),e.jsx(W.Input,{label:"微信公众号二维码图片链接",name:"WeChatAccountQRCodeImageURL",onChange:L,autoComplete:"new-password",value:u.WeChatAccountQRCodeImageURL,placeholder:"输入一个图片链接"})]}),e.jsx(W.Button,{onClick:Y,children:"保存 WeChat Server 设置"}),e.jsx(Ae,{}),e.jsx(Ce,{as:"h3",inverted:k,children:"配置 Telegram 登录"}),e.jsxs(W.Group,{inline:!0,children:[e.jsx(W.Input,{label:"Telegram Bot Token",name:"TelegramBotToken",onChange:L,value:u.TelegramBotToken,placeholder:"输入你的 Telegram Bot Token"}),e.jsx(W.Input,{label:"Telegram Bot 名称",name:"TelegramBotName",onChange:L,value:u.TelegramBotName,placeholder:"输入你的 Telegram Bot 名称"})]}),e.jsx(W.Button,{onClick:G,children:"保存 Telegram 登录设置"}),e.jsx(Ae,{}),e.jsxs(Ce,{as:"h3",inverted:k,children:["配置 Turnstile",e.jsxs(Ce.Subheader,{children:["用以支持用户校验，",e.jsx("a",{href:"https://dash.cloudflare.com/",target:"_blank",rel:"noreferrer",children:"点击此处"}),"管理你的 Turnstile Sites，推荐选择 Invisible Widget Type"]})]}),e.jsxs(W.Group,{widths:3,children:[e.jsx(W.Input,{label:"Turnstile Site Key",name:"TurnstileSiteKey",onChange:L,autoComplete:"new-password",value:u.TurnstileSiteKey,placeholder:"输入你注册的 Turnstile Site Key"}),e.jsx(W.Input,{label:"Turnstile Secret Key",name:"TurnstileSecretKey",onChange:L,type:"password",autoComplete:"new-password",value:u.TurnstileSecretKey,placeholder:"敏感信息不会发送到前端显示"})]}),e.jsx(W.Button,{onClick:A,children:"保存 Turnstile 设置"})]})})})},Pn=()=>{let[u,s]=t.useState({Notice:"",SystemName:"",Logo:"",Footer:"",About:"",HomePageContent:""}),[c,a]=t.useState(!1);t.useState(!1),t.useState({tag_name:"",content:""});const l=async(v,H)=>{a(!0);const Q=await R.put("/api/option/",{key:v,value:H}),{success:X,message:K}=Q.data;X?s(Y=>({...Y,[v]:H})):E(K),a(!1)},[r,F]=t.useState({Notice:!1,SystemName:!1,Logo:!1,HomePageContent:!1,About:!1,Footer:!1}),y=async(v,H)=>{const Q=H.target.id;s(X=>({...X,[Q]:v}))},w=t.useRef(),h=async()=>{try{F(v=>({...v,Notice:!0})),await l("Notice",u.Notice),J("公告已更新")}catch(v){console.error("公告更新失败",v),E("公告更新失败")}finally{F(v=>({...v,Notice:!1}))}},o=t.useRef(),i=async()=>{try{F(v=>({...v,SystemName:!0})),await l("SystemName",u.SystemName),J("系统名称已更新")}catch(v){console.error("系统名称更新失败",v),E("系统名称更新失败")}finally{F(v=>({...v,SystemName:!1}))}},x=async()=>{try{F(v=>({...v,Logo:!0})),await l("Logo",u.Logo),J("Logo 已更新")}catch(v){console.error("Logo 更新失败",v),E("Logo 更新失败")}finally{F(v=>({...v,Logo:!1}))}},k=async v=>{try{F(H=>({...H,HomePageContent:!0})),await l(v,u[v]),J("首页内容已更新")}catch(H){console.error("首页内容更新失败",H),E("首页内容更新失败")}finally{F(H=>({...H,HomePageContent:!1}))}},$=async()=>{try{F(v=>({...v,About:!0})),await l("About",u.About),J("关于内容已更新")}catch(v){console.error("关于内容更新失败",v),E("关于内容更新失败")}finally{F(v=>({...v,About:!1}))}},_=async()=>{try{F(v=>({...v,Footer:!0})),await l("Footer",u.Footer),J("页脚内容已更新")}catch(v){console.error("页脚内容更新失败",v),E("页脚内容更新失败")}finally{F(v=>({...v,Footer:!1}))}},L=async()=>{const v=await R.get("/api/option/"),{success:H,message:Q,data:X}=v.data;if(H){let K={};X.forEach(Y=>{Y.key in u&&(K[Y.key]=Y.value)}),s(K),w.current.setValues(K),o.current.setValues(K)}else E(Q)};return t.useEffect(()=>{L()},[]),e.jsx(ge,{children:e.jsxs(ce,{span:24,children:[e.jsx(N,{values:u,getFormApi:v=>w.current=v,style:{marginBottom:15},children:e.jsxs(N.Section,{text:"通用设置",children:[e.jsx(N.TextArea,{label:"公告",placeholder:"在此输入新的公告内容，支持 Markdown & HTML 代码",field:"Notice",onChange:y,style:{fontFamily:"JetBrains Mono, Consolas"},autosize:{minRows:6,maxRows:12}}),e.jsx(I,{onClick:h,loading:r.Notice,children:"设置公告"})]})}),e.jsx(N,{values:u,getFormApi:v=>o.current=v,style:{marginBottom:15},children:e.jsxs(N.Section,{text:"个性化设置",children:[e.jsx(N.Input,{label:"系统名称",placeholder:"在此输入系统名称",field:"SystemName",onChange:y}),e.jsx(I,{onClick:i,loading:r.SystemName,children:"设置系统名称"}),e.jsx(N.Input,{label:"Logo 图片地址",placeholder:"在此输入 Logo 图片地址",field:"Logo",onChange:y}),e.jsx(I,{onClick:x,loading:r.Logo,children:"设置 Logo"}),e.jsx(N.TextArea,{label:"首页内容",placeholder:"在此输入首页内容，支持 Markdown & HTML 代码，设置后首页的状态信息将不再显示。如果输入的是一个链接，则会使用该链接作为 iframe 的 src 属性，这允许你设置任意网页作为首页。",field:"HomePageContent",onChange:y,style:{fontFamily:"JetBrains Mono, Consolas"},autosize:{minRows:6,maxRows:12}}),e.jsx(I,{onClick:()=>k("HomePageContent"),loading:r.HomePageContent,children:"设置首页内容"}),e.jsx(N.TextArea,{label:"关于",placeholder:"在此输入新的关于内容，支持 Markdown & HTML 代码。如果输入的是一个链接，则会使用该链接作为 iframe 的 src 属性，这允许你设置任意网页作为关于页面。",field:"About",onChange:y,style:{fontFamily:"JetBrains Mono, Consolas"},autosize:{minRows:6,maxRows:12}}),e.jsx(I,{onClick:$,loading:r.About,children:"设置关于"}),e.jsx(We,{fullMode:!1,type:"info",description:"移除 One API 的版权标识必须首先获得授权，项目维护需要花费大量精力，如果本项目对你有意义，请主动支持本项目。",closeIcon:null,style:{marginTop:15}}),e.jsx(N.Input,{label:"页脚",placeholder:"在此输入新的页脚，留空则使用默认页脚，支持 HTML 代码",field:"Footer",onChange:y}),e.jsx(I,{onClick:_,loading:r.Footer,children:"设置页脚"})]})})]})})},Mn=()=>{var Eu,Cu,T,O,ne,ie,he,fe,$e,Xe,fu;const[u,s]=t.useContext(Ge);let c=_e();const[a,l]=t.useState({wechat_verification_code:"",email_verification_code:"",email:"",self_account_deletion_confirmation:"",set_new_password:"",set_new_password_confirmation:""}),[r,F]=t.useState({}),[y,w]=t.useState(!1),[h,o]=t.useState(!1),[i,x]=t.useState(!1),[k,$]=t.useState(!1),[_,L]=t.useState(!1),[v,H]=t.useState(""),[Q,X]=t.useState(""),[K,Y]=t.useState(!1),[Z,te]=t.useState(!1),[G,A]=t.useState(30),[f,P]=t.useState(""),[B,j]=t.useState(""),[b,n]=t.useState([]),[d,p]=t.useState(!1),[S,g]=t.useState(0);t.useEffect(()=>{let q=localStorage.getItem("status");q&&(q=JSON.parse(q),F(q),q.turnstile_check&&(L(!0),H(q.turnstile_site_key))),V().then(xe=>{console.log(u)}),D().then(),M().then(),g(yu())},[]),t.useEffect(()=>{let q=null;return Z&&G>0?q=setInterval(()=>{A(G-1)},1e3):G===0&&(te(!1),A(30)),()=>clearInterval(q)},[Z,G]);const C=(q,xe)=>{l(Ee=>({...Ee,[q]:xe}))},m=async()=>{const q=await R.get("/api/user/token"),{success:xe,message:Ee,data:Ne}=q.data;xe?(j(Ne),await Le(Ne),J("令牌已重置并已复制到剪贴板")):E(Ee)},M=async()=>{const q=await R.get("/api/user/aff"),{success:xe,message:Ee,data:Ne}=q.data;if(xe){let At=`${window.location.origin}/register?aff=${Ne}`;P(At)}else E(Ee)},V=async()=>{let q=await R.get("/api/user/self");const{success:xe,message:Ee,data:Ne}=q.data;xe?s({type:"login",payload:Ne}):E(Ee)},D=async()=>{let q=await R.get("/api/user/models");const{success:xe,message:Ee,data:Ne}=q.data;xe?(n(Ne),console.log(Ne)):E(Ee)},U=async q=>{q.target.select(),await Le(q.target.value),J("邀请链接已复制到剪切板")},ee=async q=>{q.target.select(),await Le(q.target.value),J("系统令牌已复制到剪切板")},ae=async()=>{if(a.self_account_deletion_confirmation!==u.user.username){E("请输入你的账户名以确认删除！");return}const q=await R.delete("/api/user/self"),{success:xe,message:Ee}=q.data;xe?(J("账户已删除！"),await R.get("/api/user/logout"),s({type:"logout"}),localStorage.removeItem("user"),c("/login")):E(Ee)},re=async()=>{if(a.wechat_verification_code==="")return;const q=await R.get(`/api/oauth/wechat/bind?code=${a.wechat_verification_code}`),{success:xe,message:Ee}=q.data;xe?(J("微信账户绑定成功！"),o(!1)):E(Ee)},oe=async()=>{if(a.set_new_password!==a.set_new_password_confirmation){E("两次输入的密码不一致！");return}const q=await R.put("/api/user/self",{password:a.set_new_password}),{success:xe,message:Ee}=q.data;xe?(J("密码修改成功！"),o(!1)):E(Ee),w(!1)},Be=async()=>{if(S<yu()){E("划转金额最低为"+me(yu()));return}const q=await R.post("/api/user/aff_transfer",{quota:S}),{success:xe,message:Ee}=q.data;xe?(J(Ee),p(!1),V().then()):E(Ee)},Te=async()=>{if(a.email===""){E("请输入邮箱！");return}if(te(!0),_&&Q===""){be("请稍后几秒重试，Turnstile 正在检查用户环境！");return}Y(!0);const q=await R.get(`/api/verification?email=${a.email}&turnstile=${Q}`),{success:xe,message:Ee}=q.data;xe?J("验证码发送成功，请检查邮箱！"):E(Ee),Y(!1)},Me=async()=>{if(a.email_verification_code===""){E("请输入邮箱验证码！");return}Y(!0);const q=await R.get(`/api/oauth/email/bind?email=${a.email}&code=${a.email_verification_code}`),{success:xe,message:Ee}=q.data;xe?(J("邮箱账户绑定成功！"),x(!1),u.user.email=a.email):E(Ee),Y(!1)},ze=()=>u.user?u.user.username:"null",Ye=()=>{p(!1)},nu=async q=>{await Le(q)?J("已复制："+q):je.error({title:"无法复制到剪贴板，请手动复制",content:q})};return e.jsx("div",{children:e.jsx(le,{children:e.jsxs(le.Content,{children:[e.jsxs(je,{title:"请输入要划转的数量",visible:d,onOk:Be,onCancel:Ye,maskClosable:!1,size:"small",centered:!0,children:[e.jsxs("div",{style:{marginTop:20},children:[e.jsx(ue.Text,{children:`可用额度${hu((Eu=u==null?void 0:u.user)==null?void 0:Eu.aff_quota)}`}),e.jsx(se,{style:{marginTop:5},value:(Cu=u==null?void 0:u.user)==null?void 0:Cu.aff_quota,disabled:!0})]}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(ue.Text,{children:`划转额度${hu(S)} 最低`+me(yu())}),e.jsx("div",{children:e.jsx(Tu,{min:0,style:{marginTop:5},value:S,onChange:q=>g(q),disabled:!1})})]})]}),e.jsxs("div",{style:{marginTop:20},children:[e.jsxs(Se,{title:e.jsx(Se.Meta,{avatar:e.jsx(zu,{size:"default",color:Fu(ze()),style:{marginRight:4},children:typeof ze()=="string"&&ze().slice(0,1)}),title:e.jsx(ue.Text,{children:ze()}),description:ht()?e.jsx(z,{color:"red",children:"管理员"}):e.jsx(z,{color:"blue",children:"普通用户"})}),headerExtraContent:e.jsx(e.Fragment,{children:e.jsxs(de,{vertical:!0,align:"start",children:[e.jsx(z,{color:"green",children:"ID: "+((T=u==null?void 0:u.user)==null?void 0:T.id)}),e.jsx(z,{color:"blue",children:(O=u==null?void 0:u.user)==null?void 0:O.group})]})}),footer:e.jsxs(He,{row:!0,children:[e.jsx(He.Item,{itemKey:"当前余额",children:me((ne=u==null?void 0:u.user)==null?void 0:ne.quota)}),e.jsx(He.Item,{itemKey:"历史消耗",children:me((ie=u==null?void 0:u.user)==null?void 0:ie.used_quota)}),e.jsx(He.Item,{itemKey:"请求次数",children:(he=u.user)==null?void 0:he.request_count})]}),children:[e.jsx(ue.Title,{heading:6,children:"可用模型"}),e.jsx("div",{style:{marginTop:10},children:e.jsx(de,{wrap:!0,children:b.map(q=>e.jsx(z,{color:"cyan",onClick:()=>{nu(q)},children:q},q))})})]}),e.jsxs(Se,{footer:e.jsxs("div",{children:[e.jsx(ue.Text,{children:"邀请链接"}),e.jsx(se,{style:{marginTop:10},value:f,onClick:U,readOnly:!0})]}),children:[e.jsx(ue.Title,{heading:6,children:"邀请信息"}),e.jsx("div",{style:{marginTop:10},children:e.jsxs(He,{row:!0,children:[e.jsxs(He.Item,{itemKey:"待使用收益",children:[e.jsx("span",{style:{color:"rgba(var(--semi-red-5), 1)"},children:me((fe=u==null?void 0:u.user)==null?void 0:fe.aff_quota)}),e.jsx(I,{type:"secondary",onClick:()=>p(!0),size:"small",style:{marginLeft:10},children:"划转"})]}),e.jsx(He.Item,{itemKey:"总收益",children:me(($e=u==null?void 0:u.user)==null?void 0:$e.aff_history_quota)}),e.jsx(He.Item,{itemKey:"邀请人数",children:(Xe=u==null?void 0:u.user)==null?void 0:Xe.aff_count})]})})]}),e.jsxs(Se,{children:[e.jsx(ue.Title,{heading:6,children:"个人信息"}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(ue.Text,{strong:!0,children:"邮箱"}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("div",{children:e.jsx(se,{value:u.user&&u.user.email!==""?u.user.email:"未绑定",readonly:!0})}),e.jsx("div",{children:e.jsx(I,{onClick:()=>{x(!0)},children:u.user&&u.user.email!==""?"修改绑定":"绑定邮箱"})})]})]}),e.jsxs("div",{style:{marginTop:10},children:[e.jsx(ue.Text,{strong:!0,children:"微信"}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("div",{children:e.jsx(se,{value:u.user&&u.user.wechat_id!==""?"已绑定":"未绑定",readonly:!0})}),e.jsx("div",{children:e.jsx(I,{disabled:u.user&&u.user.wechat_id!==""||!r.wechat_login,children:r.wechat_login?"绑定":"未启用"})})]})]}),e.jsxs("div",{style:{marginTop:10},children:[e.jsx(ue.Text,{strong:!0,children:"GitHub"}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("div",{children:e.jsx(se,{value:u.user&&u.user.github_id!==""?u.user.github_id:"未绑定",readonly:!0})}),e.jsx("div",{children:e.jsx(I,{onClick:()=>{xt(r.github_client_id)},disabled:u.user&&u.user.github_id!==""||!r.github_oauth,children:r.github_oauth?"绑定":"未启用"})})]})]}),e.jsxs("div",{style:{marginTop:10},children:[e.jsx(ue.Text,{strong:!0,children:"LINUX DO"}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("div",{children:e.jsx(se,{value:u.user&&u.user.linuxdo_id!==""?u.user.linuxdo_id+"（"+u.user.linuxdo_level+"级）":"未绑定",readonly:!0})}),e.jsx("div",{children:e.jsx(I,{onClick:()=>{Et(r.linuxdo_client_id)},disabled:u.user&&u.user.linuxdo_id!==""||!r.linuxdo_oauth,children:r.linuxdo_oauth?"绑定":"未启用"})})]})]}),e.jsxs("div",{style:{marginTop:10},children:[e.jsx(ue.Text,{strong:!0,children:"Telegram"}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("div",{children:e.jsx(se,{value:u.user&&u.user.telegram_id!==""?u.user.telegram_id:"未绑定",readonly:!0})}),e.jsx("div",{children:r.telegram_oauth?u.user.telegram_id!==""?e.jsx(I,{disabled:!0,children:"已绑定"}):e.jsx(it,{dataAuthUrl:"/api/oauth/telegram/bind",botName:r.telegram_bot_name}):e.jsx(I,{disabled:!0,children:"未启用"})})]})]}),e.jsxs("div",{style:{marginTop:10},children:[e.jsxs(de,{children:[e.jsx(I,{onClick:m,children:"生成系统访问令牌"}),e.jsx(I,{onClick:()=>{w(!0)},children:"修改密码"}),e.jsx(I,{type:"danger",onClick:()=>{$(!0)},children:"删除个人账户"})]}),B&&e.jsx(se,{readOnly:!0,value:B,onClick:ee,style:{marginTop:"10px"}}),r.wechat_login&&e.jsx(I,{onClick:()=>{o(!0)},children:"绑定微信账号"}),e.jsxs(je,{onCancel:()=>o(!1),visible:h,size:"small",children:[e.jsx(Mt,{src:r.wechat_qrcode}),e.jsx("div",{style:{textAlign:"center"},children:e.jsx("p",{children:"微信扫码关注公众号，输入「验证码」获取验证码（三分钟内有效）"})}),e.jsx(se,{placeholder:"验证码",name:"wechat_verification_code",value:a.wechat_verification_code,onChange:q=>C("wechat_verification_code",q)}),e.jsx(I,{color:"",fluid:!0,size:"large",onClick:re,children:"绑定"})]})]})]}),e.jsxs(je,{onCancel:()=>x(!1),onOk:Me,visible:i,size:"small",centered:!0,maskClosable:!1,children:[e.jsx(ue.Title,{heading:6,children:"绑定邮箱地址"}),e.jsxs("div",{style:{marginTop:20,display:"flex",justifyContent:"space-between"},children:[e.jsx(se,{fluid:!0,placeholder:"输入邮箱地址",onChange:q=>C("email",q),name:"email",type:"email"}),e.jsx(I,{onClick:Te,disabled:Z||K,children:Z?`重新发送 (${G})`:"获取验证码"})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(se,{fluid:!0,placeholder:"验证码",name:"email_verification_code",value:a.email_verification_code,onChange:q=>C("email_verification_code",q)})}),_?e.jsx(lu,{sitekey:v,onVerify:q=>{X(q)}}):e.jsx(e.Fragment,{})]}),e.jsxs(je,{onCancel:()=>$(!1),visible:k,size:"small",centered:!0,onOk:ae,children:[e.jsx("div",{style:{marginTop:20},children:e.jsx(We,{type:"danger",description:"您正在删除自己的帐户，将清空所有数据且不可恢复",closeIcon:null})}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(se,{placeholder:`输入你的账户名 ${(fu=u==null?void 0:u.user)==null?void 0:fu.username} 以确认删除`,name:"self_account_deletion_confirmation",value:a.self_account_deletion_confirmation,onChange:q=>C("self_account_deletion_confirmation",q)}),_?e.jsx(lu,{sitekey:v,onVerify:q=>{X(q)}}):e.jsx(e.Fragment,{})]})]}),e.jsx(je,{onCancel:()=>w(!1),visible:y,size:"small",centered:!0,onOk:oe,children:e.jsxs("div",{style:{marginTop:20},children:[e.jsx(se,{name:"set_new_password",placeholder:"新密码",value:a.set_new_password,onChange:q=>C("set_new_password",q)}),e.jsx(se,{style:{marginTop:20},name:"set_new_password_confirmation",placeholder:"确认新密码",value:a.set_new_password_confirmation,onChange:q=>C("set_new_password_confirmation",q)}),_?e.jsx(lu,{sitekey:v,onVerify:q=>{X(q)}}):e.jsx(e.Fragment,{})]})})]})]})})})};function $n(u){const[s,c]=t.useState(!1),[a,l]=t.useState({TopUpLink:"",ChatLink:"",ChatLink2:"",QuotaPerUnit:"",RetryTimes:"",DisplayInCurrencyEnabled:!1,DisplayTokenStatEnabled:!1,DefaultCollapseSidebar:!1}),r=t.useRef(),[F,y]=t.useState(a);function w(o,i){const x=i.target.id;l(k=>({...k,[x]:o}))}function h(){const o=Je(a,F);if(!o.length)return Qe("你似乎并没有修改什么");const i=o.map(x=>{let k="";return typeof a[x.key]=="boolean"?k=String(a[x.key]):k=a[x.key],R.put("/api/option/",{key:x.key,value:k})});c(!0),Promise.all(i).then(x=>{if(i.length===1){if(x.includes(void 0))return}else if(i.length>1&&x.includes(void 0))return E("部分保存失败，请重试");J("保存成功"),u.refresh()}).catch(()=>{E("保存失败，请重试")}).finally(()=>{c(!1)})}return t.useEffect(()=>{const o={};for(let i in u.options)Object.keys(a).includes(i)&&(o[i]=u.options[i]);l(o),y(structuredClone(o)),r.current.setValues(o)},[u.options]),e.jsx(e.Fragment,{children:e.jsx(De,{spinning:s,children:e.jsx(N,{values:a,getFormApi:o=>r.current=o,style:{marginBottom:15},children:e.jsxs(N.Section,{text:"通用设置",children:[e.jsxs(ge,{gutter:16,children:[e.jsx(ce,{span:8,children:e.jsx(N.Input,{field:"TopUpLink",label:"充值链接",initValue:"",placeholder:"例如发卡网站的购买链接",onChange:w,showClear:!0})}),e.jsx(ce,{span:8,children:e.jsx(N.Input,{field:"ChatLink",label:"默认聊天页面链接",initValue:"",placeholder:"例如 ChatGPT Next Web 的部署地址",onChange:w,showClear:!0})}),e.jsx(ce,{span:8,children:e.jsx(N.Input,{field:"ChatLink2",label:"聊天页面 2 链接",initValue:"",placeholder:"例如 ChatGPT Next Web 的部署地址",onChange:w,showClear:!0})}),e.jsx(ce,{span:8,children:e.jsx(N.Input,{field:"QuotaPerUnit",label:"单位美元额度",initValue:"",placeholder:"一单位货币能兑换的额度",onChange:w,showClear:!0})}),e.jsx(ce,{span:8,children:e.jsx(N.Input,{field:"RetryTimes",label:"失败重试次数",initValue:"",placeholder:"失败重试次数",onChange:w,showClear:!0})})]}),e.jsxs(ge,{gutter:16,children:[e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"DisplayInCurrencyEnabled",label:"以货币形式显示额度",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:o=>{l({...a,DisplayInCurrencyEnabled:o})}})}),e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"DisplayTokenStatEnabled",label:"Billing 相关 API 显示令牌额度而非用户额度",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:o=>l({...a,DisplayTokenStatEnabled:o})})}),e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"DefaultCollapseSidebar",label:"默认折叠侧边栏",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:o=>l({...a,DefaultCollapseSidebar:o})})})]}),e.jsx(ge,{children:e.jsx(I,{size:"large",onClick:h,children:"保存通用设置"})})]})})})})}function Rn(u){const[s,c]=t.useState(!1),[a,l]=t.useState({DrawingEnabled:!1,MjNotifyEnabled:!1,MjAccountFilterEnabled:!1,MjForwardUrlEnabled:!1,MjModeClearEnabled:!1}),r=t.useRef(),[F,y]=t.useState(a);function w(){const h=Je(a,F);if(!h.length)return Qe("你似乎并没有修改什么");const o=h.map(i=>{let x="";return typeof a[i.key]=="boolean"?x=String(a[i.key]):x=a[i.key],R.put("/api/option/",{key:i.key,value:x})});c(!0),Promise.all(o).then(i=>{if(o.length===1){if(i.includes(void 0))return}else if(o.length>1&&i.includes(void 0))return E("部分保存失败，请重试");J("保存成功"),u.refresh()}).catch(()=>{E("保存失败，请重试")}).finally(()=>{c(!1)})}return t.useEffect(()=>{const h={};for(let o in u.options)Object.keys(a).includes(o)&&(h[o]=u.options[o]);l(h),y(structuredClone(h)),r.current.setValues(h),localStorage.setItem("mj_notify_enabled",String(a.MjNotifyEnabled))},[u.options]),e.jsx(e.Fragment,{children:e.jsx(De,{spinning:s,children:e.jsx(N,{values:a,getFormApi:h=>r.current=h,style:{marginBottom:15},children:e.jsxs(N.Section,{text:"绘图设置",children:[e.jsxs(ge,{gutter:16,children:[e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"DrawingEnabled",label:"启用绘图功能",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:h=>{l({...a,DrawingEnabled:h})}})}),e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"MjNotifyEnabled",label:"允许回调（会泄露服务器 IP 地址）",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:h=>l({...a,MjNotifyEnabled:h})})}),e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"MjAccountFilterEnabled",label:"允许 AccountFilter 参数",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:h=>l({...a,MjAccountFilterEnabled:h})})}),e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"MjForwardUrlEnabled",label:"开启之后将上游地址替换为服务器地址",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:h=>l({...a,MjForwardUrlEnabled:h})})}),e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"MjModeClearEnabled",label:e.jsxs(e.Fragment,{children:["开启之后会清除用户提示词中的 ",e.jsx(z,{children:"--fast"})," 、",e.jsx(z,{children:"--relax"})," 以及 ",e.jsx(z,{children:"--turbo"})," 参数"]}),size:"large",checkedText:"｜",uncheckedText:"〇",onChange:h=>l({...a,MjModeClearEnabled:h})})})]}),e.jsx(ge,{children:e.jsx(I,{size:"large",onClick:w,children:"保存绘图设置"})})]})})})})}function Ln(u){const[s,c]=t.useState(!1),[a,l]=t.useState({CheckSensitiveEnabled:!1,CheckSensitiveOnPromptEnabled:!1,SensitiveWords:""}),r=t.useRef(),[F,y]=t.useState(a);function w(){const h=Je(a,F);if(!h.length)return Qe("你似乎并没有修改什么");const o=h.map(i=>{let x="";return typeof a[i.key]=="boolean"?x=String(a[i.key]):x=a[i.key],R.put("/api/option/",{key:i.key,value:x})});c(!0),Promise.all(o).then(i=>{if(o.length===1){if(i.includes(void 0))return}else if(o.length>1&&i.includes(void 0))return E("部分保存失败，请重试");J("保存成功"),u.refresh()}).catch(()=>{E("保存失败，请重试")}).finally(()=>{c(!1)})}return t.useEffect(()=>{const h={};for(let o in u.options)Object.keys(a).includes(o)&&(h[o]=u.options[o]);l(h),y(structuredClone(h)),r.current.setValues(h)},[u.options]),e.jsx(e.Fragment,{children:e.jsx(De,{spinning:s,children:e.jsx(N,{values:a,getFormApi:h=>r.current=h,style:{marginBottom:15},children:e.jsxs(N.Section,{text:"屏蔽词过滤设置",children:[e.jsxs(ge,{gutter:16,children:[e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"CheckSensitiveEnabled",label:"启用屏蔽词过滤功能",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:h=>{l({...a,CheckSensitiveEnabled:h})}})}),e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"CheckSensitiveOnPromptEnabled",label:"启用 Prompt 检查",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:h=>l({...a,CheckSensitiveOnPromptEnabled:h})})})]}),e.jsx(ge,{children:e.jsx(ce,{span:16,children:e.jsx(N.TextArea,{label:"屏蔽词列表",extraText:"一行一个屏蔽词，不需要符号分割",placeholder:"一行一个屏蔽词，不需要符号分割",field:"SensitiveWords",onChange:h=>l({...a,SensitiveWords:h}),style:{fontFamily:"JetBrains Mono, Consolas"},autosize:{minRows:6,maxRows:12}})})}),e.jsx(ge,{children:e.jsx(I,{size:"large",onClick:w,children:"保存屏蔽词过滤设置"})})]})})})})}var yt={exports:{}};(function(u,s){(function(c,a){u.exports=a()})(wt,function(){var c=1e3,a=6e4,l=36e5,r="millisecond",F="second",y="minute",w="hour",h="day",o="week",i="month",x="quarter",k="year",$="date",_="Invalid Date",L=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,v=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,H={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(j){var b=["th","st","nd","rd"],n=j%100;return"["+j+(b[(n-20)%10]||b[n]||b[0])+"]"}},Q=function(j,b,n){var d=String(j);return!d||d.length>=b?j:""+Array(b+1-d.length).join(n)+j},X={s:Q,z:function(j){var b=-j.utcOffset(),n=Math.abs(b),d=Math.floor(n/60),p=n%60;return(b<=0?"+":"-")+Q(d,2,"0")+":"+Q(p,2,"0")},m:function j(b,n){if(b.date()<n.date())return-j(n,b);var d=12*(n.year()-b.year())+(n.month()-b.month()),p=b.clone().add(d,i),S=n-p<0,g=b.clone().add(d+(S?-1:1),i);return+(-(d+(n-p)/(S?p-g:g-p))||0)},a:function(j){return j<0?Math.ceil(j)||0:Math.floor(j)},p:function(j){return{M:i,y:k,w:o,d:h,D:$,h:w,m:y,s:F,ms:r,Q:x}[j]||String(j||"").toLowerCase().replace(/s$/,"")},u:function(j){return j===void 0}},K="en",Y={};Y[K]=H;var Z="$isDayjsObject",te=function(j){return j instanceof P||!(!j||!j[Z])},G=function j(b,n,d){var p;if(!b)return K;if(typeof b=="string"){var S=b.toLowerCase();Y[S]&&(p=S),n&&(Y[S]=n,p=S);var g=b.split("-");if(!p&&g.length>1)return j(g[0])}else{var C=b.name;Y[C]=b,p=C}return!d&&p&&(K=p),p||!d&&K},A=function(j,b){if(te(j))return j.clone();var n=typeof b=="object"?b:{};return n.date=j,n.args=arguments,new P(n)},f=X;f.l=G,f.i=te,f.w=function(j,b){return A(j,{locale:b.$L,utc:b.$u,x:b.$x,$offset:b.$offset})};var P=function(){function j(n){this.$L=G(n.locale,null,!0),this.parse(n),this.$x=this.$x||n.x||{},this[Z]=!0}var b=j.prototype;return b.parse=function(n){this.$d=function(d){var p=d.date,S=d.utc;if(p===null)return new Date(NaN);if(f.u(p))return new Date;if(p instanceof Date)return new Date(p);if(typeof p=="string"&&!/Z$/i.test(p)){var g=p.match(L);if(g){var C=g[2]-1||0,m=(g[7]||"0").substring(0,3);return S?new Date(Date.UTC(g[1],C,g[3]||1,g[4]||0,g[5]||0,g[6]||0,m)):new Date(g[1],C,g[3]||1,g[4]||0,g[5]||0,g[6]||0,m)}}return new Date(p)}(n),this.init()},b.init=function(){var n=this.$d;this.$y=n.getFullYear(),this.$M=n.getMonth(),this.$D=n.getDate(),this.$W=n.getDay(),this.$H=n.getHours(),this.$m=n.getMinutes(),this.$s=n.getSeconds(),this.$ms=n.getMilliseconds()},b.$utils=function(){return f},b.isValid=function(){return this.$d.toString()!==_},b.isSame=function(n,d){var p=A(n);return this.startOf(d)<=p&&p<=this.endOf(d)},b.isAfter=function(n,d){return A(n)<this.startOf(d)},b.isBefore=function(n,d){return this.endOf(d)<A(n)},b.$g=function(n,d,p){return f.u(n)?this[d]:this.set(p,n)},b.unix=function(){return Math.floor(this.valueOf()/1e3)},b.valueOf=function(){return this.$d.getTime()},b.startOf=function(n,d){var p=this,S=!!f.u(d)||d,g=f.p(n),C=function(re,oe){var Be=f.w(p.$u?Date.UTC(p.$y,oe,re):new Date(p.$y,oe,re),p);return S?Be:Be.endOf(h)},m=function(re,oe){return f.w(p.toDate()[re].apply(p.toDate("s"),(S?[0,0,0,0]:[23,59,59,999]).slice(oe)),p)},M=this.$W,V=this.$M,D=this.$D,U="set"+(this.$u?"UTC":"");switch(g){case k:return S?C(1,0):C(31,11);case i:return S?C(1,V):C(0,V+1);case o:var ee=this.$locale().weekStart||0,ae=(M<ee?M+7:M)-ee;return C(S?D-ae:D+(6-ae),V);case h:case $:return m(U+"Hours",0);case w:return m(U+"Minutes",1);case y:return m(U+"Seconds",2);case F:return m(U+"Milliseconds",3);default:return this.clone()}},b.endOf=function(n){return this.startOf(n,!1)},b.$set=function(n,d){var p,S=f.p(n),g="set"+(this.$u?"UTC":""),C=(p={},p[h]=g+"Date",p[$]=g+"Date",p[i]=g+"Month",p[k]=g+"FullYear",p[w]=g+"Hours",p[y]=g+"Minutes",p[F]=g+"Seconds",p[r]=g+"Milliseconds",p)[S],m=S===h?this.$D+(d-this.$W):d;if(S===i||S===k){var M=this.clone().set($,1);M.$d[C](m),M.init(),this.$d=M.set($,Math.min(this.$D,M.daysInMonth())).$d}else C&&this.$d[C](m);return this.init(),this},b.set=function(n,d){return this.clone().$set(n,d)},b.get=function(n){return this[f.p(n)]()},b.add=function(n,d){var p,S=this;n=Number(n);var g=f.p(d),C=function(V){var D=A(S);return f.w(D.date(D.date()+Math.round(V*n)),S)};if(g===i)return this.set(i,this.$M+n);if(g===k)return this.set(k,this.$y+n);if(g===h)return C(1);if(g===o)return C(7);var m=(p={},p[y]=a,p[w]=l,p[F]=c,p)[g]||1,M=this.$d.getTime()+n*m;return f.w(M,this)},b.subtract=function(n,d){return this.add(-1*n,d)},b.format=function(n){var d=this,p=this.$locale();if(!this.isValid())return p.invalidDate||_;var S=n||"YYYY-MM-DDTHH:mm:ssZ",g=f.z(this),C=this.$H,m=this.$m,M=this.$M,V=p.weekdays,D=p.months,U=p.meridiem,ee=function(oe,Be,Te,Me){return oe&&(oe[Be]||oe(d,S))||Te[Be].slice(0,Me)},ae=function(oe){return f.s(C%12||12,oe,"0")},re=U||function(oe,Be,Te){var Me=oe<12?"AM":"PM";return Te?Me.toLowerCase():Me};return S.replace(v,function(oe,Be){return Be||function(Te){switch(Te){case"YY":return String(d.$y).slice(-2);case"YYYY":return f.s(d.$y,4,"0");case"M":return M+1;case"MM":return f.s(M+1,2,"0");case"MMM":return ee(p.monthsShort,M,D,3);case"MMMM":return ee(D,M);case"D":return d.$D;case"DD":return f.s(d.$D,2,"0");case"d":return String(d.$W);case"dd":return ee(p.weekdaysMin,d.$W,V,2);case"ddd":return ee(p.weekdaysShort,d.$W,V,3);case"dddd":return V[d.$W];case"H":return String(C);case"HH":return f.s(C,2,"0");case"h":return ae(1);case"hh":return ae(2);case"a":return re(C,m,!0);case"A":return re(C,m,!1);case"m":return String(m);case"mm":return f.s(m,2,"0");case"s":return String(d.$s);case"ss":return f.s(d.$s,2,"0");case"SSS":return f.s(d.$ms,3,"0");case"Z":return g}return null}(oe)||g.replace(":","")})},b.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},b.diff=function(n,d,p){var S,g=this,C=f.p(d),m=A(n),M=(m.utcOffset()-this.utcOffset())*a,V=this-m,D=function(){return f.m(g,m)};switch(C){case k:S=D()/12;break;case i:S=D();break;case x:S=D()/3;break;case o:S=(V-M)/6048e5;break;case h:S=(V-M)/864e5;break;case w:S=V/l;break;case y:S=V/a;break;case F:S=V/c;break;default:S=V}return p?S:f.a(S)},b.daysInMonth=function(){return this.endOf(i).$D},b.$locale=function(){return Y[this.$L]},b.locale=function(n,d){if(!n)return this.$L;var p=this.clone(),S=G(n,d,!0);return S&&(p.$L=S),p},b.clone=function(){return f.w(this.$d,this)},b.toDate=function(){return new Date(this.valueOf())},b.toJSON=function(){return this.isValid()?this.toISOString():null},b.toISOString=function(){return this.$d.toISOString()},b.toString=function(){return this.$d.toUTCString()},j}(),B=P.prototype;return A.prototype=B,[["$ms",r],["$s",F],["$m",y],["$H",w],["$W",h],["$M",i],["$y",k],["$D",$]].forEach(function(j){B[j[1]]=function(b){return this.$g(b,j[0],j[1])}}),A.extend=function(j,b){return j.$i||(j(b,P,A),j.$i=!0),A},A.locale=G,A.isDayjs=te,A.unix=function(j){return A(1e3*j)},A.en=Y[K],A.Ls=Y,A.p={},A})})(yt);var On=yt.exports;const zn=vt(On);function Nn(u){const[s,c]=t.useState(!1),[a,l]=t.useState(!1),[r,F]=t.useState({LogConsumeEnabled:!1,historyTimestamp:zn().subtract(1,"month").toDate()}),y=t.useRef(),[w,h]=t.useState(r);function o(){const x=Je(r,w).filter($=>$.key!=="historyTimestamp");if(!x.length)return Qe("你似乎并没有修改什么");const k=x.map($=>{let _="";return typeof r[$.key]=="boolean"?_=String(r[$.key]):_=r[$.key],R.put("/api/option/",{key:$.key,value:_})});c(!0),Promise.all(k).then($=>{if(k.length===1){if($.includes(void 0))return}else if(k.length>1&&$.includes(void 0))return E("部分保存失败，请重试");J("保存成功"),u.refresh()}).catch(()=>{E("保存失败，请重试")}).finally(()=>{c(!1)})}async function i(){try{if(l(!0),!r.historyTimestamp)throw new Error("请选择日志记录时间");const x=await R.delete(`/api/log/?target_timestamp=${Date.parse(r.historyTimestamp)/1e3}`),{success:k,message:$,data:_}=x.data;if(k){J(`${_} 条日志已清理！`);return}else throw new Error("日志清理失败："+$)}catch(x){E(x.message)}finally{l(!1)}}return t.useEffect(()=>{const x={};for(let k in u.options)Object.keys(r).includes(k)&&(x[k]=u.options[k]);x.historyTimestamp=r.historyTimestamp,F(Object.assign(r,x)),h(structuredClone(x)),y.current.setValues(x)},[u.options]),e.jsx(e.Fragment,{children:e.jsx(De,{spinning:s,children:e.jsx(N,{values:r,getFormApi:x=>y.current=x,style:{marginBottom:15},children:e.jsxs(N.Section,{text:"日志设置",children:[e.jsxs(ge,{gutter:16,children:[e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"LogConsumeEnabled",label:"启用额度消费日志记录",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:x=>{F({...r,LogConsumeEnabled:x})}})}),e.jsx(ce,{span:8,children:e.jsxs(De,{spinning:a,children:[e.jsx(N.DatePicker,{label:"日志记录时间",field:"historyTimestamp",type:"dateTime",inputReadOnly:!0,onChange:x=>{F({...r,historyTimestamp:x})}}),e.jsx(I,{size:"default",onClick:i,children:"清除历史日志"})]})})]}),e.jsx(ge,{children:e.jsx(I,{size:"large",onClick:o,children:"保存日志设置"})})]})})})})}function Un(u){const s=[{key:"hour",label:"小时",value:"hour"},{key:"day",label:"天",value:"day"},{key:"week",label:"周",value:"week"}],[c,a]=t.useState(!1),[l,r]=t.useState({DataExportEnabled:!1,DataExportInterval:"",DataExportDefaultTime:""}),F=t.useRef(),[y,w]=t.useState(l);function h(){const o=Je(l,y);if(!o.length)return Qe("你似乎并没有修改什么");const i=o.map(x=>{let k="";return typeof l[x.key]=="boolean"?k=String(l[x.key]):k=l[x.key],R.put("/api/option/",{key:x.key,value:k})});a(!0),Promise.all(i).then(x=>{if(i.length===1){if(x.includes(void 0))return}else if(i.length>1&&x.includes(void 0))return E("部分保存失败，请重试");J("保存成功"),u.refresh()}).catch(()=>{E("保存失败，请重试")}).finally(()=>{a(!1)})}return t.useEffect(()=>{const o={};for(let i in u.options)Object.keys(l).includes(i)&&(o[i]=u.options[i]);r(o),w(structuredClone(o)),F.current.setValues(o),localStorage.setItem("data_export_default_time",String(l.DataExportDefaultTime))},[u.options]),e.jsx(e.Fragment,{children:e.jsx(De,{spinning:c,children:e.jsx(N,{values:l,getFormApi:o=>F.current=o,style:{marginBottom:15},children:e.jsxs(N.Section,{text:"数据看板设置",children:[e.jsx(ge,{gutter:16,children:e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"DataExportEnabled",label:"启用数据看板（实验性）",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:o=>{r({...l,DataExportEnabled:o})}})})}),e.jsxs(ge,{children:[e.jsx(ce,{span:8,children:e.jsx(N.InputNumber,{label:"数据看板更新间隔 ",step:1,min:1,suffix:"分钟",extraText:"设置过短会影响数据库性能",placeholder:"数据看板更新间隔",field:"DataExportInterval",onChange:o=>r({...l,DataExportInterval:String(o)})})}),e.jsx(ce,{span:8,children:e.jsx(N.Select,{label:"数据看板默认时间粒度",optionList:s,field:"DataExportDefaultTime",extraText:"仅修改展示粒度，统计精确到小时",placeholder:"数据看板默认时间粒度",style:{width:180},onChange:o=>r({...l,DataExportDefaultTime:String(o)})})})]}),e.jsx(ge,{children:e.jsx(I,{size:"large",onClick:h,children:"保存数据看板设置"})})]})})})})}function Wn(u){const[s,c]=t.useState(!1),[a,l]=t.useState({ChannelDisableThreshold:"",QuotaRemindThreshold:"",AutomaticDisableChannelEnabled:!1,AutomaticEnableChannelEnabled:!1}),r=t.useRef(),[F,y]=t.useState(a);function w(){const h=Je(a,F);if(!h.length)return Qe("你似乎并没有修改什么");const o=h.map(i=>{let x="";return typeof a[i.key]=="boolean"?x=String(a[i.key]):x=a[i.key],R.put("/api/option/",{key:i.key,value:x})});c(!0),Promise.all(o).then(i=>{if(o.length===1){if(i.includes(void 0))return}else if(o.length>1&&i.includes(void 0))return E("部分保存失败，请重试");J("保存成功"),u.refresh()}).catch(()=>{E("保存失败，请重试")}).finally(()=>{c(!1)})}return t.useEffect(()=>{const h={};for(let o in u.options)Object.keys(a).includes(o)&&(h[o]=u.options[o]);l(h),y(structuredClone(h)),r.current.setValues(h)},[u.options]),e.jsx(e.Fragment,{children:e.jsx(De,{spinning:s,children:e.jsx(N,{values:a,getFormApi:h=>r.current=h,style:{marginBottom:15},children:e.jsxs(N.Section,{text:"监控设置",children:[e.jsxs(ge,{gutter:16,children:[e.jsx(ce,{span:8,children:e.jsx(N.InputNumber,{label:"最长响应时间",step:1,min:0,suffix:"秒",extraText:"当运行通道全部测试时，超过此时间将自动禁用通道",placeholder:"",field:"ChannelDisableThreshold",onChange:h=>l({...a,ChannelDisableThreshold:String(h)})})}),e.jsx(ce,{span:8,children:e.jsx(N.InputNumber,{label:"额度提醒阈值",step:1,min:0,suffix:"Token",extraText:"低于此额度时将发送邮件提醒用户",placeholder:"",field:"QuotaRemindThreshold",onChange:h=>l({...a,QuotaRemindThreshold:String(h)})})})]}),e.jsxs(ge,{gutter:16,children:[e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"AutomaticDisableChannelEnabled",label:"失败时自动禁用通道",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:h=>{l({...a,AutomaticDisableChannelEnabled:h})}})}),e.jsx(ce,{span:8,children:e.jsx(N.Switch,{field:"AutomaticEnableChannelEnabled",label:"成功时自动启用通道",size:"large",checkedText:"｜",uncheckedText:"〇",onChange:h=>l({...a,AutomaticEnableChannelEnabled:h})})})]}),e.jsx(ge,{children:e.jsx(I,{size:"large",onClick:w,children:"保存监控设置"})})]})})})})}function Gn(u){const[s,c]=t.useState(!1),[a,l]=t.useState({QuotaForNewUser:"",PreConsumedQuota:"",QuotaForInviter:"",QuotaForInvitee:""}),r=t.useRef(),[F,y]=t.useState(a);function w(){const h=Je(a,F);if(!h.length)return Qe("你似乎并没有修改什么");const o=h.map(i=>{let x="";return typeof a[i.key]=="boolean"?x=String(a[i.key]):x=a[i.key],R.put("/api/option/",{key:i.key,value:x})});c(!0),Promise.all(o).then(i=>{if(o.length===1){if(i.includes(void 0))return}else if(o.length>1&&i.includes(void 0))return E("部分保存失败，请重试");J("保存成功"),u.refresh()}).catch(()=>{E("保存失败，请重试")}).finally(()=>{c(!1)})}return t.useEffect(()=>{const h={};for(let o in u.options)Object.keys(a).includes(o)&&(h[o]=u.options[o]);l(h),y(structuredClone(h)),r.current.setValues(h)},[u.options]),e.jsx(e.Fragment,{children:e.jsx(De,{spinning:s,children:e.jsx(N,{values:a,getFormApi:h=>r.current=h,style:{marginBottom:15},children:e.jsxs(N.Section,{text:"额度设置",children:[e.jsxs(ge,{gutter:16,children:[e.jsx(ce,{span:6,children:e.jsx(N.InputNumber,{label:"新用户初始额度",field:"QuotaForNewUser",step:1,min:0,suffix:"Token",placeholder:"",onChange:h=>l({...a,QuotaForNewUser:String(h)})})}),e.jsx(ce,{span:6,children:e.jsx(N.InputNumber,{label:"请求预扣费额度",field:"PreConsumedQuota",step:1,min:0,suffix:"Token",extraText:"请求结束后多退少补",placeholder:"",onChange:h=>l({...a,PreConsumedQuota:String(h)})})}),e.jsx(ce,{span:6,children:e.jsx(N.InputNumber,{label:"邀请新用户奖励额度",field:"QuotaForInviter",step:1,min:0,suffix:"Token",extraText:"",placeholder:"例如：2000",onChange:h=>l({...a,QuotaForInviter:String(h)})})}),e.jsx(ce,{span:6,children:e.jsx(N.InputNumber,{label:"新用户使用邀请码奖励额度",field:"QuotaForInvitee",step:1,min:0,suffix:"Token",extraText:"",placeholder:"例如：1000",onChange:h=>l({...a,QuotaForInvitee:String(h)})})})]}),e.jsx(ge,{children:e.jsx(I,{size:"large",onClick:w,children:"保存额度设置"})})]})})})})}function Hn(u){const[s,c]=t.useState(!1),[a,l]=t.useState({ModelPrice:"",ModelRatio:"",CompletionRatio:"",GroupRatio:""}),r=t.useRef(),[F,y]=t.useState(a);async function w(){try{console.log("Starting validation..."),await r.current.validate().then(()=>{console.log("Validation passed");const o=Je(a,F);if(!o.length)return Qe("你似乎并没有修改什么");const i=o.map(x=>{let k="";return typeof a[x.key]=="boolean"?k=String(a[x.key]):k=a[x.key],R.put("/api/option/",{key:x.key,value:k})});c(!0),Promise.all(i).then(x=>{if(i.length===1){if(x.includes(void 0))return}else if(i.length>1&&x.includes(void 0))return E("部分保存失败，请重试");J("保存成功"),u.refresh()}).catch(()=>{E("保存失败，请重试")}).finally(()=>{c(!1)})}).catch(o=>{console.error("Validation failed:",o),E("请检查输入")})}catch(o){E("请检查输入"),console.error(o)}}async function h(){try{let o=await R.post("/api/option/rest_model_ratio");o.data.success?(J(o.data.message),u.refresh()):E(o.data.message)}catch(o){E(o)}}return t.useEffect(()=>{const o={};for(let i in u.options)Object.keys(a).includes(i)&&(o[i]=u.options[i]);l(o),y(structuredClone(o)),r.current.setValues(o)},[u.options]),e.jsxs(De,{spinning:s,children:[e.jsx(N,{values:a,getFormApi:o=>r.current=o,style:{marginBottom:15},children:e.jsxs(N.Section,{text:"倍率设置",children:[e.jsx(ge,{gutter:16,children:e.jsx(ce,{span:16,children:e.jsx(N.TextArea,{label:"模型固定价格",extraText:"一次调用消耗多少刀，优先级大于模型倍率",placeholder:'为一个 JSON 文本，键为模型名称，值为一次调用消耗多少刀，比如 "gpt-4-gizmo-*": 0.1，一次消耗0.1刀',field:"ModelPrice",autosize:{minRows:6,maxRows:12},trigger:"blur",stopValidateWithError:!0,rules:[{validator:(o,i)=>iu(i),message:"不是合法的 JSON 字符串"}],onChange:o=>l({...a,ModelPrice:o})})})}),e.jsx(ge,{gutter:16,children:e.jsx(ce,{span:16,children:e.jsx(N.TextArea,{label:"模型倍率",extraText:"",placeholder:"为一个 JSON 文本，键为模型名称，值为倍率",field:"ModelRatio",autosize:{minRows:6,maxRows:12},trigger:"blur",stopValidateWithError:!0,rules:[{validator:(o,i)=>iu(i),message:"不是合法的 JSON 字符串"}],onChange:o=>l({...a,ModelRatio:o})})})}),e.jsx(ge,{gutter:16,children:e.jsx(ce,{span:16,children:e.jsx(N.TextArea,{label:"模型补全倍率（仅对自定义模型有效）",extraText:"仅对自定义模型有效",placeholder:"为一个 JSON 文本，键为模型名称，值为倍率",field:"CompletionRatio",autosize:{minRows:6,maxRows:12},trigger:"blur",stopValidateWithError:!0,rules:[{validator:(o,i)=>iu(i),message:"不是合法的 JSON 字符串"}],onChange:o=>l({...a,CompletionRatio:o})})})}),e.jsx(ge,{gutter:16,children:e.jsx(ce,{span:16,children:e.jsx(N.TextArea,{label:"分组倍率",extraText:"",placeholder:"为一个 JSON 文本，键为分组名称，值为倍率",field:"GroupRatio",autosize:{minRows:6,maxRows:12},trigger:"blur",stopValidateWithError:!0,rules:[{validator:(o,i)=>iu(i),message:"不是合法的 JSON 字符串"}],onChange:o=>l({...a,GroupRatio:o})})})})]})}),e.jsxs(de,{children:[e.jsx(I,{onClick:w,children:"保存倍率设置"}),e.jsx(we,{title:"确定重置模型倍率吗？",content:"此修改将不可逆",okType:"danger",position:"top",onConfirm:()=>{h()},children:e.jsx(I,{type:"danger",children:"重置模型倍率"})})]})]})}const qn=()=>{let[u,s]=t.useState({QuotaForNewUser:0,QuotaForInviter:0,QuotaForInvitee:0,QuotaRemindThreshold:0,PreConsumedQuota:0,StreamCacheQueueLength:0,ModelRatio:"",CompletionRatio:"",ModelPrice:"",GroupRatio:"",TopUpLink:"",ChatLink:"",ChatLink2:"",QuotaPerUnit:0,AutomaticDisableChannelEnabled:!1,AutomaticEnableChannelEnabled:!1,ChannelDisableThreshold:0,LogConsumeEnabled:!1,DisplayInCurrencyEnabled:!1,DisplayTokenStatEnabled:!1,CheckSensitiveEnabled:!1,CheckSensitiveOnPromptEnabled:!1,CheckSensitiveOnCompletionEnabled:"",StopOnSensitiveEnabled:"",SensitiveWords:"",MjNotifyEnabled:!1,MjAccountFilterEnabled:!1,MjModeClearEnabled:!1,MjForwardUrlEnabled:!1,DrawingEnabled:!1,DataExportEnabled:!1,DataExportDefaultTime:"hour",DataExportInterval:5,DefaultCollapseSidebar:!1,RetryTimes:0}),[c,a]=t.useState(!1);const l=async()=>{const F=await R.get("/api/option/"),{success:y,message:w,data:h}=F.data;if(y){let o={};h.forEach(i=>{(i.key==="ModelRatio"||i.key==="GroupRatio"||i.key==="CompletionRatio"||i.key==="ModelPrice")&&(i.value=JSON.stringify(JSON.parse(i.value),null,2)),i.key.endsWith("Enabled")||["DefaultCollapseSidebar"].includes(i.key)?o[i.key]=i.value==="true":o[i.key]=i.value}),s(o)}else E(w)};async function r(){try{a(!0),await l(),J("刷新成功")}catch{E("刷新失败")}finally{a(!1)}}return t.useEffect(()=>{r()},[]),e.jsx(e.Fragment,{children:e.jsxs(De,{spinning:c,size:"large",children:[e.jsx(Se,{style:{marginTop:"10px"},children:e.jsx($n,{options:u,refresh:r})}),e.jsx(Se,{style:{marginTop:"10px"},children:e.jsx(Rn,{options:u,refresh:r})}),e.jsx(Se,{style:{marginTop:"10px"},children:e.jsx(Ln,{options:u,refresh:r})}),e.jsx(Se,{style:{marginTop:"10px"},children:e.jsx(Nn,{options:u,refresh:r})}),e.jsx(Se,{style:{marginTop:"10px"},children:e.jsx(Un,{options:u,refresh:r})}),e.jsx(Se,{style:{marginTop:"10px"},children:e.jsx(Wn,{options:u,refresh:r})}),e.jsx(Se,{style:{marginTop:"10px"},children:e.jsx(Gn,{options:u,refresh:r})}),e.jsx(Se,{style:{marginTop:"10px"},children:e.jsx(Hn,{options:u,refresh:r})})]})})},Kn=()=>{const u=_e(),s=kt(),[c,a]=t.useState("1");let l=[{tab:"个人设置",content:e.jsx(Mn,{}),itemKey:"personal"}];ht()&&(l.push({tab:"运营设置",content:e.jsx(qn,{}),itemKey:"operation"}),l.push({tab:"系统设置",content:e.jsx(In,{}),itemKey:"system"}),l.push({tab:"其他设置",content:e.jsx(Pn,{}),itemKey:"other"}));const r=F=>{a(F),u(`?tab=${F}`)};return t.useEffect(()=>{const y=new URLSearchParams(window.location.search).get("tab");y?a(y):r("personal")},[s.search]),e.jsx("div",{children:e.jsx(le,{children:e.jsx(le.Content,{children:e.jsx($t,{type:"line",activeKey:c,onChange:F=>r(F),children:l.map(F=>e.jsx(Rt,{itemKey:F.itemKey,tab:F.tab,children:c===F.itemKey&&F.content},F.itemKey))})})})})},Vn=()=>{const[u,s]=t.useState({email:""}),{email:c}=u,[a,l]=t.useState(!1),[r,F]=t.useState(!1),[y,w]=t.useState(""),[h,o]=t.useState(""),[i,x]=t.useState(!1),[k,$]=t.useState(30);t.useEffect(()=>{let v=null;return i&&k>0?v=setInterval(()=>{$(k-1)},1e3):k===0&&(x(!1),$(30)),()=>clearInterval(v)},[i,k]);function _(v){const{name:H,value:Q}=v.target;s(X=>({...X,[H]:Q}))}async function L(v){if(x(!0),!c)return;if(r&&h===""){be("请稍后几秒重试，Turnstile 正在检查用户环境！");return}l(!0);const H=await R.get(`/api/reset_password?email=${c}&turnstile=${h}`),{success:Q,message:X}=H.data;Q?(J("重置邮件发送成功，请检查邮箱！"),s({...u,email:""})):E(X),l(!1)}return e.jsx(Ve,{textAlign:"center",style:{marginTop:"48px"},children:e.jsxs(Ve.Column,{style:{maxWidth:450},children:[e.jsxs(Ce,{as:"h2",color:"",textAlign:"center",children:[e.jsx(Nu,{src:"/logo.png"})," 密码重置"]}),e.jsx(W,{size:"large",children:e.jsxs(gu,{children:[e.jsx(W.Input,{fluid:!0,icon:"mail",iconPosition:"left",placeholder:"邮箱地址",name:"email",value:c,onChange:_}),r?e.jsx(lu,{sitekey:y,onVerify:v=>{o(v)}}):e.jsx(e.Fragment,{}),e.jsx(eu,{color:"green",fluid:!0,size:"large",onClick:L,loading:a,disabled:i,children:i?`重试 (${k})`:"提交"})]})})]})})},Qn=()=>{const[u,s]=bu(),[c,a]=t.useContext(Ge),[l,r]=t.useState("处理中...");t.useState(!0);let F=_e();const y=async(w,h,o)=>{let i=localStorage.getItem("aff");const x=await R.get(`/api/oauth/github?code=${w}&state=${h}&aff=${i}`),{success:k,message:$,data:_}=x.data;if(k)localStorage.removeItem("aff"),$==="bind"?(J("绑定成功！"),F("/setting")):(a({type:"login",payload:_}),localStorage.setItem("user",JSON.stringify(_)),J("登录成功！"),F("/"));else{E($);{r("操作失败，重定向至登录界面中..."),F("/setting");return}}};return t.useEffect(()=>{let w=u.get("error");if(w){let i=u.get("error_description");E(`授权错误：${w}: ${i}`),F("/setting");return}let h=u.get("code"),o=u.get("state");y(h,o).then()},[]),e.jsx(gu,{style:{minHeight:"300px"},children:e.jsx(lt,{active:!0,inverted:!0,children:e.jsx(ot,{size:"large",children:l})})})},Jn=()=>{const[u,s]=bu(),[c,a]=t.useContext(Ge),[l,r]=t.useState("处理中...");t.useState(!0);let F=_e();const y=async(w,h,o)=>{let i=localStorage.getItem("aff");const x=await R.get(`/api/oauth/linuxdo?code=${w}&state=${h}&aff=${i}`),{success:k,message:$,data:_}=x.data;if(k)localStorage.removeItem("aff"),$==="bind"?(J("绑定成功！"),F("/setting")):(a({type:"login",payload:_}),localStorage.setItem("user",JSON.stringify(_)),J("登录成功！"),F("/"));else{E($);{r("操作失败，重定向至登录界面中..."),F("/setting");return}}};return t.useEffect(()=>{let w=u.get("error");if(w){let i=u.get("error_description");E(`授权错误：${w}: ${i}`),F("/setting");return}let h=u.get("code"),o=u.get("state");y(h,o).then()},[]),e.jsx(gu,{style:{minHeight:"300px"},children:e.jsx(lt,{active:!0,inverted:!0,children:e.jsx(ot,{size:"large",children:l})})})},Yn=()=>{const[u,s]=t.useState({email:"",token:""}),{email:c,token:a}=u,[l,r]=t.useState(!1),[F,y]=t.useState(!1),[w,h]=t.useState(30),[o,i]=t.useState(""),[x,k]=bu();t.useEffect(()=>{let _=x.get("token"),L=x.get("email");s({token:_,email:L})},[]),t.useEffect(()=>{let _=null;return F&&w>0?_=setInterval(()=>{h(w-1)},1e3):w===0&&(y(!1),h(30)),()=>clearInterval(_)},[F,w]);async function $(_){if(y(!0),!c)return;r(!0);const L=await R.post("/api/user/reset",{email:c,token:a}),{success:v,message:H}=L.data;if(v){let Q=L.data.data;i(Q),await Le(Q),qu(`新密码已复制到剪贴板：${Q}`)}else E(H);r(!1)}return e.jsx(Ve,{textAlign:"center",style:{marginTop:"48px"},children:e.jsxs(Ve.Column,{style:{maxWidth:450},children:[e.jsxs(Ce,{as:"h2",color:"",textAlign:"center",children:[e.jsx(Nu,{src:"/logo.png"})," 密码重置确认"]}),e.jsx(W,{size:"large",children:e.jsxs(gu,{children:[e.jsx(W.Input,{fluid:!0,icon:"mail",iconPosition:"left",placeholder:"邮箱地址",name:"email",value:c,readOnly:!0}),o&&e.jsx(W.Input,{fluid:!0,icon:"lock",iconPosition:"left",placeholder:"新密码",name:"newPassword",value:o,readOnly:!0,onClick:_=>{_.target.select(),navigator.clipboard.writeText(o),qu(`密码已复制到剪贴板：${o}`)}}),e.jsx(eu,{color:"green",fluid:!0,size:"large",onClick:$,loading:l,disabled:F,children:F?"密码重置完成":"提交"})]})})]})})},Qu={"gpt-3.5-turbo-0301":"gpt-3.5-turbo","gpt-4-0314":"gpt-4","gpt-4-32k-0314":"gpt-4-32k"},Ju={400:"500"},Xn="1. 新建渠道时，请求通过当前浏览器发出；2. 编辑已有渠道，请求通过后端服务器发出";function Zn(u){switch(u){case 15:return"按照如下格式输入：APIKey|SecretKey";case 18:return"按照如下格式输入：APPID|APISecret|APIKey";case 22:return"按照如下格式输入：APIKey-AppId，例如：fastgpt-0sp2gtvfdgyi4k30jwlgwf1i-64f335d84283f05518e9e041";case 23:return"按照如下格式输入：AppId|SecretId|SecretKey";case 33:return"按照如下格式输入：Ak|Sk|Region";default:return"请输入渠道对应的鉴权密钥"}}const Lu=u=>{_e();const s=u.editingChannel.id,c=s!==void 0,[a,l]=t.useState(c),r=()=>{u.handleClose()},F={name:"",type:1,key:"",openai_organization:"",max_input_tokens:0,base_url:"",other:"",model_mapping:"",status_code_mapping:"",models:[],auto_ban:1,test_model:"",groups:["default"]},[y,w]=t.useState(!1),[h,o]=t.useState(!0),[i,x]=t.useState(F),[k,$]=t.useState([]),[_,L]=t.useState([]),[v,H]=t.useState([]),[Q,X]=t.useState([]),[K,Y]=t.useState([]),[Z,te]=t.useState(""),G=(n,d)=>{if(x(p=>({...p,[n]:d})),n==="type"){let p=[];switch(d){case 2:p=["mj_imagine","mj_variation","mj_reroll","mj_blend","mj_upscale","mj_describe","mj_uploads"];break;case 5:p=["swap_face","mj_imagine","mj_variation","mj_reroll","mj_blend","mj_upscale","mj_describe","mj_zoom","mj_shorten","mj_modal","mj_inpaint","mj_custom_zoom","mj_high_variation","mj_low_variation","mj_pan","mj_uploads"];break;default:p=_u(d);break}i.models.length===0&&x(S=>({...S,models:p})),X(p)}},A=async()=>{l(!0);let n=await R.get(`/api/channel/${s}`);if(n===void 0)return;const{success:d,message:p,data:S}=n.data;d?(S.models===""?S.models=[]:S.models=S.models.split(","),S.group===""?S.groups=[]:S.groups=S.group.split(","),S.model_mapping!==""&&(S.model_mapping=JSON.stringify(JSON.parse(S.model_mapping),null,2)),x(S),S.auto_ban===0?o(!1):o(!0),X(_u(S.type))):E(p),l(!1)},f=async n=>{var S,g;if(i.type!==1){E("仅支持 OpenAI 接口格式");return}l(!0);const d=i.models||[];let p=!1;if(c){const C=await R.get("/api/channel/fetch_models/"+s);C.data&&((S=C.data)!=null&&S.success)?d.push(...C.data.data):p=!0}else if(!(i!=null&&i.key))E("请填写密钥"),p=!0;else try{const m=`https://${new URL(i.base_url||"https://api.openai.com").hostname}/v1/models`,M=i.key,V=await rt.get(m,{headers:{Authorization:`Bearer ${M}`}});V.data&&((g=V.data)!=null&&g.success)?d.push(...es.data.data.map(D=>D.id)):p=!0}catch{p=!0}p?E("获取模型列表失败"):(G(n,Array.from(new Set(d))),J("获取模型列表成功")),l(!1)},P=async()=>{try{let n=await R.get("/api/channel/models"),d=n.data.data.map(p=>({label:p.id,value:p.id}));$(d),Y(n.data.data.map(p=>p.id)),X(n.data.data.filter(p=>p.id.startsWith("gpt-3")||p.id.startsWith("text-")).map(p=>p.id))}catch(n){E(n.message)}},B=async()=>{try{let n=await R.get("/api/group/");if(n===void 0)return;H(n.data.data.map(d=>({label:d,value:d})))}catch(n){E(n.message)}};t.useEffect(()=>{let n=[...k];i.models.forEach(d=>{n.find(p=>p.key===d)||n.push({label:d,value:d})}),L(n)},[k,i.models]),t.useEffect(()=>{if(P().then(),B().then(),c)A().then(()=>{});else{x(F);let n=_u(i.type);X(n),x(d=>({...d,models:n}))}},[u.editingChannel.id]);const j=async()=>{if(!c&&(i.name===""||i.key==="")){be("请填写渠道名称和渠道密钥！");return}if(i.models.length===0){be("请至少选择一个模型！");return}if(i.model_mapping!==""&&!iu(i.model_mapping)){be("模型映射必须是合法的 JSON 格式！");return}let n={...i};n.base_url&&n.base_url.endsWith("/")&&(n.base_url=n.base_url.slice(0,n.base_url.length-1)),n.type===3&&n.other===""&&(n.other="2023-06-01-preview"),n.type===18&&n.other===""&&(n.other="v2.1");let d;if(!Array.isArray(n.models)){E("提交失败，请勿重复提交！"),r();return}n.auto_ban=h?1:0,n.models=n.models.join(","),n.group=n.groups.join(","),c?d=await R.put("/api/channel/",{...n,id:parseInt(s)}):d=await R.post("/api/channel/",n);const{success:p,message:S}=d.data;p?(c?J("渠道更新成功！"):(J("渠道创建成功！"),x(F)),u.refresh(),u.handleClose()):E(S)},b=()=>{if(Z.trim()==="")return;const n=Z.split(",").map(g=>g.trim());let d=[...i.models],p=[..._],S=!1;n.forEach(g=>{g&&!d.includes(g)?(d.push(g),p.push({key:g,text:g,value:g})):g&&(E("某些模型已存在！"),S=!0)}),!S&&(L(p),te(""),G("models",d))};return e.jsx(e.Fragment,{children:e.jsx(mu,{maskClosable:!1,placement:c?"right":"left",title:e.jsx(uu,{level:3,children:c?"更新渠道信息":"创建新的渠道"}),headerStyle:{borderBottom:"1px solid var(--semi-color-border)"},bodyStyle:{borderBottom:"1px solid var(--semi-color-border)"},visible:u.visible,footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(de,{children:[e.jsx(I,{theme:"solid",size:"large",onClick:j,children:"提交"}),e.jsx(I,{theme:"solid",size:"large",type:"tertiary",onClick:r,children:"取消"})]})}),closeIcon:null,onCancel:()=>r(),width:ve()?"100%":600,children:e.jsxs(De,{spinning:a,children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"类型："})}),e.jsx(Ie,{name:"type",required:!0,optionList:Du,value:i.type,onChange:n=>G("type",n),style:{width:"50%"}}),i.type===3&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(We,{type:"warning",description:e.jsxs(e.Fragment,{children:["注意，",e.jsx("strong",{children:"模型部署名称必须和模型名称保持一致"}),"，因为 One API 会把请求体中的 model 参数替换为你的部署名称（模型名称中的点会被剔除），",e.jsx("a",{target:"_blank",href:"https://github.com/songquanpeng/one-api/issues/133?notification_referrer_id=NT_kwDOAmJSYrM2NjIwMzI3NDgyOjM5OTk4MDUw#issuecomment-1571602271",children:"图片演示"}),"。"]})})}),e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"AZURE_OPENAI_ENDPOINT："})}),e.jsx(se,{label:"AZURE_OPENAI_ENDPOINT",name:"azure_base_url",placeholder:"请输入 AZURE_OPENAI_ENDPOINT，例如：https://docs-test-001.openai.azure.com",onChange:n=>{G("base_url",n)},value:i.base_url,autoComplete:"new-password"}),e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"默认 API 版本："})}),e.jsx(se,{label:"默认 API 版本",name:"azure_other",placeholder:"请输入默认 API 版本，例如：2023-06-01-preview，该配置可以被实际的请求查询参数所覆盖",onChange:n=>{G("other",n)},value:i.other,autoComplete:"new-password"})]}),i.type===8&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(We,{type:"warning",description:e.jsx(e.Fragment,{children:"如果你对接的是上游One API或者New API等转发项目，请使用OpenAI类型，不要使用此类型，除非你知道你在做什么。"})})}),e.jsx("div",{style:{marginTop:10},children:e.jsxs(ue.Text,{strong:!0,children:["完整的 Base URL，支持变量","{model}","："]})}),e.jsx(se,{name:"base_url",placeholder:"请输入完整的URL，例如：https://api.openai.com/v1/chat/completions",onChange:n=>{G("base_url",n)},value:i.base_url,autoComplete:"new-password"})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"名称："})}),e.jsx(se,{required:!0,name:"name",placeholder:"请为渠道命名",onChange:n=>{G("name",n)},value:i.name,autoComplete:"new-password"}),e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"分组："})}),e.jsx(Ie,{placeholder:"请选择可以使用该渠道的分组",name:"groups",required:!0,multiple:!0,selection:!0,allowAdditions:!0,additionLabel:"请在系统设置页面编辑分组倍率以添加新的分组：",onChange:n=>{G("groups",n)},value:i.groups,autoComplete:"new-password",optionList:v}),i.type===18&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"模型版本："})}),e.jsx(se,{name:"other",placeholder:"请输入星火大模型版本，注意是接口地址中的版本号，例如：v2.1",onChange:n=>{G("other",n)},value:i.other,autoComplete:"new-password"})]}),i.type===21&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"知识库 ID："})}),e.jsx(se,{label:"知识库 ID",name:"other",placeholder:"请输入知识库 ID，例如：123456",onChange:n=>{G("other",n)},value:i.other,autoComplete:"new-password"})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"模型："})}),e.jsx(Ie,{placeholder:"请选择该渠道所支持的模型",name:"models",required:!0,multiple:!0,selection:!0,onChange:n=>{G("models",n)},value:i.models,autoComplete:"new-password",optionList:_}),e.jsxs("div",{style:{lineHeight:"40px",marginBottom:"12px"},children:[e.jsxs(de,{children:[e.jsx(I,{type:"primary",onClick:()=>{G("models",Q)},children:"填入相关模型"}),e.jsx(I,{type:"secondary",onClick:()=>{G("models",K)},children:"填入所有模型"}),e.jsx(Pe,{content:Xn,children:e.jsx(I,{type:"tertiary",onClick:()=>{f("models")},children:"获取模型列表"})}),e.jsx(I,{type:"warning",onClick:()=>{G("models",[])},children:"清除所有模型"})]}),e.jsx(se,{addonAfter:e.jsx(I,{type:"primary",onClick:b,children:"填入"}),placeholder:"输入自定义模型名称",value:Z,onChange:n=>{te(n.trim())}})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"模型重定向："})}),e.jsx(vu,{placeholder:`此项可选，用于修改请求体中的模型名称，为一个 JSON 字符串，键为请求中模型名称，值为要替换的模型名称，例如：
${JSON.stringify(Qu,null,2)}`,name:"model_mapping",onChange:n=>{G("model_mapping",n)},autosize:!0,value:i.model_mapping,autoComplete:"new-password"}),e.jsx(ue.Text,{style:{color:"rgba(var(--semi-blue-5), 1)",userSelect:"none",cursor:"pointer"},onClick:()=>{G("model_mapping",JSON.stringify(Qu,null,2))},children:"填入模板"}),e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"密钥："})}),y?e.jsx(vu,{label:"密钥",name:"key",required:!0,placeholder:"请输入密钥，一行一个",onChange:n=>{G("key",n)},value:i.key,style:{minHeight:150,fontFamily:"JetBrains Mono, Consolas"},autoComplete:"new-password"}):e.jsx(se,{label:"密钥",name:"key",required:!0,placeholder:Zn(i.type),onChange:n=>{G("key",n)},value:i.key,autoComplete:"new-password"}),i.type===1&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"组织："})}),e.jsx(se,{label:"组织，可选，不填则为默认组织",name:"openai_organization",placeholder:"请输入组织org-xxx",onChange:n=>{G("openai_organization",n)},value:i.openai_organization})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"默认测试模型："})}),e.jsx(se,{name:"test_model",placeholder:"不填则为模型列表第一个",onChange:n=>{G("test_model",n)},value:i.test_model}),e.jsx("div",{style:{marginTop:10,display:"flex"},children:e.jsxs(de,{children:[e.jsx(Iu,{name:"auto_ban",checked:h,onChange:()=>{o(!h)}}),e.jsx(ue.Text,{strong:!0,children:"是否自动禁用（仅当自动禁用开启时有效），关闭后不会自动禁用该渠道："})]})}),!c&&e.jsx("div",{style:{marginTop:10,display:"flex"},children:e.jsxs(de,{children:[e.jsx(Iu,{checked:y,label:"批量创建",name:"batch",onChange:()=>w(!y)}),e.jsx(ue.Text,{strong:!0,children:"批量创建"})]})}),i.type!==3&&i.type!==8&&i.type!==22&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"代理："})}),e.jsx(se,{label:"代理",name:"base_url",placeholder:"此项可选，用于通过代理站来进行 API 调用",onChange:n=>{G("base_url",n)},value:i.base_url,autoComplete:"new-password"})]}),i.type===22&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"私有部署地址："})}),e.jsx(se,{name:"base_url",placeholder:"请输入私有部署地址，格式为：https://fastgpt.run/api/openapi",onChange:n=>{G("base_url",n)},value:i.base_url,autoComplete:"new-password"})]}),e.jsx("div",{style:{marginTop:10},children:e.jsx(ue.Text,{strong:!0,children:"状态码复写（仅影响本地判断，不修改返回到上游的状态码）："})}),e.jsx(vu,{placeholder:`此项可选，用于复写返回的状态码，比如将claude渠道的400错误复写为500（用于重试），请勿滥用该功能，例如：
${JSON.stringify(Ju,null,2)}`,name:"status_code_mapping",onChange:n=>{G("status_code_mapping",n)},autosize:!0,value:i.status_code_mapping,autoComplete:"new-password"}),e.jsx(ue.Text,{style:{color:"rgba(var(--semi-blue-5), 1)",userSelect:"none",cursor:"pointer"},onClick:()=>{G("status_code_mapping",JSON.stringify(Ju,null,2))},children:"填入模板"})]})})})};let au;function us(u){var s,c;if(!au){au=new Map;for(let a=0;a<Du.length;a++)au[Du[a].value]=Du[a];au[0]={value:0,text:"未知类型",color:"grey"}}return e.jsx(z,{size:"large",color:(s=au[u])==null?void 0:s.color,children:(c=au[u])==null?void 0:c.text})}const ts=()=>{const u=[{title:"ID",dataIndex:"id"},{title:"名称",dataIndex:"name"},{title:"分组",dataIndex:"group",render:(T,O,ne)=>e.jsx("div",{children:e.jsx(de,{spacing:2,children:T.split(",").map((ie,he)=>pt(ie))})})},{title:"类型",dataIndex:"type",render:(T,O,ne)=>e.jsx("div",{children:us(T)})},{title:"状态",dataIndex:"status",render:(T,O,ne)=>e.jsx("div",{children:M(T)})},{title:"响应时间",dataIndex:"response_time",render:(T,O,ne)=>e.jsx("div",{children:V(T)})},{title:"已用/剩余",dataIndex:"expired_time",render:(T,O,ne)=>e.jsx("div",{children:e.jsxs(de,{spacing:1,children:[e.jsx(Pe,{content:"已用额度",children:e.jsx(z,{color:"white",type:"ghost",size:"large",children:me(O.used_quota)})}),e.jsx(Pe,{content:"剩余额度"+O.balance+"，点击更新",children:e.jsxs(z,{color:"white",type:"ghost",size:"large",onClick:()=>{re(O)},children:["$",mn(O.balance)]})})]})})},{title:"优先级",dataIndex:"priority",render:(T,O,ne)=>e.jsx("div",{children:e.jsx(Tu,{style:{width:70},name:"priority",onBlur:ie=>{m(O.id,"priority",O,ie.target.value)},keepFocus:!0,innerButtons:!0,defaultValue:O.priority,min:-999})})},{title:"权重",dataIndex:"weight",render:(T,O,ne)=>e.jsx("div",{children:e.jsx(Tu,{style:{width:70},name:"weight",onBlur:ie=>{m(O.id,"weight",O,ie.target.value)},keepFocus:!0,innerButtons:!0,defaultValue:O.weight,min:0})})},{title:"",dataIndex:"operate",render:(T,O,ne)=>e.jsxs("div",{children:[e.jsxs(et,{style:{marginRight:1},"aria-label":"测试操作项目组",children:[e.jsx(I,{theme:"light",onClick:()=>{U(O,"")},children:"测试"}),e.jsx(Ke,{trigger:"click",position:"bottomRight",menu:O.test_models,children:e.jsx(I,{style:{padding:"8px 4px"},type:"primary",icon:e.jsx(ut,{})})})]}),e.jsx(we,{title:"确定是否要删除此渠道？",content:"此修改将不可逆",okType:"danger",position:"left",onConfirm:()=>{m(O.id,"delete",O).then(()=>{d(O.id)})},children:e.jsx(I,{theme:"light",type:"danger",style:{marginRight:1},children:"删除"})}),O.status===1?e.jsx(I,{theme:"light",type:"warning",style:{marginRight:1},onClick:async()=>{m(O.id,"disable",O)},children:"禁用"}):e.jsx(I,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async()=>{m(O.id,"enable",O)},children:"启用"}),e.jsx(I,{theme:"light",type:"tertiary",style:{marginRight:1},onClick:()=>{j(O),A(!0)},children:"编辑"}),e.jsx(we,{title:"确定是否要复制此渠道？",content:"复制渠道的所有信息",okType:"danger",position:"left",onConfirm:async()=>{g(O.id)},children:e.jsx(I,{theme:"light",type:"primary",style:{marginRight:1},children:"复制"})})]})}],[s,c]=t.useState([]),[a,l]=t.useState(!0),[r,F]=t.useState(1),[y,w]=t.useState(!1),[h,o]=t.useState(""),[i,x]=t.useState(""),[k,$]=t.useState(""),[_,L]=t.useState(!1),[v,H]=t.useState(!1),[Q,X]=t.useState(pe);t.useState(pn("channel-test"));const[K,Y]=t.useState(Q),[Z,te]=t.useState([]),[G,A]=t.useState(!1),[f,P]=t.useState(!1),[B,j]=t.useState({id:void 0}),[b,n]=t.useState([]),d=T=>{let O=[...s];if(T!=null){let ne=O.findIndex(ie=>ie.id===T);ne>-1&&(O.splice(ne,1),c(O))}},p=T=>{for(let O=0;O<T.length;O++){T[O].key=""+T[O].id;let ne=[];T[O].models.split(",").forEach((ie,he)=>{ne.push({node:"item",name:ie,onClick:()=>{U(T[O],ie)}})}),T[O].test_models=ne}c(T),T.length>=Q?Y(T.length+Q):Y(T.length)},S=async(T,O,ne)=>{l(!0);const ie=await R.get(`/api/channel/?p=${T}&page_size=${O}&id_sort=${ne}`);if(ie===void 0)return;const{success:he,message:fe,data:$e}=ie.data;if(he)if(T===0)p($e);else{let Xe=[...s];Xe.splice(T*O,$e.length,...$e),p(Xe)}else E(fe);l(!1)},g=async T=>{const O=s.find(ne=>String(ne.id)===String(T));if(console.log(O),O.name+="_复制",O.created_time=null,O.balance=0,O.used_quota=0,!O){E("渠道未找到，请刷新页面后重试。");return}try{const ne={...O,id:void 0},ie=await R.post("/api/channel/",ne);ie.data.success?(J("渠道复制成功"),await C()):E(ie.data.message)}catch(ne){E("渠道复制失败: "+ne.message)}},C=async()=>{await S(r-1,Q,y)};t.useEffect(()=>{const T=localStorage.getItem("id-sort")==="true",O=parseInt(localStorage.getItem("page-size"))||pe;w(T),X(O),S(0,O,T).then().catch(ne=>{E(ne)}),nu().then(),Bn().then()},[]);const m=async(T,O,ne,ie)=>{let he={id:T},fe;switch(O){case"delete":fe=await R.delete(`/api/channel/${T}/`);break;case"enable":he.status=1,fe=await R.put("/api/channel/",he);break;case"disable":he.status=2,fe=await R.put("/api/channel/",he);break;case"priority":if(ie==="")return;he.priority=parseInt(ie),fe=await R.put("/api/channel/",he);break;case"weight":if(ie==="")return;he.weight=parseInt(ie),he.weight<0&&(he.weight=0),fe=await R.put("/api/channel/",he);break}const{success:$e,message:Xe}=fe.data;if($e){J("操作成功完成！");let fu=fe.data.data,q=[...s];O==="delete"||(ne.status=fu.status),c(q)}else E(Xe)},M=T=>{switch(T){case 1:return e.jsx(z,{size:"large",color:"green",children:"已启用"});case 2:return e.jsx(z,{size:"large",color:"yellow",children:"已禁用"});case 3:return e.jsx(z,{size:"large",color:"yellow",children:"自动禁用"});default:return e.jsx(z,{size:"large",color:"grey",children:"未知状态"})}},V=T=>{let O=T/1e3;return O=O.toFixed(2)+" 秒",T===0?e.jsx(z,{size:"large",color:"grey",children:"未测试"}):T<=1e3?e.jsx(z,{size:"large",color:"green",children:O}):T<=3e3?e.jsx(z,{size:"large",color:"lime",children:O}):T<=5e3?e.jsx(z,{size:"large",color:"yellow",children:O}):e.jsx(z,{size:"large",color:"red",children:O})},D=async(T,O,ne)=>{if(T===""&&O===""&&ne===""){await S(0,Q,y),F(1);return}L(!0);const ie=await R.get(`/api/channel/search?keyword=${T}&group=${O}&model=${ne}`),{success:he,message:fe,data:$e}=ie.data;he?(c($e),F(1)):E(fe),L(!1)},U=async(T,O)=>{const ne=await R.get(`/api/channel/test/${T.id}?model=${O}`),{success:ie,message:he,time:fe}=ne.data;ie?(T.response_time=fe*1e3,T.test_time=Date.now()/1e3,be(`通道 ${T.name} 测试成功，耗时 ${fe.toFixed(2)} 秒。`)):E(he)},ee=async()=>{const T=await R.get("/api/channel/test"),{success:O,message:ne}=T.data;O?be("已成功开始测试所有通道，请刷新页面查看结果。"):E(ne)},ae=async()=>{const T=await R.delete("/api/channel/disabled"),{success:O,message:ne,data:ie}=T.data;O?(J(`已删除所有禁用渠道，共计 ${ie} 个`),await C()):E(ne)},re=async T=>{const O=await R.get(`/api/channel/update_balance/${T.id}/`),{success:ne,message:ie,balance:he}=O.data;ne?(T.balance=he,T.balance_updated_time=Date.now()/1e3,be(`通道 ${T.name} 余额更新成功！`)):E(ie)},oe=async()=>{H(!0);const T=await R.get("/api/channel/update_balance"),{success:O,message:ne}=T.data;O?be("已更新完毕所有已启用通道余额！"):E(ne),H(!1)},Be=async()=>{if(b.length===0){E("请先选择要删除的通道！");return}l(!0);let T=[];b.forEach(fe=>{T.push(fe.id)});const O=await R.post("/api/channel/batch",{ids:T}),{success:ne,message:ie,data:he}=O.data;ne?(J(`已删除 ${he} 个通道！`),await C()):E(ie),l(!1)},Te=async()=>{const T=await R.post("/api/channel/fix"),{success:O,message:ne,data:ie}=T.data;O?(J(`已修复 ${ie} 个通道！`),await C()):E(ne)};let Me=s.slice((r-1)*Q,r*Q);const ze=T=>{F(T),T===Math.ceil(s.length/Q)+1&&S(T-1,Q,y).then(O=>{})},Ye=async T=>{localStorage.setItem("page-size",T+""),X(T),F(1),S(0,T,y).then().catch(O=>{E(O)})},nu=async()=>{try{let T=await R.get("/api/group/");if(T===void 0)return;te(T.data.data.map(O=>({label:O,value:O})))}catch(T){E(T.message)}},Eu=()=>{A(!1)},Cu=(T,O)=>T.status!==1?{style:{background:"var(--semi-color-disabled-border)"}}:{};return e.jsxs(e.Fragment,{children:[e.jsx(Lu,{refresh:C,visible:G,handleClose:Eu,editingChannel:B}),e.jsx(N,{onSubmit:()=>{D(h,i,k)},labelPosition:"left",children:e.jsx("div",{style:{display:"flex"},children:e.jsxs(de,{children:[e.jsx(N.Input,{field:"search_keyword",label:"搜索渠道关键词",placeholder:"ID，名称和密钥 ...",value:h,loading:_,onChange:T=>{o(T.trim())}}),e.jsx(N.Input,{field:"search_model",label:"模型",placeholder:"模型关键字",value:k,loading:_,onChange:T=>{$(T.trim())}}),e.jsx(N.Select,{field:"group",label:"分组",optionList:Z,onChange:T=>{x(T),D(h,T,k)}}),e.jsx(I,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",style:{marginRight:8},children:"查询"})]})})}),e.jsx("div",{style:{marginTop:10,display:"flex"},children:e.jsx(de,{children:e.jsxs(de,{children:[e.jsx(ue.Text,{strong:!0,children:"使用ID排序"}),e.jsx(Pu,{checked:y,label:"使用ID排序",uncheckedText:"关","aria-label":"是否用ID排序",onChange:T=>{localStorage.setItem("id-sort",T+""),w(T),S(0,Q,T).then().catch(O=>{E(O)})}})]})})}),e.jsx(tu,{className:"channel-table",style:{marginTop:15},columns:u,dataSource:Me,pagination:{currentPage:r,pageSize:Q,total:K,pageSizeOpts:[10,20,50,100],showSizeChanger:!0,formatPageText:T=>"",onPageSizeChange:T=>{Ye(T).then()},onPageChange:ze},loading:a,onRow:Cu,rowSelection:f?{onChange:(T,O)=>{n(O)}}:null}),e.jsx("div",{style:{display:ve()?"":"flex",marginTop:ve()?0:-45,zIndex:999,position:"relative",pointerEvents:"none"},children:e.jsxs(de,{style:{pointerEvents:"auto",marginTop:ve()?0:45},children:[e.jsx(I,{theme:"light",type:"primary",style:{marginRight:8},onClick:()=>{j({id:void 0}),A(!0)},children:"添加渠道"}),e.jsx(we,{title:"确定？",okType:"warning",onConfirm:ee,position:(ve(),"top"),children:e.jsx(I,{theme:"light",type:"warning",style:{marginRight:8},children:"测试所有通道"})}),e.jsx(we,{title:"确定？",okType:"secondary",onConfirm:oe,children:e.jsx(I,{theme:"light",type:"secondary",style:{marginRight:8},children:"更新所有已启用通道余额"})}),e.jsx(we,{title:"确定是否要删除禁用通道？",content:"此修改将不可逆",okType:"danger",onConfirm:ae,children:e.jsx(I,{theme:"light",type:"danger",style:{marginRight:8},children:"删除禁用通道"})}),e.jsx(I,{theme:"light",type:"primary",style:{marginRight:8},onClick:C,children:"刷新"})]})}),e.jsx("div",{style:{marginTop:20},children:e.jsxs(de,{children:[e.jsx(ue.Text,{strong:!0,children:"开启批量删除"}),e.jsx(Pu,{label:"开启批量删除",uncheckedText:"关","aria-label":"是否开启批量删除",onChange:T=>{P(T)}}),e.jsx(we,{title:"确定是否要删除所选通道？",content:"此修改将不可逆",okType:"danger",onConfirm:Be,disabled:!f,position:"top",children:e.jsx(I,{disabled:!f,theme:"light",type:"danger",style:{marginRight:8},children:"删除所选通道"})}),e.jsx(we,{title:"确定是否要修复数据库一致性？",content:"进行该操作时，可能导致渠道访问错误，请仅在数据库出现问题时使用",okType:"warning",onConfirm:Te,position:"top",children:e.jsx(I,{theme:"light",type:"secondary",style:{marginRight:8},children:"修复数据库一致性"})})]})})]})},ns=()=>e.jsx(e.Fragment,{children:e.jsxs(le,{children:[e.jsx(le.Header,{children:e.jsx("h3",{children:"管理渠道"})}),e.jsx(le.Content,{children:e.jsx(ts,{})})]})}),ss=u=>{const[s,c]=t.useState(!1),[a,l]=t.useState(s),r={name:"",remain_quota:s?0:5e5,expired_time:-1,unlimited_quota:!1,model_limits_enabled:!1,model_limits:[]},[F,y]=t.useState(r),{name:w,remain_quota:h,expired_time:o,unlimited_quota:i,model_limits_enabled:x,model_limits:k}=F,[$,_]=t.useState({});_e();const L=(f,P)=>{y(B=>({...B,[f]:P}))},v=()=>{u.handleClose()},H=(f,P,B,j)=>{let n=new Date().getTime()/1e3,d=f*30*24*60*60;d+=P*24*60*60,d+=B*60*60,d+=j*60,d!==0?(n+=d,y({...F,expired_time:Oe(n)})):y({...F,expired_time:-1})},Q=()=>{y({...F,unlimited_quota:!i})},X=async()=>{let f=await R.get("/api/user/models");const{success:P,message:B,data:j}=f.data;if(P){let b=j.map(n=>({label:n,value:n}));_(b)}else E(B)},K=async()=>{l(!0);let f=await R.get(`/api/token/${u.editingToken.id}`);const{success:P,message:B,data:j}=f.data;P?(j.expired_time!==-1&&(j.expired_time=Oe(j.expired_time)),j.model_limits!==""?j.model_limits=j.model_limits.split(","):j.model_limits=[],y(j)):E(B),l(!1)};t.useEffect(()=>{c(u.editingToken.id!==void 0)},[u.editingToken.id]),t.useEffect(()=>{s?K().then(()=>{}):y(r),X()},[s]);const[Y,Z]=t.useState(1),te=f=>{const P=parseInt(f,10);!isNaN(P)&&P>0&&Z(P)},G=()=>{const f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let P="";for(let B=0;B<6;B++)P+=f.charAt(Math.floor(Math.random()*f.length));return P},A=async()=>{if(l(!0),s){let f={...F};if(f.remain_quota=parseInt(f.remain_quota),f.expired_time!==-1){let b=Date.parse(f.expired_time);if(isNaN(b)){E("过期时间格式错误！"),l(!1);return}f.expired_time=Math.ceil(b/1e3)}f.model_limits=f.model_limits.join(",");let P=await R.put("/api/token/",{...f,id:parseInt(u.editingToken.id)});const{success:B,message:j}=P.data;B?(J("令牌更新成功！"),u.refresh(),u.handleClose()):E(j)}else{let f=0;for(let P=0;P<Y;P++){let B={...F};if(P!==0&&(B.name=`${F.name}-${G()}`),B.remain_quota=parseInt(B.remain_quota),B.expired_time!==-1){let d=Date.parse(B.expired_time);if(isNaN(d)){E("过期时间格式错误！"),l(!1);break}B.expired_time=Math.ceil(d/1e3)}B.model_limits=B.model_limits.join(",");let j=await R.post("/api/token/",B);const{success:b,message:n}=j.data;if(b)f++;else{E(n);break}}f>0&&(J(`${f}个令牌创建成功，请在列表页面点击复制获取令牌！`),u.refresh(),u.handleClose())}l(!1),y(r),Z(1)};return e.jsx(e.Fragment,{children:e.jsx(mu,{placement:s?"right":"left",title:e.jsx(uu,{level:3,children:s?"更新令牌信息":"创建新的令牌"}),headerStyle:{borderBottom:"1px solid var(--semi-color-border)"},bodyStyle:{borderBottom:"1px solid var(--semi-color-border)"},visible:u.visiable,footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(de,{children:[e.jsx(I,{theme:"solid",size:"large",onClick:A,children:"提交"}),e.jsx(I,{theme:"solid",size:"large",type:"tertiary",onClick:v,children:"取消"})]})}),closeIcon:null,onCancel:()=>v(),width:ve()?"100%":600,children:e.jsxs(De,{spinning:a,children:[e.jsx(se,{style:{marginTop:20},label:"名称",name:"name",placeholder:"请输入名称",onChange:f=>L("name",f),value:w,autoComplete:"new-password",required:!s}),e.jsx(Ae,{}),e.jsx(Lt,{label:"过期时间",name:"expired_time",placeholder:"请选择过期时间",onChange:f=>L("expired_time",f),value:o,autoComplete:"new-password",type:"dateTime"}),e.jsx("div",{style:{marginTop:20},children:e.jsxs(de,{children:[e.jsx(I,{type:"tertiary",onClick:()=>{H(0,0,0,0)},children:"永不过期"}),e.jsx(I,{type:"tertiary",onClick:()=>{H(0,0,1,0)},children:"一小时"}),e.jsx(I,{type:"tertiary",onClick:()=>{H(1,0,0,0)},children:"一个月"}),e.jsx(I,{type:"tertiary",onClick:()=>{H(0,1,0,0)},children:"一天"})]})}),e.jsx(Ae,{}),e.jsx(We,{type:"warning",description:"注意，令牌的额度仅用于限制令牌本身的最大额度使用量，实际的使用受到账户的剩余额度限制。"}),e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:`额度${hu(h)}`})}),e.jsx(Mu,{style:{marginTop:8},name:"remain_quota",placeholder:"请输入额度",onChange:f=>L("remain_quota",f),value:h,autoComplete:"new-password",type:"number",data:[{value:5e5,label:"1$"},{value:5e6,label:"10$"},{value:25e6,label:"50$"},{value:5e7,label:"100$"},{value:25e7,label:"500$"},{value:5e8,label:"1000$"}],disabled:i}),!s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:"新建数量"})}),e.jsx(Mu,{style:{marginTop:8},label:"数量",placeholder:"请选择或输入创建令牌的数量",onChange:f=>te(f),onSelect:f=>te(f),value:Y.toString(),autoComplete:"off",type:"number",data:[{value:10,label:"10个"},{value:20,label:"20个"},{value:30,label:"30个"},{value:100,label:"100个"}],disabled:i})]}),e.jsx("div",{children:e.jsx(I,{style:{marginTop:8},type:"warning",onClick:()=>{Q()},children:i?"取消无限额度":"设为无限额度"})}),e.jsx(Ae,{}),e.jsx("div",{style:{marginTop:10,display:"flex"},children:e.jsxs(de,{children:[e.jsx(Iu,{name:"model_limits_enabled",checked:x,onChange:f=>L("model_limits_enabled",f.target.checked)}),e.jsx(ue.Text,{children:"启用模型限制（非必要，不建议启用）"})]})}),e.jsx(Ie,{style:{marginTop:8},placeholder:"请选择该渠道所支持的模型",name:"models",required:!0,multiple:!0,selection:!0,onChange:f=>{L("model_limits",f)},value:F.model_limits,autoComplete:"new-password",optionList:$,disabled:!x})]})})})};function Yu(u){return e.jsx(e.Fragment,{children:Oe(u)})}function as(u,s=!1){switch(u){case 1:return s?e.jsx(z,{color:"green",size:"large",children:"已启用：限制模型"}):e.jsx(z,{color:"green",size:"large",children:"已启用"});case 2:return e.jsxs(z,{color:"red",size:"large",children:[" ","已禁用"," "]});case 3:return e.jsxs(z,{color:"yellow",size:"large",children:[" ","已过期"," "]});case 4:return e.jsxs(z,{color:"grey",size:"large",children:[" ","已耗尽"," "]});default:return e.jsxs(z,{color:"black",size:"large",children:[" ","未知状态"," "]})}}const rs=()=>{const u=[{title:"名称",dataIndex:"name"},{title:"状态",dataIndex:"status",key:"status",render:(m,M,V)=>e.jsx("div",{children:as(m,M.model_limits_enabled)})},{title:"已用额度",dataIndex:"used_quota",render:(m,M,V)=>e.jsx("div",{children:me(parseInt(m))})},{title:"剩余额度",dataIndex:"remain_quota",render:(m,M,V)=>e.jsx("div",{children:M.unlimited_quota?e.jsx(z,{size:"large",color:"white",children:"无限制"}):e.jsx(z,{size:"large",color:"light-blue",children:me(parseInt(m))})})},{title:"创建时间",dataIndex:"created_time",render:(m,M,V)=>e.jsx("div",{children:Yu(m)})},{title:"过期时间",dataIndex:"expired_time",render:(m,M,V)=>e.jsx("div",{children:M.expired_time===-1?"永不过期":Yu(m)})},{title:"",dataIndex:"operate",render:(m,M,V)=>e.jsxs("div",{children:[e.jsx(du,{content:"sk-"+M.key,style:{padding:20},position:"top",children:e.jsx(I,{theme:"light",type:"tertiary",style:{marginRight:1},children:"查看"})}),e.jsx(I,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async D=>{await P("sk-"+M.key)},children:"复制"}),e.jsxs(et,{style:{marginRight:1},"aria-label":"项目操作按钮组",children:[e.jsx(I,{theme:"light",style:{color:"rgba(var(--semi-teal-7), 1)"},onClick:()=>{B("next",M.key)},children:"聊天"}),e.jsx(Ke,{trigger:"click",position:"bottomRight",menu:[{node:"item",key:"next",disabled:!localStorage.getItem("chat_link"),name:"ChatGPT Next Web",onClick:()=>{B("next",M.key)}},{node:"item",key:"next-mj",disabled:!localStorage.getItem("chat_link2"),name:"ChatGPT Web & Midjourney",onClick:()=>{B("next-mj",M.key)}},{node:"item",key:"ama",name:"AMA 问天（BotGem）",onClick:()=>{B("ama",M.key)}},{node:"item",key:"opencat",name:"OpenCat",onClick:()=>{B("opencat",M.key)}}],children:e.jsx(I,{style:{padding:"8px 4px",color:"rgba(var(--semi-teal-7), 1)"},type:"primary",icon:e.jsx(ut,{})})})]}),e.jsx(we,{title:"确定是否要删除此令牌？",content:"此修改将不可逆",okType:"danger",position:"left",onConfirm:()=>{b(M.id,"delete",M).then(()=>{j(M.key)})},children:e.jsx(I,{theme:"light",type:"danger",style:{marginRight:1},children:"删除"})}),M.status===1?e.jsx(I,{theme:"light",type:"warning",style:{marginRight:1},onClick:async()=>{b(M.id,"disable",M)},children:"禁用"}):e.jsx(I,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async()=>{b(M.id,"enable",M)},children:"启用"}),e.jsx(I,{theme:"light",type:"tertiary",style:{marginRight:1},onClick:()=>{Y(M),l(!0)},children:"编辑"})]})}],[s,c]=t.useState(pe),[a,l]=t.useState(!1),[r,F]=t.useState([]),[y,w]=t.useState([]),[h,o]=t.useState(s),[i,x]=t.useState(!0),[k,$]=t.useState(1),[_,L]=t.useState(""),[v,H]=t.useState(""),[Q,X]=t.useState(!1);t.useState(!1),t.useState(0);const[K,Y]=t.useState({id:void 0}),Z=()=>{l(!1),setTimeout(()=>{Y({id:void 0})},500)},te=m=>{F(m),m.length>=s?o(m.length+s):o(m.length)};let G=r.slice((k-1)*s,k*s);const A=async m=>{x(!0);const M=await R.get(`/api/token/?p=${m}&size=${s}`),{success:V,message:D,data:U}=M.data;if(V)if(m===0)te(U);else{let ee=[...r];ee.splice(m*s,U.length,...U),te(ee)}else E(D);x(!1)},f=async()=>{await A(k-1)},P=async m=>{await Le(m)?J("已复制到剪贴板！"):je.error({title:"无法复制到剪贴板，请手动复制",content:m,size:"large"})},B=async(m,M)=>{let V=localStorage.getItem("status"),D="";V&&(V=JSON.parse(V),D=V.server_address),D===""&&(D=window.location.origin);let U=encodeURIComponent(D);const ee=localStorage.getItem("chat_link"),ae=localStorage.getItem("chat_link2");let re;ee&&(re=ee+`/#/?settings={"key":"sk-${M}","url":"${D}"}`);let oe;switch(m){case"ama":oe=`ama://set-api-key?server=${U}&key=sk-${M}`;break;case"opencat":oe=`opencat://team/join?domain=${U}&token=sk-${M}`;break;case"next-mj":oe=ae+`/#/?settings={"key":"sk-${M}","url":"${D}"}`;break;default:if(!ee){E("管理员未设置聊天链接");return}oe=re}window.open(oe,"_blank")};t.useEffect(()=>{A(0).then().catch(m=>{E(m)})},[s]);const j=m=>{let M=[...r];if(m!=null){let V=M.findIndex(D=>D.key===m);V>-1&&(M.splice(V,1),te(M))}},b=async(m,M,V)=>{x(!0);let D={id:m},U;switch(M){case"delete":U=await R.delete(`/api/token/${m}/`);break;case"enable":D.status=1,U=await R.put("/api/token/?status_only=true",D);break;case"disable":D.status=2,U=await R.put("/api/token/?status_only=true",D);break}const{success:ee,message:ae}=U.data;if(ee){J("操作成功完成！");let re=U.data.data,oe=[...r];M==="delete"||(V.status=re.status),te(oe)}else E(ae);x(!1)},n=async()=>{if(_===""&&v===""){await A(0),$(1);return}X(!0);const m=await R.get(`/api/token/search?keyword=${_}&token=${v}`),{success:M,message:V,data:D}=m.data;M?(te(D),$(1)):E(V),X(!1)},d=async m=>{L(m.trim())},p=async m=>{H(m.trim())},S=m=>{$(m),m===Math.ceil(r.length/s)+1&&A(m-1).then(M=>{})},g={onSelect:(m,M)=>{},onSelectAll:(m,M)=>{},onChange:(m,M)=>{w(M)}},C=(m,M)=>m.status!==1?{style:{background:"var(--semi-color-disabled-border)"}}:{};return e.jsxs(e.Fragment,{children:[e.jsx(ss,{refresh:f,editingToken:K,visiable:a,handleClose:Z}),e.jsxs(N,{layout:"horizontal",style:{marginTop:10},labelPosition:"left",children:[e.jsx(N.Input,{field:"keyword",label:"搜索关键字",placeholder:"令牌名称",value:_,loading:Q,onChange:d}),e.jsx(N.Input,{field:"token",label:"Key",placeholder:"密钥",value:v,loading:Q,onChange:p}),e.jsx(I,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",onClick:n,style:{marginRight:8},children:"查询"})]}),e.jsx(tu,{style:{marginTop:20},columns:u,dataSource:G,pagination:{currentPage:k,pageSize:s,total:h,showSizeChanger:!0,pageSizeOptions:[10,20,50,100],formatPageText:m=>`第 ${m.currentStart} - ${m.currentEnd} 条，共 ${r.length} 条`,onPageSizeChange:m=>{c(m),$(1)},onPageChange:S},loading:i,rowSelection:g,onRow:C}),e.jsx(I,{theme:"light",type:"primary",style:{marginRight:8},onClick:()=>{Y({id:void 0}),l(!0)},children:"添加令牌"}),e.jsx(I,{label:"复制所选令牌",type:"warning",onClick:async()=>{if(y.length===0){E("请至少选择一个令牌！");return}let m="";for(let M=0;M<y.length;M++)m+=y[M].name+"    sk-"+y[M].key+`
`;await P(m)},children:"复制所选令牌到剪贴板"})]})},is=()=>e.jsx(e.Fragment,{children:e.jsxs(le,{children:[e.jsx(le.Header,{children:e.jsx("h3",{children:"我的令牌"})}),e.jsx(le.Content,{children:e.jsx(rs,{})})]})}),ls=u=>{const s=u.editingRedemption.id!==void 0,[c,a]=t.useState(s);_t(),_e();const l={name:"",quota:1e5,count:1},[r,F]=t.useState(l),{name:y,quota:w,count:h}=r,o=()=>{u.handleClose()},i=($,_)=>{F(L=>({...L,[$]:_}))},x=async()=>{a(!0);let $=await R.get(`/api/redemption/${u.editingRedemption.id}`);const{success:_,message:L,data:v}=$.data;_?F(v):E(L),a(!1)};t.useEffect(()=>{s?x().then(()=>{}):F(l)},[u.editingRedemption.id]);const k=async()=>{if(!s&&r.name==="")return;a(!0);let $=r;$.count=parseInt($.count),$.quota=parseInt($.quota);let _;s?_=await R.put("/api/redemption/",{...$,id:parseInt(u.editingRedemption.id)}):_=await R.post("/api/redemption/",{...$});const{success:L,message:v,data:H}=_.data;if(L?s?(J("兑换码更新成功！"),u.refresh(),u.handleClose()):(J("兑换码创建成功！"),F(l),u.refresh(),u.handleClose()):E(v),!s&&H){let Q="";for(let X=0;X<H.length;X++)Q+=H[X]+`
`;je.confirm({title:"兑换码创建成功",content:e.jsxs("div",{children:[e.jsx("p",{children:"兑换码创建成功，是否下载兑换码？"}),e.jsx("p",{children:"兑换码将以文本文件的形式下载，文件名为兑换码的名称。"})]}),onOk:()=>{Fn(Q,`${r.name}.txt`)}})}a(!1)};return e.jsx(e.Fragment,{children:e.jsx(mu,{placement:s?"right":"left",title:e.jsx(uu,{level:3,children:s?"更新兑换码信息":"创建新的兑换码"}),headerStyle:{borderBottom:"1px solid var(--semi-color-border)"},bodyStyle:{borderBottom:"1px solid var(--semi-color-border)"},visible:u.visiable,footer:e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(de,{children:[e.jsx(I,{theme:"solid",size:"large",onClick:k,children:"提交"}),e.jsx(I,{theme:"solid",size:"large",type:"tertiary",onClick:o,children:"取消"})]})}),closeIcon:null,onCancel:()=>o(),width:ve()?"100%":600,children:e.jsxs(De,{spinning:c,children:[e.jsx(se,{style:{marginTop:20},label:"名称",name:"name",placeholder:"请输入名称",onChange:$=>i("name",$),value:y,autoComplete:"new-password",required:!s}),e.jsx(Ae,{}),e.jsx("div",{style:{marginTop:20},children:e.jsx(ue.Text,{children:`额度${hu(w)}`})}),e.jsx(Mu,{style:{marginTop:8},name:"quota",placeholder:"请输入额度",onChange:$=>i("quota",$),value:w,autoComplete:"new-password",type:"number",position:"bottom",data:[{value:5e5,label:"1$"},{value:5e6,label:"10$"},{value:25e6,label:"50$"},{value:5e7,label:"100$"},{value:25e7,label:"500$"},{value:5e8,label:"1000$"}]}),!s&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{}),e.jsx(ue.Text,{children:"生成数量"}),e.jsx(se,{style:{marginTop:8},label:"生成数量",name:"count",placeholder:"请输入生成数量",onChange:$=>i("count",$),value:h,autoComplete:"new-password",type:"number"})]})]})})})};function os(u){return e.jsx(e.Fragment,{children:Oe(u)})}function cs(u){switch(u){case 1:return e.jsx(z,{color:"green",size:"large",children:"未使用"});case 2:return e.jsxs(z,{color:"red",size:"large",children:[" ","已禁用"," "]});case 3:return e.jsxs(z,{color:"grey",size:"large",children:[" ","已使用"," "]});default:return e.jsxs(z,{color:"black",size:"large",children:[" ","未知状态"," "]})}}const ds=()=>{const u=[{title:"ID",dataIndex:"id"},{title:"名称",dataIndex:"name"},{title:"状态",dataIndex:"status",key:"status",render:(n,d,p)=>e.jsx("div",{children:cs(n)})},{title:"额度",dataIndex:"quota",render:(n,d,p)=>e.jsx("div",{children:me(parseInt(n))})},{title:"创建时间",dataIndex:"created_time",render:(n,d,p)=>e.jsx("div",{children:os(n)})},{title:"兑换人ID",dataIndex:"used_user_id",render:(n,d,p)=>e.jsx("div",{children:n===0?"无":n})},{title:"",dataIndex:"operate",render:(n,d,p)=>e.jsxs("div",{children:[e.jsx(du,{content:d.key,style:{padding:20},position:"top",children:e.jsx(I,{theme:"light",type:"tertiary",style:{marginRight:1},children:"查看"})}),e.jsx(I,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async S=>{await Z(d.key)},children:"复制"}),e.jsx(we,{title:"确定是否要删除此兑换码？",content:"此修改将不可逆",okType:"danger",position:"left",onConfirm:()=>{G(d.id,"delete",d).then(()=>{Y(d.key)})},children:e.jsx(I,{theme:"light",type:"danger",style:{marginRight:1},children:"删除"})}),d.status===1?e.jsx(I,{theme:"light",type:"warning",style:{marginRight:1},onClick:async()=>{G(d.id,"disable",d)},children:"禁用"}):e.jsx(I,{theme:"light",type:"secondary",style:{marginRight:1},onClick:async()=>{G(d.id,"enable",d)},disabled:d.status===3,children:"启用"}),e.jsx(I,{theme:"light",type:"tertiary",style:{marginRight:1},onClick:()=>{L(d),H(!0)},disabled:d.status!==1,children:"编辑"})]})}],[s,c]=t.useState([]),[a,l]=t.useState(!0),[r,F]=t.useState(1),[y,w]=t.useState(""),[h,o]=t.useState(!1),[i,x]=t.useState(pe),[k,$]=t.useState([]),[_,L]=t.useState({id:void 0}),[v,H]=t.useState(!1),Q=()=>{H(!1)},X=n=>{c(n),n.length>=r*pe?x(n.length+1):x(n.length)},K=async n=>{const d=await R.get(`/api/redemption/?p=${n}`),{success:p,message:S,data:g}=d.data;if(p)if(n===0)X(g);else{let C=s;C.push(...g),X(C)}else E(S);l(!1)},Y=n=>{let d=[...s];if(n!=null){let p=d.findIndex(S=>S.key===n);p>-1&&(d.splice(p,1),c(d))}},Z=async n=>{await Le(n)?J("已复制到剪贴板！"):je.error({title:"无法复制到剪贴板，请手动复制",content:n})};t.useEffect(()=>{K(0).then().catch(n=>{E(n)})},[]);const te=async()=>{await K(r-1)},G=async(n,d,p)=>{let S={id:n},g;switch(d){case"delete":g=await R.delete(`/api/redemption/${n}/`);break;case"enable":S.status=1,g=await R.put("/api/redemption/?status_only=true",S);break;case"disable":S.status=2,g=await R.put("/api/redemption/?status_only=true",S);break}const{success:C,message:m}=g.data;if(C){J("操作成功完成！");let M=g.data.data,V=[...s];d==="delete"||(p.status=M.status),c(V)}else E(m)},A=async()=>{if(y===""){await K(0),F(1);return}o(!0);const n=await R.get(`/api/redemption/search?keyword=${y}`),{success:d,message:p,data:S}=n.data;d?(c(S),F(1)):E(p),o(!1)},f=async n=>{w(n.trim())},P=n=>{F(n),n===Math.ceil(s.length/pe)+1&&K(n-1).then(d=>{})};let B=s.slice((r-1)*pe,r*pe);const j={onSelect:(n,d)=>{},onSelectAll:(n,d)=>{},onChange:(n,d)=>{$(d)}},b=(n,d)=>n.status!==1?{style:{background:"var(--semi-color-disabled-border)"}}:{};return e.jsxs(e.Fragment,{children:[e.jsx(ls,{refresh:te,editingRedemption:_,visiable:v,handleClose:Q}),e.jsx(N,{onSubmit:A,children:e.jsx(N.Input,{label:"搜索关键字",field:"keyword",icon:"search",iconPosition:"left",placeholder:"关键字(id或者名称)",value:y,loading:h,onChange:f})}),e.jsx(tu,{style:{marginTop:20},columns:u,dataSource:B,pagination:{currentPage:r,pageSize:pe,total:i,formatPageText:n=>`第 ${n.currentStart} - ${n.currentEnd} 条，共 ${s.length} 条`,onPageChange:P},loading:a,rowSelection:j,onRow:b}),e.jsx(I,{theme:"light",type:"primary",style:{marginRight:8},onClick:()=>{L({id:void 0}),H(!0)},children:"添加兑换码"}),e.jsx(I,{label:"复制所选兑换码",type:"warning",onClick:async()=>{if(k.length===0){E("请至少选择一个兑换码！");return}let n="";for(let d=0;d<k.length;d++)n+=k[d].name+"    "+k[d].key+`
`;await Z(n)},children:"复制所选兑换码到剪贴板"})]})},hs=()=>e.jsx(e.Fragment,{children:e.jsxs(le,{children:[e.jsx(le.Header,{children:e.jsx("h3",{children:"管理兑换码"})}),e.jsx(le.Content,{children:e.jsx(ds,{})})]})}),Fs=()=>{const[u,s]=t.useState(""),[c,a]=t.useState(""),[l,r]=t.useState(10);t.useState(1);const[F,y]=t.useState(0),[w,h]=t.useState(0),[o,i]=t.useState(1),[x,k]=t.useState(""),[$,_]=t.useState(!1),[L,v]=t.useState(0),[H,Q]=t.useState(!1),[X,K]=t.useState(!1),[Y,Z]=t.useState(!1),[te,G]=t.useState(""),A=async()=>{if(u===""){E("请输入兑换码！");return}Q(!0);try{const p=await R.post("/api/user/topup",{key:u}),{success:S,message:g,data:C}=p.data;S?(J("兑换成功！"),je.success({title:"兑换成功！",content:"成功兑换额度："+me(C),centered:!0}),v(m=>m+C),s("")):E(g)}catch{E("请求失败")}finally{Q(!1)}},f=()=>{if(!x){E("超级管理员未设置充值链接！");return}window.open(x,"_blank")},P=async p=>{if(!$){E("管理员未开启在线充值！");return}if(!Number.isInteger(Number(l))){E("充值数量必须是整数！");return}if(F===0&&await n(),l<o){E("充值数量不能小于"+o);return}G(p),Z(!0)},B=async()=>{if(F===0&&await n(),l<o){E("充值数量不能小于"+o);return}Z(!1);try{K(!0);const p=await R.post("/api/user/pay",{amount:parseInt(l),top_up_code:c,payment_method:te});if(p!==void 0){const{message:S,data:g}=p.data;S==="success"?location.href=g.payLink:(K(!1),E(g))}else K(!1),E(p)}catch(p){console.log(p)}finally{}},j=async()=>{let p=await R.get("/api/user/self");const{success:S,message:g,data:C}=p.data;S?v(C.quota):E(g)};t.useEffect(()=>{let p=localStorage.getItem("status");p&&(p=JSON.parse(p),p.top_up_link&&k(p.top_up_link),p.min_topup&&i(p.min_topup),p.payment_enabled&&_(p.payment_enabled)),j().then()},[]);const b=()=>F+"元",n=async p=>{p===void 0&&(p=l);try{const S=await R.post("/api/user/amount",{amount:parseFloat(p),top_up_code:c});if(S!==void 0){const{message:g,data:C}=S.data;g==="success"?(y(parseFloat(C.payAmount)),h(parseFloat(C.chargedAmount))):E(C)}else E(S)}catch(S){console.log(S)}finally{}},d=()=>{Z(!1)};return e.jsx("div",{children:e.jsxs(le,{children:[e.jsx(le.Header,{children:e.jsx("h3",{children:"我的钱包"})}),e.jsxs(le.Content,{children:[e.jsxs(je,{title:"确定要充值吗",visible:Y,onOk:B,onCancel:d,maskClosable:!1,size:"small",centered:!0,children:[e.jsxs("p",{children:["充值数量：",l,"$（实到：",w,"$）"]}),e.jsxs("p",{children:["实付金额：",b()]}),e.jsx("p",{children:"是否确认充值？"})]}),e.jsx("div",{style:{marginTop:20,display:"flex",justifyContent:"center"},children:e.jsxs(Se,{style:{width:"500px",padding:"20px"},children:[e.jsxs(uu,{level:3,style:{textAlign:"center"},children:["余额 ",me(L)]}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(Bu,{children:"兑换余额"}),e.jsxs(N,{children:[e.jsx(N.Input,{field:"redemptionCode",label:"兑换码",placeholder:"兑换码",name:"redemptionCode",value:u,onChange:p=>{s(p)}}),e.jsxs(de,{children:[x?e.jsx(I,{type:"primary",theme:"solid",onClick:f,children:"获取兑换码"}):null,e.jsx(I,{type:"warning",theme:"solid",onClick:A,disabled:H,children:H?"兑换中...":"兑换"})]})]})]}),$?e.jsxs("div",{style:{marginTop:20},children:[e.jsx(Bu,{children:"在线充值"}),e.jsxs(N,{children:[e.jsx(N.Input,{disabled:!$,field:"redemptionCount",label:"实付金额："+b(),placeholder:"充值数量，必须整数，最低"+o+"$",name:"redemptionCount",type:"number",value:l,suffix:"$",min:o,defaultValue:o,max:1e5,onChange:async p=>{p<1&&(p=1),p>1e5&&(p=1e5),r(p),await n(p)}}),e.jsx(de,{children:e.jsx(I,{style:{backgroundColor:"#b161fe"},type:"primary",disabled:X,theme:"solid",onClick:async()=>{P("stripe")},children:X?"支付中...":"去支付"})})]})]}):e.jsx(e.Fragment,{})]})})]})]})})},{Header:ps}=le,Xu=["amber","blue","cyan","green","grey","indigo","light-blue","lime","orange","pink","purple","red","teal","violet","yellow"];function ms(u){switch(u){case 1:return e.jsxs(z,{color:"cyan",size:"large",children:[" ","充值"," "]});case 2:return e.jsxs(z,{color:"lime",size:"large",children:[" ","消费"," "]});case 3:return e.jsxs(z,{color:"orange",size:"large",children:[" ","管理"," "]});case 4:return e.jsxs(z,{color:"purple",size:"large",children:[" ","系统"," "]});default:return e.jsxs(z,{color:"black",size:"large",children:[" ","未知"," "]})}}function gs(u){return u?e.jsx(z,{color:"blue",size:"large",children:"流"}):e.jsx(z,{color:"purple",size:"large",children:"非流"})}function xs(u){const s=parseInt(u);return s<101?e.jsxs(z,{color:"green",size:"large",children:[" ",s," s"," "]}):s<300?e.jsxs(z,{color:"orange",size:"large",children:[" ",s," s"," "]}):e.jsxs(z,{color:"red",size:"large",children:[" ",s," s"," "]})}const Es=()=>{const u=[{title:"时间",dataIndex:"timestamp2string"},{title:"渠道",dataIndex:"channel",className:ke()?"tableShow":"tableHiddle",render:(D,U,ee)=>v?U.type===0||U.type===2?e.jsx("div",{children:e.jsxs(z,{color:Xu[parseInt(D)%Xu.length],size:"large",children:[" ",D," "]})}):e.jsx(e.Fragment,{}):e.jsx(e.Fragment,{})},{title:"用户",dataIndex:"username",className:ke()?"tableShow":"tableHiddle",render:(D,U,ee)=>v?e.jsxs("div",{children:[e.jsx(zu,{size:"small",color:Fu(D),style:{marginRight:4},onClick:()=>d(U.user_id),children:typeof D=="string"&&D.slice(0,1)}),D]}):e.jsx(e.Fragment,{})},{title:"令牌",dataIndex:"token_name",render:(D,U,ee)=>U.type===0||U.type===2?e.jsx("div",{children:e.jsxs(z,{color:"grey",size:"large",onClick:()=>{V(D)},children:[" ",D," "]})}):e.jsx(e.Fragment,{})},{title:"类型",dataIndex:"type",render:(D,U,ee)=>e.jsx("div",{children:ms(D)})},{title:"模型",dataIndex:"model_name",render:(D,U,ee)=>U.type===0||U.type===2?e.jsx("div",{children:e.jsxs(z,{color:Fu(D),size:"large",onClick:()=>{V(D)},children:[" ",D," "]})}):e.jsx(e.Fragment,{})},{title:"用时",dataIndex:"use_time",render:(D,U,ee)=>e.jsx("div",{children:e.jsxs(de,{children:[xs(D),gs(U.is_stream)]})})},{title:"提示",dataIndex:"prompt_tokens",render:(D,U,ee)=>U.type===0||U.type===2?e.jsx("div",{children:e.jsxs("span",{children:[" ",D," "]})}):e.jsx(e.Fragment,{})},{title:"补全",dataIndex:"completion_tokens",render:(D,U,ee)=>parseInt(D)>0&&(U.type===0||U.type===2)?e.jsx("div",{children:e.jsxs("span",{children:[" ",D," "]})}):e.jsx(e.Fragment,{})},{title:"花费",dataIndex:"quota",render:(D,U,ee)=>U.type===0||U.type===2?e.jsx("div",{children:me(D,6)}):e.jsx(e.Fragment,{})},{title:"重试",dataIndex:"retry",className:ke()?"tableShow":"tableHiddle",render:(D,U,ee)=>{let ae="渠道："+U.channel;if(U.other!==""){let re=JSON.parse(U.other);if(re===null)return e.jsx(e.Fragment,{});re.admin_info!==void 0&&re.admin_info.use_channel!==null&&re.admin_info.use_channel!==void 0&&re.admin_info.use_channel!==""&&(ae=`渠道：${re.admin_info.use_channel.join("->")}`)}return v?e.jsx("div",{children:ae}):e.jsx(e.Fragment,{})}},{title:"详情",dataIndex:"content",render:(D,U,ee)=>{U.other===""&&(U.other="{}");let ae=JSON.parse(U.other);if(ae==null)return e.jsx(Wu,{ellipsis:{rows:2,showTooltip:{type:"popover",opts:{style:{width:240}}}},style:{maxWidth:240},children:D});let re=gn(U.prompt_tokens,U.completion_tokens,ae.model_ratio,ae.model_price,ae.completion_ratio,ae.group_ratio);return e.jsx(Pe,{content:re,children:e.jsx(Wu,{ellipsis:{rows:2},style:{maxWidth:240},children:D})})}}],[s,c]=t.useState([]),[a,l]=t.useState(!1),[r,F]=t.useState(!1),[y,w]=t.useState(!1),[h,o]=t.useState(1),[i,x]=t.useState(0),[k,$]=t.useState(pe);t.useState(""),t.useState(!1);const[_,L]=t.useState(0),v=ke();let H=new Date;const[Q,X]=t.useState({username:"",token_name:"",model_name:"",start_timestamp:Oe(H.getTime()/1e3-86400),end_timestamp:Oe(H.getTime()/1e3+3600),channel:""}),{username:K,token_name:Y,model_name:Z,start_timestamp:te,end_timestamp:G,channel:A}=Q,[f,P]=t.useState({quota:0,token:0}),B=(D,U)=>{X(ee=>({...ee,[U]:D}))},j=async()=>{let D=Date.parse(te)/1e3,U=Date.parse(G)/1e3,ee=await R.get(`/api/log/self/stat?type=${_}&token_name=${Y}&model_name=${Z}&start_timestamp=${D}&end_timestamp=${U}`);const{success:ae,message:re,data:oe}=ee.data;ae?P(oe):E(re)},b=async()=>{let D=Date.parse(te)/1e3,U=Date.parse(G)/1e3,ee=await R.get(`/api/log/stat?type=${_}&username=${K}&token_name=${Y}&model_name=${Z}&start_timestamp=${D}&end_timestamp=${U}&channel=${A}`);const{success:ae,message:re,data:oe}=ee.data;ae?P(oe):E(re)},n=async()=>{w(!0),v?await b():await j(),l(!0),w(!1)},d=async D=>{if(!v)return;const U=await R.get(`/api/user/${D}`),{success:ee,message:ae,data:re}=U.data;ee?je.info({title:"用户信息",content:e.jsxs("div",{style:{padding:12},children:[e.jsxs("p",{children:["用户名: ",re.username]}),e.jsxs("p",{children:["余额: ",me(re.quota)]}),e.jsxs("p",{children:["已用额度：",me(re.used_quota)]}),e.jsxs("p",{children:["请求次数：",Au(re.request_count)]})]}),centered:!0}):E(ae)},p=(D,U)=>{for(let ee=0;ee<D.length;ee++)D[ee].timestamp2string=Oe(D[ee].created_at),D[ee].key=""+D[ee].id;c(D),x(U)},S=async(D,U,ee=0)=>{F(!0);let ae="",re=Date.parse(te)/1e3,oe=Date.parse(G)/1e3;v?ae=`/api/log/?p=${D}&page_size=${U}&type=${ee}&username=${K}&token_name=${Y}&model_name=${Z}&start_timestamp=${re}&end_timestamp=${oe}&channel=${A}`:ae=`/api/log/self/?p=${D}&page_size=${U}&type=${ee}&token_name=${Y}&model_name=${Z}&start_timestamp=${re}&end_timestamp=${oe}`;const Be=await R.get(ae),{success:Te,message:Me,total:ze,data:Ye}=Be.data;if(Te)if(D===0)p(Ye,ze);else{let nu=[...s];nu.splice(D*U,Ye.length,...Ye),p(nu,ze)}else E(Me);F(!1)},g=s.slice((h-1)*k,h*k),C=D=>{o(D),D===Math.ceil(s.length/k)+1&&S(D-1,k,_).then(U=>{})},m=async D=>{localStorage.setItem("page-size",D+""),$(D),o(1),S(0,D).then().catch(U=>{E(U)})},M=async()=>{o(1),await S(0,k,_)},V=async D=>{await Le(D)?J("已复制："+D):je.error({title:"无法复制到剪贴板，请手动复制",content:D})};return t.useEffect(()=>{const D=parseInt(localStorage.getItem("page-size"))||pe;$(D),S(0,D).then().catch(U=>{E(U)})},[]),e.jsx(e.Fragment,{children:e.jsxs(le,{children:[e.jsx(ps,{children:e.jsx(De,{spinning:y,children:e.jsxs("h3",{children:["使用明细（总消耗额度：",e.jsx("span",{onClick:n,style:{cursor:"pointer",color:"gray"},children:a?me(f.quota):"点击查看"}),"）"]})})}),e.jsx(N,{layout:"horizontal",style:{marginTop:10},children:e.jsxs(e.Fragment,{children:[e.jsx(N.Input,{field:"token_name",label:"令牌名称",style:{width:176},value:Y,placeholder:"可选值",name:"token_name",onChange:D=>B(D,"token_name")}),e.jsx(N.Input,{field:"model_name",label:"模型名称",style:{width:176},value:Z,placeholder:"可选值",name:"model_name",onChange:D=>B(D,"model_name")}),e.jsx(N.DatePicker,{field:"start_timestamp",label:"起始时间",style:{width:272},initValue:te,value:te,type:"dateTime",name:"start_timestamp",onChange:D=>B(D,"start_timestamp")}),e.jsx(N.DatePicker,{field:"end_timestamp",fluid:!0,label:"结束时间",style:{width:272},initValue:G,value:G,type:"dateTime",name:"end_timestamp",onChange:D=>B(D,"end_timestamp")}),v&&e.jsxs(e.Fragment,{children:[e.jsx(N.Input,{field:"channel",label:"渠道 ID",style:{width:176},value:A,placeholder:"可选值",name:"channel",onChange:D=>B(D,"channel")}),e.jsx(N.Input,{field:"username",label:"用户名称",style:{width:176},value:K,placeholder:"可选值",name:"username",onChange:D=>B(D,"username")})]}),e.jsx(N.Section,{children:e.jsx(I,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",onClick:()=>{M().then()},loading:r,children:"查询"})})]})}),e.jsx(tu,{style:{marginTop:5},columns:u,dataSource:g,pagination:{currentPage:h,pageSize:k,total:i,pageSizeOpts:[10,20,50,100],showSizeChanger:!0,onPageSizeChange:D=>{m(D).then()},onPageChange:C}}),e.jsxs(Ie,{defaultValue:"0",style:{width:120},onChange:D=>{L(parseInt(D)),S(0,k,parseInt(D))},children:[e.jsx(Ie.Option,{value:"0",children:"全部"}),e.jsx(Ie.Option,{value:"1",children:"充值"}),e.jsx(Ie.Option,{value:"2",children:"消费"}),e.jsx(Ie.Option,{value:"3",children:"管理"}),e.jsx(Ie.Option,{value:"4",children:"系统"})]})]})})},Cs=()=>e.jsx(e.Fragment,{children:e.jsx(Es,{})}),fs=()=>{const u=localStorage.getItem("chat_link");return e.jsx("iframe",{src:u,style:{width:"100%",height:"85vh",border:"none"}})},Zu=["amber","blue","cyan","green","grey","indigo","light-blue","lime","orange","pink","purple","red","teal","violet","yellow"];function js(u){switch(u){case"IMAGINE":return e.jsx(z,{color:"blue",size:"large",children:"绘图"});case"UPSCALE":return e.jsx(z,{color:"orange",size:"large",children:"放大"});case"VARIATION":return e.jsx(z,{color:"purple",size:"large",children:"变换"});case"HIGH_VARIATION":return e.jsx(z,{color:"purple",size:"large",children:"强变换"});case"LOW_VARIATION":return e.jsx(z,{color:"purple",size:"large",children:"弱变换"});case"PAN":return e.jsx(z,{color:"cyan",size:"large",children:"平移"});case"DESCRIBE":return e.jsx(z,{color:"yellow",size:"large",children:"图生文"});case"BLEND":return e.jsx(z,{color:"lime",size:"large",children:"图混合"});case"SHORTEN":return e.jsx(z,{color:"pink",size:"large",children:"缩词"});case"REROLL":return e.jsx(z,{color:"indigo",size:"large",children:"重绘"});case"INPAINT":return e.jsx(z,{color:"violet",size:"large",children:"局部重绘-提交"});case"ZOOM":return e.jsx(z,{color:"teal",size:"large",children:"变焦"});case"CUSTOM_ZOOM":return e.jsx(z,{color:"teal",size:"large",children:"自定义变焦-提交"});case"MODAL":return e.jsx(z,{color:"green",size:"large",children:"窗口处理"});case"SWAP_FACE":return e.jsx(z,{color:"light-green",size:"large",children:"换脸"});default:return e.jsx(z,{color:"white",size:"large",children:"未知"})}}function ys(u){switch(u){case 1:return e.jsx(z,{color:"green",size:"large",children:"已提交"});case 21:return e.jsx(z,{color:"lime",size:"large",children:"等待中"});case 22:return e.jsx(z,{color:"orange",size:"large",children:"重复提交"});case 0:return e.jsx(z,{color:"yellow",size:"large",children:"未提交"});default:return e.jsx(z,{color:"white",size:"large",children:"未知"})}}function Ds(u){switch(u){case"SUCCESS":return e.jsx(z,{color:"green",size:"large",children:"成功"});case"NOT_START":return e.jsx(z,{color:"grey",size:"large",children:"未启动"});case"SUBMITTED":return e.jsx(z,{color:"yellow",size:"large",children:"队列中"});case"IN_PROGRESS":return e.jsx(z,{color:"blue",size:"large",children:"执行中"});case"FAILURE":return e.jsx(z,{color:"red",size:"large",children:"失败"});case"MODAL":return e.jsx(z,{color:"yellow",size:"large",children:"窗口等待"});default:return e.jsx(z,{color:"white",size:"large",children:"未知"})}}const Bs=u=>{const s=new Date(u*1e3),c=s.getFullYear(),a=("0"+(s.getMonth()+1)).slice(-2),l=("0"+s.getDate()).slice(-2),r=("0"+s.getHours()).slice(-2),F=("0"+s.getMinutes()).slice(-2),y=("0"+s.getSeconds()).slice(-2);return`${c}-${a}-${l} ${r}:${F}:${y}`};function As(u,s){if(!u||!s)return"N/A";const c=new Date(u),r=((new Date(s)-c)/1e3).toFixed(1),F=r>60?"red":"green";return e.jsxs(z,{color:F,size:"large",children:[r," 秒"]})}const bs=()=>{const[u,s]=t.useState(!1),[c,a]=t.useState(""),l=[{title:"提交时间",dataIndex:"submit_time",render:(g,C,m)=>e.jsx("div",{children:Bs(g/1e3)})},{title:"花费时间",dataIndex:"finish_time",key:"finish_time",render:(g,C)=>As(C.submit_time,g)},{title:"渠道",dataIndex:"channel_id",className:ke()?"tableShow":"tableHiddle",render:(g,C,m)=>e.jsx("div",{children:e.jsxs(z,{color:Zu[parseInt(g)%Zu.length],size:"large",onClick:()=>{S(g)},children:[" ",g," "]})})},{title:"类型",dataIndex:"action",render:(g,C,m)=>e.jsx("div",{children:js(g)})},{title:"任务ID",dataIndex:"mj_id",render:(g,C,m)=>e.jsx("div",{children:g})},{title:"提交结果",dataIndex:"code",className:ke()?"tableShow":"tableHiddle",render:(g,C,m)=>e.jsx("div",{children:ys(g)})},{title:"任务状态",dataIndex:"status",className:ke()?"tableShow":"tableHiddle",render:(g,C,m)=>e.jsx("div",{children:Ds(g)})},{title:"进度",dataIndex:"progress",render:(g,C,m)=>e.jsx("div",{children:e.jsx(Ot,{stroke:C.status==="FAILURE"?"var(--semi-color-warning)":null,percent:g?parseInt(g.replace("%","")):0,showInfo:!0,"aria-label":"drawing progress"})})},{title:"结果图片",dataIndex:"image_url",render:(g,C,m)=>g?e.jsx(I,{onClick:()=>{K(g),v(!0)},children:"查看图片"}):"无"},{title:"Prompt",dataIndex:"prompt",render:(g,C,m)=>g?e.jsx(ue.Text,{ellipsis:{showTooltip:!0},style:{width:100},onClick:()=>{a(g),s(!0)},children:g}):"无"},{title:"PromptEn",dataIndex:"prompt_en",render:(g,C,m)=>g?e.jsx(ue.Text,{ellipsis:{showTooltip:!0},style:{width:100},onClick:()=>{a(g),s(!0)},children:g}):"无"},{title:"失败原因",dataIndex:"fail_reason",render:(g,C,m)=>g?e.jsx(ue.Text,{ellipsis:{showTooltip:!0},style:{width:100},onClick:()=>{a(g),s(!0)},children:g}):"无"}],[r,F]=t.useState([]),[y,w]=t.useState(!0),[h,o]=t.useState(1),[i,x]=t.useState(pe),[k,$]=t.useState(0),_=ke(),[L,v]=t.useState(!1),[H,Q]=t.useState(!1),[X,K]=t.useState("");let Y=new Date;const[Z,te]=t.useState({channel_id:"",mj_id:"",start_timestamp:Oe(Y.getTime()/1e3-2592e3),end_timestamp:Oe(Y.getTime()/1e3+3600)}),{channel_id:G,mj_id:A,start_timestamp:f,end_timestamp:P}=Z;t.useState({quota:0,token:0});const B=(g,C)=>{te(m=>({...m,[C]:g}))},j=g=>{for(let C=0;C<g.length;C++)g[C].timestamp2string=Oe(g[C].created_at),g[C].key=""+g[C].id;F(g),x(g.length+pe)},b=async g=>{w(!0);let C="",m=Date.parse(f),M=Date.parse(P);_?C=`/api/mj/?p=${g}&channel_id=${G}&mj_id=${A}&start_timestamp=${m}&end_timestamp=${M}`:C=`/api/mj/self/?p=${g}&mj_id=${A}&start_timestamp=${m}&end_timestamp=${M}`;const V=await R.get(C),{success:D,message:U,data:ee}=V.data;if(D)if(g===0)j(ee);else{let ae=[...r];ae.splice(g*pe,ee.length,...ee),j(ae)}else E(U);w(!1)},n=r.slice((h-1)*pe,h*pe),d=g=>{o(g),g===Math.ceil(r.length/pe)+1&&b(g-1).then(C=>{})},p=async()=>{o(1),await b(0)},S=async g=>{await Le(g)?J("已复制："+g):je.error({title:"无法复制到剪贴板，请手动复制",content:g})};return t.useEffect(()=>{p().then()},[k]),t.useEffect(()=>{localStorage.getItem("mj_notify_enabled")!=="true"&&Q(!0)},[]),e.jsx(e.Fragment,{children:e.jsxs(le,{children:[_&&H?e.jsx(We,{type:"info",description:"当前未开启Midjourney回调，部分项目可能无法获得绘图结果，可在运营设置中开启。"}):e.jsx(e.Fragment,{}),e.jsx(N,{layout:"horizontal",style:{marginTop:10},children:e.jsxs(e.Fragment,{children:[e.jsx(N.Input,{field:"channel_id",label:"渠道 ID",style:{width:176},value:G,placeholder:"可选值",name:"channel_id",onChange:g=>B(g,"channel_id")}),e.jsx(N.Input,{field:"mj_id",label:"任务 ID",style:{width:176},value:A,placeholder:"可选值",name:"mj_id",onChange:g=>B(g,"mj_id")}),e.jsx(N.DatePicker,{field:"start_timestamp",label:"起始时间",style:{width:272},initValue:f,value:f,type:"dateTime",name:"start_timestamp",onChange:g=>B(g,"start_timestamp")}),e.jsx(N.DatePicker,{field:"end_timestamp",fluid:!0,label:"结束时间",style:{width:272},initValue:P,value:P,type:"dateTime",name:"end_timestamp",onChange:g=>B(g,"end_timestamp")}),e.jsx(N.Section,{children:e.jsx(I,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",onClick:p,children:"查询"})})]})}),e.jsx(tu,{style:{marginTop:5},columns:l,dataSource:n,pagination:{currentPage:h,pageSize:pe,total:i,pageSizeOpts:[10,20,50,100],onPageChange:d},loading:y}),e.jsx(je,{visible:u,onOk:()=>s(!1),onCancel:()=>s(!1),closable:null,bodyStyle:{height:"400px",overflow:"auto"},width:800,children:e.jsx("p",{style:{whiteSpace:"pre-line"},children:c})}),e.jsx(tt,{src:X,visible:L,onVisibleChange:g=>v(g)})]})})},Ss=()=>e.jsx(e.Fragment,{children:e.jsx(bs,{})});function ws(u){switch(u){case 1:return e.jsx(z,{color:"teal",size:"large",children:"按次计费"});case 0:return e.jsx(z,{color:"violet",size:"large",children:"按量计费"});default:return"未知"}}function vs(u){return u?e.jsx(du,{content:e.jsx("div",{style:{padding:8},children:"您的分组可以使用该模型"}),position:"top",style:{backgroundColor:"rgba(var(--semi-blue-4),1)",borderColor:"rgba(var(--semi-blue-4),1)",color:"var(--semi-color-white)",borderWidth:1,borderStyle:"solid"},children:e.jsx(zt,{style:{color:"green"},size:"large"})},u):e.jsx(du,{content:e.jsx("div",{style:{padding:8},children:"您的分组无权使用该模型"}),position:"top",style:{backgroundColor:"rgba(var(--semi-blue-4),1)",borderColor:"rgba(var(--semi-blue-4),1)",color:"var(--semi-color-white)",borderWidth:1,borderStyle:"solid"},children:e.jsx(Nt,{style:{color:"#FFA54F"},size:"large"})},u)}const ks=()=>{const[u,s]=t.useState([]),c=t.useRef({isComposition:!1}),[a,l]=t.useState([]),[r,F]=t.useState(""),[y,w]=t.useState(!1),h=t.useMemo(()=>({onChange:(A,f)=>{l(A)}}),[]),o=A=>{if(c.current.isComposition)return;s(A?[A]:[])},i=()=>{c.current.isComposition=!0},x=A=>{c.current.isComposition=!1;const f=A.target.value;s(f?[f]:[])},k=[{title:"可用性",dataIndex:"available",render:(A,f,P)=>vs(A),sorter:(A,f)=>A.available-f.available},{title:e.jsxs(de,{children:[e.jsx("span",{children:"模型名称"}),e.jsx(se,{placeholder:"模糊搜索",style:{width:200},onCompositionStart:i,onCompositionEnd:x,onChange:o,showClear:!0})]}),dataIndex:"model_name",render:(A,f,P)=>e.jsx(e.Fragment,{children:e.jsx(z,{color:"green",size:"large",onClick:()=>{G(A)},children:A})}),onFilter:(A,f)=>f.model_name.toLowerCase().includes(A.toLowerCase()),filteredValue:u},{title:"计费类型",dataIndex:"quota_type",render:(A,f,P)=>ws(parseInt(A)),sorter:(A,f)=>A.quota_type-f.quota_type},{title:()=>e.jsxs("span",{style:{display:"flex",alignItems:"center"},children:["倍率",e.jsx(du,{content:e.jsxs("div",{style:{padding:8},children:["倍率是为了方便换算不同价格的模型",e.jsx("br",{}),"点击查看倍率说明"]}),position:"top",style:{backgroundColor:"rgba(var(--semi-blue-4),1)",borderColor:"rgba(var(--semi-blue-4),1)",color:"var(--semi-color-white)",borderWidth:1,borderStyle:"solid"},children:e.jsx(nt,{onClick:()=>{F("/ratio.png"),w(!0)}})})]}),dataIndex:"model_ratio",render:(A,f,P)=>{let B=A,j=parseFloat(f.completion_ratio.toFixed(3));return B=e.jsxs(e.Fragment,{children:[e.jsxs(ru,{children:["模型：",f.quota_type===0?A:"无"]}),e.jsx("br",{}),e.jsxs(ru,{children:["补全：",f.quota_type===0?j:"无"]})]}),e.jsx("div",{children:B})}},{title:"模型价格",dataIndex:"model_price",render:(A,f,P)=>{let B=A;if(f.quota_type===0){let j=f.model_ratio*2*f.group_ratio,b=f.model_ratio*f.completion_ratio*2*f.group_ratio;B=e.jsxs(e.Fragment,{children:[e.jsxs(ru,{children:["提示 $",j," / 1M tokens"]}),e.jsx("br",{}),e.jsxs(ru,{children:["补全 $",b," / 1M tokens"]})]})}else{let j=parseFloat(A)*f.group_ratio;B=e.jsxs(e.Fragment,{children:["模型价格：$",j]})}return e.jsx("div",{children:B})}}],[$,_]=t.useState([]),[L,v]=t.useState(!0),[H,Q]=t.useContext(Ge),[X,K]=t.useState(1),Y=(A,f)=>{for(let P=0;P<A.length;P++)A[P].key=A[P].model_name,A[P].group_ratio=f;A.sort((P,B)=>P.quota_type-B.quota_type),A.sort((P,B)=>P.model_name.startsWith("gpt")&&!B.model_name.startsWith("gpt")?-1:!P.model_name.startsWith("gpt")&&B.model_name.startsWith("gpt")?1:P.model_name.localeCompare(B.model_name)),_(A)},Z=async()=>{v(!0);let A="";A="/api/pricing";const f=await R.get(A),{success:P,message:B,data:j,group_ratio:b}=f.data;P?(K(b),Y(j,b)):E(B),v(!1)},te=async()=>{await Z()},G=async A=>{await Le(A)?J("已复制："+A):je.error({title:"无法复制到剪贴板，请手动复制",content:A})};return t.useEffect(()=>{te().then()},[]),e.jsx(e.Fragment,{children:e.jsxs(le,{children:[H.user?e.jsx(We,{type:"success",fullMode:!1,closeIcon:"null",description:`您的分组为：${H.user.group}，分组倍率为：${X}`}):e.jsx(We,{type:"warning",fullMode:!1,closeIcon:"null",description:`您还未登陆，显示的价格为默认分组倍率: ${X}`}),e.jsx("br",{}),e.jsx(We,{type:"info",fullMode:!1,description:e.jsx("div",{children:"按量计费费用 = 分组倍率 × 模型倍率 × （提示token数 + 补全token数 × 补全倍率）/ 500000 （单位：美元）"}),closeIcon:"null"}),e.jsx("br",{}),e.jsx(I,{theme:"light",type:"tertiary",style:{width:150},onClick:()=>{G(a)},disabled:a=="",children:"复制选中模型"}),e.jsx(tu,{style:{marginTop:5},columns:k,dataSource:$,loading:L,pagination:{pageSize:$.length,showSizeChanger:!1},rowSelection:h}),e.jsx(tt,{src:r,visible:y,onVisibleChange:A=>w(A)})]})})},_s=()=>e.jsx(e.Fragment,{children:e.jsx(ks,{})}),Ts=t.lazy(()=>Uu(()=>import("./index-CtIFVH72.js"),__vite__mapDeps([0,1,2,3,4,5,6]))),Is=t.lazy(()=>Uu(()=>import("./index-BHj7AKHj.js"),__vite__mapDeps([7,1,8,2,3,4,5,6]))),Ps=t.lazy(()=>Uu(()=>import("./index-nf-_YZ2E.js"),__vite__mapDeps([9,1,4,2,3,5,6])));function Ms(){const[u,s]=t.useContext(Ge),c=()=>{let a=localStorage.getItem("user");if(a){let l=JSON.parse(a);s({type:"login",payload:l})}};return t.useEffect(()=>{c();let a=wu();a&&(document.title=a);let l=xu();if(l){let r=document.querySelector("link[rel~='icon']");r&&(r.href=l)}},[]),e.jsx(le,{children:e.jsx(le.Content,{children:e.jsxs(Tt,{children:[e.jsx(Fe,{path:"/",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Ts,{})})}),e.jsx(Fe,{path:"/channel",element:e.jsx(Ue,{children:e.jsx(ns,{})})}),e.jsx(Fe,{path:"/channel/edit/:id",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Lu,{})})}),e.jsx(Fe,{path:"/channel/add",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Lu,{})})}),e.jsx(Fe,{path:"/token",element:e.jsx(Ue,{children:e.jsx(is,{})})}),e.jsx(Fe,{path:"/redemption",element:e.jsx(Ue,{children:e.jsx(hs,{})})}),e.jsx(Fe,{path:"/user",element:e.jsx(Ue,{children:e.jsx(fn,{})})}),e.jsx(Fe,{path:"/user/edit/:id",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Ru,{})})}),e.jsx(Fe,{path:"/user/edit",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Ru,{})})}),e.jsx(Fe,{path:"/user/reset",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Yn,{})})}),e.jsx(Fe,{path:"/login",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(vn,{})})}),e.jsx(Fe,{path:"/register",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(jn,{})})}),e.jsx(Fe,{path:"/reset",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Vn,{})})}),e.jsx(Fe,{path:"/oauth/github",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Qn,{})})}),e.jsx(Fe,{path:"/oauth/linuxdo",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Jn,{})})}),e.jsx(Fe,{path:"/setting",element:e.jsx(Ue,{children:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Kn,{})})})}),e.jsx(Fe,{path:"/topup",element:e.jsx(Ue,{children:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Fs,{})})})}),e.jsx(Fe,{path:"/log",element:e.jsx(Ue,{children:e.jsx(Cs,{})})}),e.jsx(Fe,{path:"/detail",element:e.jsx(Ue,{children:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Is,{})})})}),e.jsx(Fe,{path:"/midjourney",element:e.jsx(Ue,{children:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Ss,{})})})}),e.jsx(Fe,{path:"/pricing",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(_s,{})})}),e.jsx(Fe,{path:"/about",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Ps,{})})}),e.jsx(Fe,{path:"/chat",element:e.jsx(t.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(fs,{})})}),e.jsx(Fe,{path:"*",element:e.jsx(kn,{})})]})})})}localStorage.getItem("chat_link");const $s=()=>{const[u,s]=t.useContext(Ge);let c=_e();const[a,l]=t.useState(!1);wu(),xu();const r=new Date,F=r.getMonth()===0&&r.getDate()===1||r.getMonth()===1&&r.getDate()>=9&&r.getDate()<=24;async function y(){l(!1),await R.get("/api/user/logout"),J("注销成功!"),s({type:"logout"}),localStorage.removeItem("user"),c("/login")}const w=()=>{ku.init("root",{}),ku.start(),setTimeout(()=>{ku.stop(),setTimeout(()=>{window.location.reload()},1e4)},3e3)},h=ft(),o=_n();return t.useEffect(()=>{h==="dark"&&document.body.setAttribute("theme-mode","dark"),F&&console.log("Happy New Year!")},[]),e.jsx(e.Fragment,{children:e.jsx(le,{children:e.jsx("div",{style:{width:"100%"},children:e.jsx(Ze,{mode:"horizontal",renderWrapper:({itemElement:i,isSubNav:x,isInSubNav:k,props:$})=>{const _={about:"/about",login:"/login",register:"/register"};return e.jsx(cu,{style:{textDecoration:"none"},to:_[$.itemKey],children:i})},selectedKeys:[],onSelect:i=>{},footer:e.jsxs(e.Fragment,{children:[F&&e.jsx(Ke,{position:"bottomRight",render:e.jsx(Ke.Menu,{children:e.jsx(Ke.Item,{onClick:w,children:"Happy New Year!!!"})}),children:e.jsx(Ze.Item,{itemKey:"new-year",text:"🏮"})}),e.jsx(Ze.Item,{itemKey:"about",icon:e.jsx(nt,{})}),e.jsx(Pu,{checkedText:"🌞",size:"large",checked:h==="dark",uncheckedText:"🌙",onChange:i=>{o(i)}}),u.user?e.jsx(e.Fragment,{children:e.jsxs(Ke,{position:"bottomRight",render:e.jsx(Ke.Menu,{children:e.jsx(Ke.Item,{onClick:y,children:"退出"})}),children:[e.jsx(zu,{size:"small",color:Fu(u.user.username),style:{margin:4},children:u.user.username[0]}),e.jsx("span",{children:u.user.username})]})}):e.jsxs(e.Fragment,{children:[e.jsx(Ze.Item,{itemKey:"login",text:"登录",icon:e.jsx(st,{})}),e.jsx(Ze.Item,{itemKey:"register",text:"注册",icon:e.jsx(at,{})})]})]})})})})})};var Rs={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const Ls=()=>{wu();const[u,s]=t.useState(hn());let c=5;const a=()=>{let r=localStorage.getItem("footer_html");r&&s(r)},l=e.jsxs("div",{className:"custom-footer",children:[e.jsxs("a",{href:"https://github.com/Calcium-Ion/new-api",target:"_blank",rel:"noreferrer",children:["New API ",Rs.VITE_REACT_APP_VERSION," "]}),"由"," ",e.jsx("a",{href:"https://github.com/Calcium-Ion",target:"_blank",rel:"noreferrer",children:"Calcium-Ion"})," ","开发，基于"," ",e.jsx("a",{href:"https://github.com/songquanpeng/one-api",target:"_blank",rel:"noreferrer",children:"One API"})]});return t.useEffect(()=>{const r=setInterval(()=>{if(c<=0){clearInterval(r);return}c--,a()},200);return()=>clearTimeout(r)},[]),e.jsx(le,{children:e.jsx(le.Content,{style:{textAlign:"center"},children:u?e.jsx(Pe,{content:l,children:e.jsx("div",{className:"custom-footer",dangerouslySetInnerHTML:{__html:u}})}):l})})},Os=(u,s)=>{switch(s.type){case"set":return{...u,status:s.payload};case"unset":return{...u,status:void 0};default:return u}},Dt={status:void 0},Bt=pu.createContext({state:Dt,dispatch:()=>null}),zs=({children:u})=>{const[s,c]=pu.useReducer(Os,Dt);return e.jsx(Bt.Provider,{value:[s,c],children:u})},Ns=()=>{t.useContext(Ge);const[u,s]=t.useContext(Bt),c=ve()||localStorage.getItem("default_collapse_sidebar")==="true";_e();const[a,l]=t.useState(["home"]),r=wu(),F=xu(),[y,w]=t.useState(c),h={home:"/",channel:"/channel",token:"/token",redemption:"/redemption",topup:"/topup",user:"/user",log:"/log",midjourney:"/midjourney",setting:"/setting",about:"/about",chat:"/chat",detail:"/detail",pricing:"/pricing"},o=t.useMemo(()=>[{text:"首页",itemKey:"home",to:"/",icon:e.jsx(Ut,{})},{text:"渠道",itemKey:"channel",to:"/channel",icon:e.jsx(Wt,{}),className:ke()?"semi-navigation-item-normal":"tableHiddle"},{text:"聊天",itemKey:"chat",to:"/chat",icon:e.jsx(Gt,{}),className:localStorage.getItem("chat_link")?"semi-navigation-item-normal":"tableHiddle"},{text:"令牌",itemKey:"token",to:"/token",icon:e.jsx(st,{})},{text:"兑换码",itemKey:"redemption",to:"/redemption",icon:e.jsx(Ht,{}),className:ke()?"semi-navigation-item-normal":"tableHiddle"},{text:"钱包",itemKey:"topup",to:"/topup",icon:e.jsx(qt,{})},{text:"模型价格",itemKey:"pricing",to:"/pricing",icon:e.jsx(Kt,{})},{text:"用户管理",itemKey:"user",to:"/user",icon:e.jsx(at,{}),className:ke()?"semi-navigation-item-normal":"tableHiddle"},{text:"日志",itemKey:"log",to:"/log",icon:e.jsx(Vt,{})},{text:"数据看板",itemKey:"detail",to:"/detail",icon:e.jsx(Qt,{}),className:localStorage.getItem("enable_data_export")==="true"?"semi-navigation-item-normal":"tableHiddle"},{text:"绘图",itemKey:"midjourney",to:"/midjourney",icon:e.jsx(Jt,{}),className:localStorage.getItem("enable_drawing")==="true"?"semi-navigation-item-normal":"tableHiddle"},{text:"设置",itemKey:"setting",to:"/setting",icon:e.jsx(Yt,{})}],[localStorage.getItem("enable_data_export"),localStorage.getItem("enable_drawing"),localStorage.getItem("chat_link"),ke()]),i=async()=>{const x=await R.get("/api/status");if(x===void 0)return;const{success:k,data:$}=x.data;k?(s({type:"set",payload:$}),Sn($)):E("无法正常连接至服务器！")};return t.useEffect(()=>{i().then(()=>{w(ve()||localStorage.getItem("default_collapse_sidebar")==="true")});let x=window.location.pathname.split("/")[1];x===""&&(x="home"),l([x])},[]),e.jsx(e.Fragment,{children:e.jsx(le,{children:e.jsx("div",{style:{height:"100%"},children:e.jsx(Ze,{style:{maxWidth:200},defaultIsCollapsed:ve()||localStorage.getItem("default_collapse_sidebar")==="true",isCollapsed:y,onCollapseChange:x=>{w(x)},selectedKeys:a,renderWrapper:({itemElement:x,isSubNav:k,isInSubNav:$,props:_})=>e.jsx(cu,{style:{textDecoration:"none"},to:h[_.itemKey],children:x}),items:o,onSelect:x=>{l([x.itemKey])},header:{logo:e.jsx("img",{src:F,alt:"logo",style:{marginRight:"0.75em"}}),text:r},children:e.jsx(Ze.Footer,{collapseButton:!0})})})})})},Us=$u.createRoot(document.getElementById("root")),{Sider:Ws,Content:Gs,Header:Hs}=le;Us.render(e.jsx(pu.StrictMode,{children:e.jsx(zs,{children:e.jsx(Dn,{children:e.jsx(It,{children:e.jsx(Tn,{children:e.jsxs(le,{children:[e.jsx(Ws,{children:e.jsx(Ns,{})}),e.jsxs(le,{children:[e.jsx(Hs,{children:e.jsx($s,{})}),e.jsx(Gs,{style:{padding:"24px"},children:e.jsx(Ms,{})}),e.jsx(le.Footer,{children:e.jsx(Ls,{})})]}),e.jsx(en,{})]})})})})})}));export{R as A,Bt as S,E as a,Au as b,Ys as c,me as d,Zs as g,ke as i,e as j,ea as m,Xs as r,qu as s,Oe as t};
